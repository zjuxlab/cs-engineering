"use strict";(self.webpackChunkcs_engineering=self.webpackChunkcs_engineering||[]).push([[9253],{3484:(e,n,a)=>{a.d(n,{A:()=>r});const r=a.p+"assets/images/Zje0btaLRoWS1Ix8UN2cgWqInxb-4b8d2be6d9d25648a0ce97c364e0c4a2.png"},4821:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>u,contentTitle:()=>s,default:()=>m,frontMatter:()=>t,metadata:()=>g,toc:()=>i});var r=a(58168),l=(a(96540),a(15680));const t={title:"ORM gorm",slug:"ORM gorm",sidebar_position:1},s="ORM gorm",g={unversionedId:"\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORMgorm",id:"\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORMgorm",title:"ORM gorm",description:"Author:\u9a6c\u5bff\u7965",source:"@site/docs/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORMgorm.md",sourceDirName:"\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm",slug:"/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORM gorm",permalink:"/cs-engineering/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORM gorm",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/ORMgorm/ORMgorm.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"ORM gorm",slug:"ORM gorm",sidebar_position:1},sidebar:"sidebar",previous:{title:"\u65e5\u5fd7\u5de5\u5177 logrus",permalink:"/cs-engineering/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/\u65e5\u5fd7\u5de5\u5177logrus/\u65e5\u5fd7\u5de5\u5177 logrus"},next:{title:"\u547d\u4ee4\u884c\u5de5\u5177 cobra",permalink:"/cs-engineering/\u8f6f\u4ef6\u5de5\u7a0b\u6280\u80fd\u6811/\u540e\u7aef\u6280\u672f/\u5f00\u53d1\u8bed\u8a00/Golang/\u5de5\u5177\u5e93/\u547d\u4ee4\u884c\u5de5\u5177cobra/\u547d\u4ee4\u884c\u5de5\u5177 cobra"}},u={},i=[{value:"\u7b80\u4ecb",id:"\u7b80\u4ecb",level:2},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9",level:5},{value:"\u5feb\u901f\u5165\u95e8",id:"\u5feb\u901f\u5165\u95e8",level:2},{value:"\u8fde\u63a5",id:"\u8fde\u63a5",level:2},{value:"MySQL",id:"mysql",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-1",level:5},{value:"PostgreSQL",id:"postgresql",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-2",level:5},{value:"\u8fde\u63a5\u6c60",id:"\u8fde\u63a5\u6c60",level:3},{value:"\u6a21\u578b\u5b9a\u4e49&amp;\u7ea6\u5b9a",id:"\u6a21\u578b\u5b9a\u4e49\u7ea6\u5b9a",level:2},{value:"\u6a21\u578b\u5b9a\u4e49",id:"\u6a21\u578b\u5b9a\u4e49",level:3},{value:"gorm.Model",id:"gormmodel",level:4},{value:"\u5b57\u6bb5\u6807\u7b7e",id:"\u5b57\u6bb5\u6807\u7b7e",level:4},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-3",level:5},{value:"\u7ea6\u5b9a",id:"\u7ea6\u5b9a",level:3},{value:"\u4f7f\u7528 <code>ID</code> \u4f5c\u4e3a\u4e3b\u952e",id:"\u4f7f\u7528-id-\u4f5c\u4e3a\u4e3b\u952e",level:4},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-4",level:5},{value:"\u4f7f\u7528\u7ed3\u6784\u4f53\u540d\u79f0\u7684<code>\u86c7\u5f62\u547d\u540d\u7684\u590d\u6570\u5f62\u5f0f</code>\u4f5c\u4e3a\u8868\u540d",id:"\u4f7f\u7528\u7ed3\u6784\u4f53\u540d\u79f0\u7684\u86c7\u5f62\u547d\u540d\u7684\u590d\u6570\u5f62\u5f0f\u4f5c\u4e3a\u8868\u540d",level:4},{value:"\u4f7f\u7528\u5b57\u6bb5\u540d\u7684 <code>\u86c7\u5f62\u547d\u540d</code> \u4f5c\u4e3a\u5217\u540d",id:"\u4f7f\u7528\u5b57\u6bb5\u540d\u7684-\u86c7\u5f62\u547d\u540d-\u4f5c\u4e3a\u5217\u540d",level:4},{value:"\u4f7f\u7528 <code>CreatedAt</code>\u3001<code>UpdatedAt</code> \u5b57\u6bb5\u8ffd\u8e2a\u521b\u5efa\u3001\u66f4\u65b0\u65f6\u95f4",id:"\u4f7f\u7528-createdatupdatedat-\u5b57\u6bb5\u8ffd\u8e2a\u521b\u5efa\u66f4\u65b0\u65f6\u95f4",level:4},{value:"CUDA\u63a5\u53e3",id:"cuda\u63a5\u53e3",level:2},{value:"\u521b\u5efa",id:"\u521b\u5efa",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-5",level:5},{value:"\u67e5\u8be2",id:"\u67e5\u8be2",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-6",level:5},{value:"\u9ad8\u7ea7\u67e5\u8be2",id:"\u9ad8\u7ea7\u67e5\u8be2",level:3},{value:"\u66f4\u65b0",id:"\u66f4\u65b0",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-7",level:5},{value:"\u5220\u9664",id:"\u5220\u9664",level:3},{value:"<code>\u6269\u5c55\u5185\u5bb9\uff1a</code>",id:"\u6269\u5c55\u5185\u5bb9-8",level:5},{value:"SQL\u6784\u5efa\u5668\uff08<code>\u6269\u5c55\u5185\u5bb9</code>\uff09",id:"sql\u6784\u5efa\u5668\u6269\u5c55\u5185\u5bb9",level:3},{value:"\u94fe\u5f0f\u8c03\u7528",id:"\u94fe\u5f0f\u8c03\u7528",level:2},{value:"\u4e8b\u52a1",id:"\u4e8b\u52a1",level:2},{value:"\u7981\u7528\u9ed8\u8ba4\u4e8b\u52a1",id:"\u7981\u7528\u9ed8\u8ba4\u4e8b\u52a1",level:3},{value:"\u4e8b\u52a1",id:"\u4e8b\u52a1-1",level:3},{value:"\u5d4c\u5957\u4e8b\u52a1",id:"\u5d4c\u5957\u4e8b\u52a1",level:3},{value:"\u624b\u52a8\u4e8b\u52a1",id:"\u624b\u52a8\u4e8b\u52a1",level:3},{value:"SavePoint\u3001RollbackTo",id:"savepointrollbackto",level:3}],o={toc:i},d="wrapper";function m(e){let{components:n,...t}=e;return(0,l.yg)(d,(0,r.A)({},o,t,{components:n,mdxType:"MDXLayout"}),(0,l.yg)("h1",{id:"orm-gorm"},"ORM gorm"),(0,l.yg)("p",null,"Author:\u9a6c\u5bff\u7965"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u9605\u8bfb\u6307\u5357\uff0c\u5bf9\u4e8e",(0,l.yg)("code",null,"\u6269\u5c55\u5185\u5bb9"),"\uff0c\u521d\u6b21\u9605\u8bfb\u65f6\u60a8\u53ef\u4ee5\u8df3\u8fc7\u3002\u672c\u7bc7\u6559\u7a0b\u53ea\u662f\u4e00\u4e2a\u5165\u95e8\u6587\u6863\uff0c\u9ad8\u7ea7\u7528\u6cd5\u5efa\u8bae\u76f4\u63a5\u770b\u5b98\u65b9\u6587\u6863\u3002")),(0,l.yg)("h1",{id:"\u524d\u7f6e\u77e5\u8bc6"},"\u524d\u7f6e\u77e5\u8bc6"),(0,l.yg)("p",null,"\u9762\u5411\u5bf9\u8c61\u7a0b\u5e8f\u8bbe\u8ba1(OOP)"),(0,l.yg)("p",null,"SQL"),(0,l.yg)("p",null,"\u6570\u636e\u5e93\u57fa\u672c\u64cd\u4f5c"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u9700\u8981\u4e86\u89e3\u8fd9\u4e9b\u662f\u4ec0\u4e48\uff0c\u4ee5\u53ca\uff0c\u8bfb\u61c2\u7b80\u5355\u7684SQL\u8bed\u53e5\uff0c\u793a\u4f8b\u4ee3\u7801\u63d0\u4f9b\u4e86\u7b49\u4ef7SQL")),(0,l.yg)("h1",{id:"\u4ec0\u4e48\u662form"},"\u4ec0\u4e48\u662fORM"),(0,l.yg)("p",null,"\u5bf9\u8c61\u5173\u7cfb\u6620\u5c04\uff08\u82f1\u8bed\uff1aObject Relational Mapping\uff0c\u7b80\u79f0ORM\uff0c\u6216O/RM\uff0c\u6216O/R mapping\uff09\uff0c\u662f\u4e00\u79cd\u7a0b\u5e8f\u8bbe\u8ba1\u6280\u672f\uff0c\u7528\u4e8e\u5b9e\u73b0\u9762\u5411\u5bf9\u8c61\u7f16\u7a0b\u8bed\u8a00\u91cc\u4e0d\u540c\u7c7b\u578b\u7cfb\u7edf\u7684\u6570\u636e\u4e4b\u95f4\u7684\u8f6c\u6362\u3002\u4ece\u6548\u679c\u4e0a\u8bf4\uff0c\u5b83\u5176\u5b9e\u662f\u521b\u5efa\u4e86\u4e00\u4e2a\u53ef\u5728\u7f16\u7a0b\u8bed\u8a00\u91cc\u4f7f\u7528\u7684\u201c\u865a\u62df\u5bf9\u8c61\u6570\u636e\u5e93\u201d\u3002"),(0,l.yg)("blockquote",null,(0,l.yg)("p",{parentName:"blockquote"},"ORM\u5373\u5bf9\u8c61\u5173\u7cfb\u6620\u5c04\uff08Object Relational Mapping\uff09\n\u76f4\u767d\u6765\u8bf4\uff0c\u5c31\u662f\u5c06\u6570\u636e\u5e93\u91cc\u7684\u8868\u548c\u5bf9\u8868\u7684\u5404\u79cd\u67e5\u8be2\u64cd\u4f5c\uff0c\u6620\u5c04\u4e3a\u5bf9\u8c61\u548c\u65b9\u6cd5\u3002\n\u8fd9\u6837\u4e00\u65b9\u9762\u6781\u5927\u7a0b\u5ea6\u907f\u514d\u4e86\u6211\u4eec\u76f4\u63a5\u5728\u4ee3\u7801\u91cc\u5199sql\uff0c\u4ec5\u7528\u7ef4\u62a4\u76f8\u5e94\u7684\u5bf9\u8c61\uff0c\u76f8\u5bf9\u51cf\u5c11\u4e86\u6210\u672c\u3002\n\u53e6\u4e00\u65b9\u9762\uff0c\u4ee5\u5bf9\u8c61\u5448\u73b0\u6570\u636e\u7ed3\u6784\u800c\u4e0d\u662f\u5199\u5728\u786c\u7f16\u7801\u91cc\uff0c\u4e5f\u4f7f\u5f97\u4ee3\u7801\u53ef\u8bfb\u6027\u5927\u5927\u63d0\u9ad8\u3002\n\u9664\u6b64\u4e4b\u5916\uff0corm\u907f\u514d\u4e86\u76f4\u63a5\u7684\u5b57\u7b26\u4e32\u62fc\u63a5\uff0c\u4ece\u800c\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u9632\u6b62\u4e86sql\u6ce8\u5165\u3002\n\u6bd4\u5982",(0,l.yg)("inlineCode",{parentName:"p"},'where name = "qwq" or "1"="1"'),"\u8fd9\u79cd\u6ce8\u5165\uff0c\u7528orm\u7684\u8bdd\u5c31\u4f1a\u88ab\u7f16\u8bd1\u6210",(0,l.yg)("inlineCode",{parentName:"p"},'where name = \'qwq" or "1"="1\''),"\u3002\n\u4e0d\u8fc7\u65e2\u7136orm\u8981\u591a\u4e00\u4e9b\u7f16\u8bd1\u3001\u4f18\u5316\u8fc7\u7a0b\uff0c\u5f53\u7136\u4e00\u5b9a\u7a0b\u5ea6\u964d\u4f4e\u4e86\u7a0b\u5e8f\u7684\u6027\u80fd\u3002\ngo\u7684orm\u4e00\u822c\u4f7f\u7528",(0,l.yg)("inlineCode",{parentName:"p"},"gorm"),"\uff0cpython\u4e2d\u53ef\u4ee5\u8003\u8651",(0,l.yg)("inlineCode",{parentName:"p"},"sqlalchemy"),"\uff0cc#\u7684",(0,l.yg)("inlineCode",{parentName:"p"},"sqlsugar"),"\u636e\u8bf4\u4e5f\u86ee\u597d\u7528\u7684\u3002")),(0,l.yg)("h1",{id:"gorm"},"GORM"),(0,l.yg)("h2",{id:"\u7b80\u4ecb"},"\u7b80\u4ecb"),(0,l.yg)("p",null,"gorm\u662f\u9762\u5411golang\u8bed\u8a00\u7684\u4e00\u79cdORM(\u6301\u4e45\u5c42)\u6846\u67b6\uff0c\u652f\u6301\u591a\u79cd\u6570\u636e\u5e93\u7684\u63a5\u5165\uff0c\u4f8b\u5982MySQL\uff0cPostgreSQL\uff0cSQLite\uff0cSQL Server\uff0cClickhouse\uff08\u4e00\u4e2a\u5217\u793a\u6570\u636e\u5e93\uff09\u3002 "),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u672c\u6587\u8f83\u4e3a\u7b80\u7565\uff0c\u8be6\u7ec6\u53ef\u4ee5\u53c2\u770b\u5b98\u65b9\u4e2d\u6587\u6587\u6863")),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u5173\u4e8e\u884c\u5f0f\u6570\u636e\u5e93\u548c\u5217\u5f0f\u6570\u636e\u5e93\uff0c\u53ef\u4ee5\u770b\u4e0b\u9762\u4e24\u5f20\u56fe\u3002\u5728\u67d0\u4e9b\u7279\u5b9a\u573a\u666f\u4e0b\uff0c\u5217\u5f0f\u6570\u636e\u5e93\u53ef\u80fd\u5e26\u6765\u8fd1\u767e\u500d\u7684\u6027\u80fd\u63d0\u5347\u3002")),(0,l.yg)("div",{class:"flex gap-3 columns-2","column-size":"2"},(0,l.yg)("div",{class:"w-[50%]","width-ratio":"50"},"![](/assets/G7iib0rl4ojUw1xAKKRcCOVjnKd.gif)"),(0,l.yg)("div",{class:"w-[50%]","width-ratio":"50"},"![](/assets/UzEUb5OwYov8lcxKiHOcQmN6nfb.gif)")),(0,l.yg)("h2",{id:"\u5feb\u901f\u5165\u95e8"},"\u5feb\u901f\u5165\u95e8"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n  "gorm.io/gorm"\n  "gorm.io/driver/sqlite"\n)\n\ntype Product struct {\n  gorm.Model\n  Code  string\n  Price uint\n}\n\nfunc main() {\n  db, err := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})\n  if err != nil {\n    panic("failed to connect database")\n  }\n\n  // \u8fc1\u79fb schema\n  db.AutoMigrate(&Product{})\n\n  // Create\n  db.Create(&Product{Code: "D42", Price: 100})\n\n  // Read\n  var product Product\n  db.First(&product, 1) // \u6839\u636e\u6574\u578b\u4e3b\u952e\u67e5\u627e\n  db.First(&product, "code = ?", "D42") // \u67e5\u627e code \u5b57\u6bb5\u503c\u4e3a D42 \u7684\u8bb0\u5f55\n\n  // Update - \u5c06 product \u7684 price \u66f4\u65b0\u4e3a 200\n  db.Model(&product).Update("Price", 200)\n  // Update - \u66f4\u65b0\u591a\u4e2a\u5b57\u6bb5\n  db.Model(&product).Updates(Product{Price: 200, Code: "F42"}) // \u4ec5\u66f4\u65b0\u975e\u96f6\u503c\u5b57\u6bb5\n  db.Model(&product).Updates(map[string]interface{}{"Price": 200, "Code": "F42"})\n\n  // Delete - \u5220\u9664 product\n  db.Delete(&product, 1)\n}\n')),(0,l.yg)("h2",{id:"\u8fde\u63a5"},"\u8fde\u63a5"),(0,l.yg)("h3",{id:"mysql"},"MySQL"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'import (\n  "gorm.io/driver/mysql"\n  "gorm.io/gorm"\n)\n\nfunc main() {\n  // \u53c2\u8003 https://github.com/go-sql-driver/mysql#dsn-data-source-name \u83b7\u53d6\u8be6\u60c5\n  dsn := "user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local"\n  db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})\n}\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-1"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null,"MySQL \u9a71\u52a8\u7a0b\u5e8f\u63d0\u4f9b\u4e86 ",(0,l.yg)("a",{parentName:"p",href:"https://github.com/go-gorm/mysql"},"\u4e00\u4e9b\u9ad8\u7ea7\u914d\u7f6e")," \u53ef\u4ee5\u5728\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d\u4f7f\u7528\uff0c\u4f8b\u5982\uff1a "),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db, err := gorm.Open(mysql.New(mysql.Config{\n  DSN: "gorm:gorm@tcp(127.0.0.1:3306)/gorm?charset=utf8&parseTime=True&loc=Local", // DSN data source name\n  DefaultStringSize: 256, // string \u7c7b\u578b\u5b57\u6bb5\u7684\u9ed8\u8ba4\u957f\u5ea6\n  DisableDatetimePrecision: true, // \u7981\u7528 datetime \u7cbe\u5ea6\uff0cMySQL 5.6 \u4e4b\u524d\u7684\u6570\u636e\u5e93\u4e0d\u652f\u6301\n  DontSupportRenameIndex: true, // \u91cd\u547d\u540d\u7d22\u5f15\u65f6\u91c7\u7528\u5220\u9664\u5e76\u65b0\u5efa\u7684\u65b9\u5f0f\uff0cMySQL 5.7 \u4e4b\u524d\u7684\u6570\u636e\u5e93\u548c MariaDB \u4e0d\u652f\u6301\u91cd\u547d\u540d\u7d22\u5f15\n  DontSupportRenameColumn: true, // \u7528 `change` \u91cd\u547d\u540d\u5217\uff0cMySQL 8 \u4e4b\u524d\u7684\u6570\u636e\u5e93\u548c MariaDB \u4e0d\u652f\u6301\u91cd\u547d\u540d\u5217\n  SkipInitializeWithVersion: false, // \u6839\u636e\u5f53\u524d MySQL \u7248\u672c\u81ea\u52a8\u914d\u7f6e\n}), &gorm.Config{})\n')),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,(0,l.yg)("code",null,"charset=utf8mb4")," \u6709\u4ec0\u4e48\u7528\u5462\uff0c\u5efa\u8bae\u81ea\u884c\u4e86\u89e3Mysql\u4e0eutf-8\u7684\u524d\u4e16\u4eca\u751f\uff08")),(0,l.yg)("p",null,"\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u73b0\u6709\u8fde\u63a5\u6765\u521d\u59cb\u5316",(0,l.yg)("inlineCode",{parentName:"p"},"*gorm.DB"),"\uff0c\u8fd9\u6837\u5c31\u4e0d\u9700\u8981dsn\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'import (\n  "database/sql"\n  "gorm.io/driver/mysql"\n  "gorm.io/gorm"\n)\n\nsqlDB, err := sql.Open("mysql", "mydb_dsn")\ngormDB, err := gorm.Open(mysql.New(mysql.Config{\n  Conn: sqlDB,\n}), &gorm.Config{})\n')),(0,l.yg)("h3",{id:"postgresql"},"PostgreSQL"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'import (\n  "gorm.io/driver/postgres"\n  "gorm.io/gorm"\n)\n\ndsn := "host=localhost user=gorm password=gorm dbname=gorm port=9920 sslmode=disable TimeZone=Asia/Shanghai"\ndb, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-2"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null,"\u540c\u6837\u53ef\u4ee5\u7528\u73b0\u6709\u8fde\u63a5\u521d\u59cb\u5316"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'import (\n  "database/sql"\n  "gorm.io/driver/postgres"\n  "gorm.io/gorm"\n)\n\nsqlDB, err := sql.Open("pgx", "mydb_dsn")\ngormDB, err := gorm.Open(postgres.New(postgres.Config{\n  Conn: sqlDB,\n}), &gorm.Config{})\n')),(0,l.yg)("p",null,"\u5176\u5b83\u51e0\u79cd\u6570\u636e\u5e93\u7684\u8fde\u63a5\u540c\u7406\uff0c\u5efa\u8bae\u76f4\u63a5\u770b\u6587\u6863\u3002"),(0,l.yg)("hr",null),(0,l.yg)("h3",{id:"\u8fde\u63a5\u6c60"},"\u8fde\u63a5\u6c60"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u7ec6\u5fc3\u7684\u540c\u5b66\u5e94\u8be5\u5df2\u7ecf\u53d1\u73b0\uff0c\u901a\u8fc7\u73b0\u6709\u8fde\u63a5\u521d\u59cb\u5316\u65f6\uff0c\u6211\u4eec\u4f7f\u7528\u4e86",(0,l.yg)("code",null,"sql.Open(driverName, dataSourceName string)"),",\u90a3\u4e48\u5b83\u662f\u4ece\u54ea\u91cc\u53d6\u51fa\u6765\u7684\u5462\uff0c\u5176\u5b9e\u662f\u8fde\u63a5\u6c60\u3002\u5173\u4e8e\u4ec0\u4e48\u662f\u8fde\u63a5\u6c60\uff0c\u6709\u5174\u8da3\u53ef\u4ee5\u81ea\u884c\u4e86\u89e3\u3002")),(0,l.yg)("p",null," GORM \u4f7f\u7528 ",(0,l.yg)("a",{parentName:"p",href:"https://pkg.go.dev/database/sql"},"database/sql")," \u7ef4\u62a4\u8fde\u63a5\u6c60\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"sqlDB, err := db.DB()\n\n// SetMaxIdleConns \u8bbe\u7f6e\u7a7a\u95f2\u8fde\u63a5\u6c60\u4e2d\u8fde\u63a5\u7684\u6700\u5927\u6570\u91cf\nsqlDB.SetMaxIdleConns(10)\n\n// SetMaxOpenConns \u8bbe\u7f6e\u6253\u5f00\u6570\u636e\u5e93\u8fde\u63a5\u7684\u6700\u5927\u6570\u91cf\u3002\nsqlDB.SetMaxOpenConns(100)\n\n// SetConnMaxLifetime \u8bbe\u7f6e\u4e86\u8fde\u63a5\u53ef\u590d\u7528\u7684\u6700\u5927\u65f6\u95f4\u3002\nsqlDB.SetConnMaxLifetime(time.Hour)\n")),(0,l.yg)("h2",{id:"\u6a21\u578b\u5b9a\u4e49\u7ea6\u5b9a"},"\u6a21\u578b\u5b9a\u4e49&\u7ea6\u5b9a"),(0,l.yg)("h3",{id:"\u6a21\u578b\u5b9a\u4e49"},"\u6a21\u578b\u5b9a\u4e49"),(0,l.yg)("p",null,"\u6a21\u578b\u662f\u6807\u51c6\u7684 struct\uff0c\u7531 Go \u7684\u57fa\u672c\u6570\u636e\u7c7b\u578b\u3001\u5b9e\u73b0\u4e86 ",(0,l.yg)("a",{parentName:"p",href:"https://pkg.go.dev/database/sql/?tab=doc#Scanner"},"Scanner")," \u548c ",(0,l.yg)("a",{parentName:"p",href:"https://pkg.go.dev/database/sql/driver#Valuer"},"Valuer")," \u63a5\u53e3\u7684\u81ea\u5b9a\u4e49\u7c7b\u578b\u53ca\u5176\u6307\u9488\u6216\u522b\u540d\u7ec4\u6210\u3002\u4f8b\u5982\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"type User struct {\n  ID           uint\n  Name         string\n  Email        *string\n  Age          uint8\n  Birthday     *time.Time\n  MemberNumber sql.NullString\n  ActivedAt    sql.NullTime\n  CreatedAt    time.Time\n  UpdatedAt    time.Time\n}\n")),(0,l.yg)("h4",{id:"gormmodel"},"gorm.Model"),(0,l.yg)("p",null," GORM \u5b9a\u4e49\u4e00\u4e2a ",(0,l.yg)("inlineCode",{parentName:"p"},"gorm.Model")," \u7ed3\u6784\u4f53\uff0c\u5176\u5305\u62ec\u5b57\u6bb5 ",(0,l.yg)("inlineCode",{parentName:"p"},"ID"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"CreatedAt"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"UpdatedAt"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"DeletedAt")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// gorm.Model \u7684\u5b9a\u4e49\ntype Model struct {\n  ID        uint           `gorm:"primaryKey"`\n  CreatedAt time.Time\n  UpdatedAt time.Time\n  DeletedAt gorm.DeletedAt `gorm:"index"`\n}\n')),(0,l.yg)("p",null,"\u53ef\u4ee5\u5c06\u5176\u5d4c\u5165\u7ed3\u6784\u4f53\uff0c\u6765\u5305\u542b\u8fd9\u4e9b\u5b57\u6bb5\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  gorm.Model\n  Name string\n}\n// \u7b49\u6548\u4e8e\ntype User struct {\n  ID        uint           `gorm:"primaryKey"`\n  CreatedAt time.Time\n  UpdatedAt time.Time\n  DeletedAt gorm.DeletedAt `gorm:"index"`\n  Name string\n}\n')),(0,l.yg)("h4",{id:"\u5b57\u6bb5\u6807\u7b7e"},"\u5b57\u6bb5\u6807\u7b7e"),(0,l.yg)("p",null,"\u53ef\u4ee5\u63a7\u5236\u8bfb\u5199\u6743\u9650\u7b49\uff0c\u4f8b\u5982\uff0c"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  Name string `gorm:"<-:create"` // \u5141\u8bb8\u8bfb\u548c\u521b\u5efa\n  Name string `gorm:"<-:update"` // \u5141\u8bb8\u8bfb\u548c\u66f4\u65b0\n  Name string `gorm:"<-"`        // \u5141\u8bb8\u8bfb\u548c\u5199\uff08\u521b\u5efa\u548c\u66f4\u65b0\uff09\n  Name string `gorm:"<-:false"`  // \u5141\u8bb8\u8bfb\uff0c\u7981\u6b62\u5199\n  Name string `gorm:"->"`        // \u53ea\u8bfb\uff08\u9664\u975e\u6709\u81ea\u5b9a\u4e49\u914d\u7f6e\uff0c\u5426\u5219\u7981\u6b62\u5199\uff09\n  Name string `gorm:"->;<-:create"` // \u5141\u8bb8\u8bfb\u548c\u5199\n  Name string `gorm:"->:false;<-:create"` // \u4ec5\u521b\u5efa\uff08\u7981\u6b62\u4ece db \u8bfb\uff09\n  Name string `gorm:"-"`  // \u8bfb\u5199\u64cd\u4f5c\u5747\u4f1a\u5ffd\u7565\u8be5\u5b57\u6bb5\n}\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-3"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null," \u58f0\u660e model \u65f6\uff0ctag \u662f\u53ef\u9009\u7684\uff0cGORM \u652f\u6301\u4ee5\u4e0b tag\uff1a tag \u540d\u5927\u5c0f\u5199\u4e0d\u654f\u611f\uff0c\u4f46\u5efa\u8bae\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"p"},"camelCase")," \u98ce\u683c "),(0,l.yg)("h3",{id:"\u7ea6\u5b9a"},"\u7ea6\u5b9a"),(0,l.yg)("blockquote",null,(0,l.yg)("p",{parentName:"blockquote"},"\u5982\u679c\u60a8\u9075\u5faa GORM \u7684\u7ea6\u5b9a\uff0c\u60a8\u5c31\u53ef\u4ee5\u5c11\u5199\u914d\u7f6e\u7684\u4ee3\u7801\u3002 \u5982\u679c\u7ea6\u5b9a\u4e0d\u7b26\u5408\u60a8\u7684\u5b9e\u9645\u8981\u6c42\uff0c",(0,l.yg)("a",{parentName:"p",href:"https://gorm.io/zh_CN/docs/conventions.html"},"GORM \u5141\u8bb8\u4f60\u914d\u7f6e\u5b83\u4eec"))),(0,l.yg)("p",null,"GORM \u503e\u5411\u4e8e\u7ea6\u5b9a\u4f18\u4e8e\u914d\u7f6e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGORM"),(0,l.yg)("h4",{id:"\u4f7f\u7528-id-\u4f5c\u4e3a\u4e3b\u952e"},"\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"h4"},"ID")," \u4f5c\u4e3a\u4e3b\u952e"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  ID   string // \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u540d\u4e3a `ID` \u7684\u5b57\u6bb5\u4f1a\u4f5c\u4e3a\u8868\u7684\u4e3b\u952e\n  Name string\n}\n\n// \u5c06 `UUID` \u8bbe\u4e3a\u4e3b\u952e\ntype Animal struct {\n  ID     int64\n  UUID   string `gorm:"primaryKey"` // \u4f60\u53ef\u4ee5\u901a\u8fc7\u6807\u7b7e primaryKey \u5c06\u5176\u5b83\u5b57\u6bb5\u8bbe\u4e3a\u4e3b\u952e \n  Name   string\n  Age    int64\n}\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-4"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'//\u901a\u8fc7\u5c06\u591a\u4e2a\u5b57\u6bb5\u8bbe\u4e3a\u4e3b\u952e\uff0c\u4ee5\u521b\u5efa\u590d\u5408\u4e3b\u952e\uff0c\u4f8b\u5982\uff1a \ntype Product struct {\n  ID           string `gorm:"primaryKey"`\n  LanguageCode string `gorm:"primaryKey"`\n  Code         string\n  Name         string\n}\n<b>//</b><b>\u6ce8\u610f</b><b>\uff1a</b>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6574\u578b PrioritizedPrimaryField \u542f\u7528\u4e86 AutoIncrement\uff0c\u8981\u7981\u7528\u5b83\uff0c\u60a8\u9700\u8981\u4e3a\u6574\u578b\u5b57\u6bb5\u5173\u95ed autoIncrement\uff1a \ntype Product struct {\n  CategoryID uint64 `gorm:"primaryKey;autoIncrement:false"`\n  TypeID     uint64 `gorm:"primaryKey;autoIncrement:false"`\n}\n')),(0,l.yg)("h4",{id:"\u4f7f\u7528\u7ed3\u6784\u4f53\u540d\u79f0\u7684\u86c7\u5f62\u547d\u540d\u7684\u590d\u6570\u5f62\u5f0f\u4f5c\u4e3a\u8868\u540d"},"\u4f7f\u7528\u7ed3\u6784\u4f53\u540d\u79f0\u7684",(0,l.yg)("inlineCode",{parentName:"h4"},"\u86c7\u5f62\u547d\u540d\u7684\u590d\u6570\u5f62\u5f0f"),"\u4f5c\u4e3a\u8868\u540d"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,(0,l.yg)("code",null,"\u86c7\u5f62\u547d\u540d"),"\uff1a\u8f6c\u5316\u5f62\u5f0f\u5982\uff0c",(0,l.yg)("code",null,"CreatedAt ==> created_at"))),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {} // \u9ed8\u8ba4\u7684\u8868\u540d\u662f `users`\n\n// \u5982\u679c\u8bbe\u7f6e\u7981\u7528\u8868\u540d\u590d\u6570\u5f62\u5f0f\u5c5e\u6027\u4e3a true\uff0c`User` \u7684\u8868\u540d\u5c06\u662f `user`\ndb.SingularTable(true)\n\n\n// \u60a8\u53ef\u4ee5\u5b9e\u73b0 Tabler \u63a5\u53e3\u6765\u66f4\u6539\u9ed8\u8ba4\u8868\u540d\uff0c\u4f8b\u5982\uff1a \n// \u8bbe\u7f6e `User` \u7684\u8868\u540d\u4e3a `profiles`\nfunc (User) TableName() string {\n  return "profiles"\n}\n')),(0,l.yg)("h4",{id:"\u4f7f\u7528\u5b57\u6bb5\u540d\u7684-\u86c7\u5f62\u547d\u540d-\u4f5c\u4e3a\u5217\u540d"},"\u4f7f\u7528\u5b57\u6bb5\u540d\u7684 ",(0,l.yg)("inlineCode",{parentName:"h4"},"\u86c7\u5f62\u547d\u540d")," \u4f5c\u4e3a\u5217\u540d"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  ID        uint      // \u5217\u540d\u662f `id`\n  Name      string    // \u5217\u540d\u662f `name`\n  Birthday  time.Time // \u5217\u540d\u662f `birthday`\n  CreatedAt time.Time // \u5217\u540d\u662f `created_at`\n}\n\n// \u60a8\u53ef\u4ee5\u4f7f\u7528 column \u6807\u7b7e\u6216 [\u547d\u540d\u7b56\u7565](https://learnku.com/docs/gorm/v2/conventions#naming_strategy) \u6765\u8986\u76d6\u5217\u540d \ntype Animal struct {\n  AnimalID int64     `gorm:"column:beast_id"`         // \u5c06\u5217\u540d\u8bbe\u4e3a `beast_id`\n  Birthday time.Time `gorm:"column:day_of_the_beast"` // \u5c06\u5217\u540d\u8bbe\u4e3a `day_of_the_beast`\n  Age      int64     `gorm:"column:age_of_the_beast"` // \u5c06\u5217\u540d\u8bbe\u4e3a `age_of_the_beast`\n}\n')),(0,l.yg)("h4",{id:"\u4f7f\u7528-createdatupdatedat-\u5b57\u6bb5\u8ffd\u8e2a\u521b\u5efa\u66f4\u65b0\u65f6\u95f4"},"\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"h4"},"CreatedAt"),"\u3001",(0,l.yg)("inlineCode",{parentName:"h4"},"UpdatedAt")," \u5b57\u6bb5\u8ffd\u8e2a\u521b\u5efa\u3001\u66f4\u65b0\u65f6\u95f4"),(0,l.yg)("p",null,"\u5bf9\u4e8e\u6709 ",(0,l.yg)("inlineCode",{parentName:"p"},"CreatedAt")," \u5b57\u6bb5\u7684\u6a21\u578b\uff0c\u521b\u5efa\u8bb0\u5f55\u65f6\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u503c\u4e3a\u96f6\u503c\uff0c\u5219\u5c06\u8be5\u5b57\u6bb5\u7684\u503c\u8bbe\u4e3a\u5f53\u524d\u65f6\u95f4\uff0c \u5bf9\u4e8e\u6709 ",(0,l.yg)("inlineCode",{parentName:"p"},"UpdatedAt")," \u5b57\u6bb5\u7684\u6a21\u578b\uff0c\u66f4\u65b0\u8bb0\u5f55\u65f6\uff0c\u5c06\u8be5\u5b57\u6bb5\u7684\u503c\u8bbe\u4e3a\u5f53\u524d\u65f6\u95f4\u3002\u521b\u5efa\u8bb0\u5f55\u65f6\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u503c\u4e3a\u96f6\u503c\uff0c\u5219\u5c06\u8be5\u5b57\u6bb5\u7684\u503c\u8bbe\u4e3a\u5f53\u524d\u65f6\u95f4\u3002"),(0,l.yg)("h2",{id:"cuda\u63a5\u53e3"},"CUDA\u63a5\u53e3"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u4f7f\u7528ORM\u6700\u91cd\u8981\u7684\u5f53\u7136\u8fd8\u662f\u8fd9\u4e2a\u5566\u3002")),(0,l.yg)("h3",{id:"\u521b\u5efa"},"\u521b\u5efa"),(0,l.yg)("p",null,"\u63d2\u5165\u4e00\u6761"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'user := User{Name: "Jinzhu", Age: 18, Birthday: time.Now()}\n\nresult := db.Create(&user) // \u901a\u8fc7\u6570\u636e\u7684\u6307\u9488\u6765\u521b\u5efa\n\nuser.ID             // \u8fd4\u56de\u63d2\u5165\u6570\u636e\u7684\u4e3b\u952e\nresult.Error        // \u8fd4\u56de error\nresult.RowsAffected // \u8fd4\u56de\u63d2\u5165\u8bb0\u5f55\u7684\u6761\u6570\n')),(0,l.yg)("p",null,"\u6279\u91cf\u63d2\u5165"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'//\u5168\u90e8\u63d2\u5165\nvar users = []User{{Name: "jinzhu1"}, {Name: "jinzhu2"}, {Name: "jinzhu3"}}\ndb.Create(&users)\n//\u63d2\u5165\u5176\u4e2d\u6307\u5b9a\u6570\u91cf\u7684\nvar users = []User{name: "jinzhu_1"}, ...., {Name: "jinzhu_10000"}}\ndb.CreateInBatches(users, 100) //\u63d2\u5165100\u6761\n')),(0,l.yg)("p",null,"\u4f7f\u7528Map"),(0,l.yg)("p",null,"GORM \u652f\u6301\u6839\u636e ",(0,l.yg)("inlineCode",{parentName:"p"},"map[string]interface{}")," \u548c ",(0,l.yg)("inlineCode",{parentName:"p"},"[]map[string]interface{}{}")," \u521b\u5efa\u8bb0\u5f55\uff0c\u4f8b\u5982\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'//\u63d2\u5165\u4e00\u6761\ndb.Model(&User{}).Create(map[string]interface{}{\n  "Name": "jinzhu", "Age": 18,\n})\n\n//\u6279\u91cf\u63d2\u5165\ndb.Model(&User{}).Create([]map[string]interface{}{\n  {"Name": "jinzhu_1", "Age": 18},\n  {"Name": "jinzhu_2", "Age": 20},\n})\n')),(0,l.yg)("p",null,"\u9ed8\u8ba4\u503c"),(0,l.yg)("p",null,"\u60a8\u53ef\u4ee5\u901a\u8fc7\u6807\u7b7e ",(0,l.yg)("inlineCode",{parentName:"p"},"default")," \u4e3a\u5b57\u6bb5\u5b9a\u4e49\u9ed8\u8ba4\u503c\uff0c\u5982\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  ID   int64\n  Name string `gorm:"default:galeone"`\n  Age  int64  `gorm:"default:18"`\n}\n')),(0,l.yg)("p",null,"\u63d2\u5165\u8bb0\u5f55\u5230\u6570\u636e\u5e93\u65f6\uff0c\u9ed8\u8ba4\u503c ",(0,l.yg)("em",null,"\u4f1a\u88ab\u7528\u4e8e")," \u586b\u5145\u503c\u4e3a ",(0,l.yg)("a",{parentName:"p",href:"https://tour.golang.org/basics/12"},"\u96f6\u503c")," \u7684\u5b57\u6bb5"),(0,l.yg)("b",null,"\u6ce8\u610f")," \u50cf `0`\u3001`''`\u3001`false` \u7b49\u96f6\u503c\uff0c\u4e0d\u4f1a\u5c06\u8fd9\u4e9b\u5b57\u6bb5\u5b9a\u4e49\u7684\u9ed8\u8ba4\u503c\u4fdd\u5b58\u5230\u6570\u636e\u5e93\u3002\u60a8\u9700\u8981\u4f7f\u7528\u6307\u9488\u7c7b\u578b\u6216 Scanner/Valuer \u6765\u907f\u514d\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f8b\u5982\uff1a",(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"type User struct {")),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"  gorm.Model")),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"  Name string")),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},'  Age  *int           gorm:"default:18"')),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},'  Active sql.NullBool gorm:"default:true"')),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"}")),(0,l.yg)("b",null,"\u6ce8\u610f")," \u82e5\u8981\u6570\u636e\u5e93\u6709\u9ed8\u8ba4\u3001\u865a\u62df / \u751f\u6210\u7684\u503c\uff0c\u4f60\u5fc5\u987b\u4e3a\u5b57\u6bb5\u8bbe\u7f6e `default` \u6807\u7b7e\u3002\u82e5\u8981\u5728\u8fc1\u79fb\u65f6\u8df3\u8fc7\u9ed8\u8ba4\u503c\u5b9a\u4e49\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 `default:(-)`\uff0c\u4f8b\u5982\uff1a",(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  ID        string `gorm:"default:uuid_generate_v3()"` // \u6570\u636e\u5e93\u51fd\u6570\n  FirstName string\n  LastName  string\n  Age       uint8\n  FullName  string `gorm:"->;type:GENERATED ALWAYS AS (concat(firstname,\' \',lastname));default:(-);`\n}\n//\u6ce8\uff1auuid_generate_v3()\u662f\u4e00\u4e2auuid\u751f\u6210\u51fd\u6570\n//UUID \u662f\u4e00\u79cd\u901a\u7528\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u5b83\u7531 32 \u4e3a\u5341\u516d\u8fdb\u5236\u6570\u5b57\u4ee5\u53ca\u8fde\u5b57\u7b26\u7ec4\u6210\u3002\n\n//\u4e0e SERIAL\uff0c\u6807\u8bc6\u5217\uff0c\u548c \u5e8f\u5217 \u76f8\u6bd4\uff0c UUID \u5177\u6709\u5168\u5c40\u7684\u552f\u4e00\u6027\uff0c\u800c\u4e0d\u662f\u6570\u636e\u5e93\u4e2d\u7684\u552f\u4e00\u6027\u3002 UUID \u66f4\u9002\u5408\u5728\u96c6\u7fa4\u73af\u5883\u4e2d\u4f5c\u4e3a\u552f\u4e00\u6807\u8bc6\u7b26\u3002\n\n//PostgreSQL \u652f\u6301 UUID \u6570\u636e\u7c7b\u578b\uff0c\u4ee5\u5b58\u50a8 UUID \u6570\u636e\u3002\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-5"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"Hook \u662f\u5728\u521b\u5efa\u3001\u67e5\u8be2\u3001\u66f4\u65b0\u3001\u5220\u9664\u7b49\u64cd\u4f5c\u4e4b\u524d\u3001\u4e4b\u540e\u8c03\u7528\u7684\u51fd\u6570\u3002"),(0,l.yg)("p",null,"\u5982\u679c\u60a8\u5df2\u7ecf\u4e3a\u6a21\u578b\u5b9a\u4e49\u4e86\u6307\u5b9a\u7684\u65b9\u6cd5\uff0c\u5b83\u4f1a\u5728\u521b\u5efa\u3001\u66f4\u65b0\u3001\u67e5\u8be2\u3001\u5220\u9664\u65f6\u81ea\u52a8\u88ab\u8c03\u7528\u3002\u5982\u679c\u4efb\u4f55\u56de\u8c03\u8fd4\u56de\u9519\u8bef\uff0cGORM \u5c06\u505c\u6b62\u540e\u7eed\u7684\u64cd\u4f5c\u5e76\u56de\u6eda\u4e8b\u52a1\u3002"),(0,l.yg)("p",null,"\u94a9\u5b50\u65b9\u6cd5\u7684\u51fd\u6570\u7b7e\u540d\u5e94\u8be5\u662f func(*gorm.DB) error")),(0,l.yg)("p",null,"Hook\uff1aGORM \u5141\u8bb8\u7528\u6237\u5b9a\u4e49\u7684\u94a9\u5b50\u6709 BeforeSave, BeforeCreate, AfterSave, AfterCreate \u521b\u5efa\u8bb0\u5f55\u65f6\u5c06\u8c03\u7528\u8fd9\u4e9b\u94a9\u5b50\u65b9\u6cd5\u3002"),(0,l.yg)("p",null,"\u4f8b\u5982\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'func (u *User) BeforeCreate(tx *gorm.DB) (err error) {\n  u.UUID = uuid.New()\n\n    if u.Role == "admin" {\n        return errors.New("invalid role")\n    }\n    return\n}\n')),(0,l.yg)("p",null,"\u5982\u679c\u60a8\u60f3\u8df3\u8fc7 \u94a9\u5b50 \u65b9\u6cd5\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 SkipHooks \u4f1a\u8bdd\u6a21\u5f0f\uff0c\u4f8b\u5982\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"DB.Session(&gorm.Session{SkipHooks: true}).Create(&user)\n\nDB.Session(&gorm.Session{SkipHooks: true}).Create(&users)\n\nDB.Session(&gorm.Session{SkipHooks: true}).CreateInBatches(users, 100)\n")),(0,l.yg)("p",null,"\u4f7f\u7528 SQL \u8868\u8fbe\u5f0f\u3001Context Valuer \u521b\u5efa\u8bb0\u5f55"),(0,l.yg)("p",null,(0,l.yg)("a",{parentName:"p",href:"https://learnku.com/docs/gorm/v2/create/9732#46c90b"},"https://learnku.com/docs/gorm/v2/create/9732#46c90b")),(0,l.yg)("h3",{id:"\u67e5\u8be2"},"\u67e5\u8be2"),(0,l.yg)("p",null,"\u67e5\u8be2\u4e00\u4e2a"),(0,l.yg)("p",null,"\u6ce8\u610f: ",(0,l.yg)("inlineCode",{parentName:"p"},"First"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"Last")," \u65b9\u6cd5\u4f1a\u6839\u636e\u4e3b\u952e\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u3001\u6700\u540e\u4e00\u4e2a\u8bb0\u5f55\uff0c \u5b83\u4ec5\u5728\u901a\u8fc7 struct \u6216\u63d0\u4f9b model \u503c\u8fdb\u884c\u67e5\u8be2\u65f6\u624d\u8d77\u4f5c\u7528\u3002 \u5982\u679c model \u7c7b\u578b\u6ca1\u6709\u5b9a\u4e49\u4e3b\u952e\uff0c\u5219\u6309\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u6392\u5e8f\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'var user User\n// \u83b7\u53d6\u7b2c\u4e00\u6761\u8bb0\u5f55\uff08\u4e3b\u952e\u5347\u5e8f\uff09\ndb.First(&user)\n// SELECT * FROM users ORDER BY id LIMIT 1;\n\n// \u83b7\u53d6\u4e00\u6761\u8bb0\u5f55\uff0c\u6ca1\u6709\u6307\u5b9a\u6392\u5e8f\u5b57\u6bb5\ndb.Take(&user)\n// SELECT * FROM users LIMIT 1;\n\n// \u83b7\u53d6\u6700\u540e\u4e00\u6761\u8bb0\u5f55\uff08\u4e3b\u952e\u964d\u5e8f\uff09\ndb.Last(&user)\n// SELECT * FROM users ORDER BY id DESC LIMIT 1;\n\nresult := db.First(&user)\nresult.RowsAffected // \u8fd4\u56de\u627e\u5230\u7684\u8bb0\u5f55\u6570\nresult.Error        // returns error\n\n// \u68c0\u67e5 ErrRecordNotFound \u9519\u8bef\nerrors.Is(result.Error, gorm.ErrRecordNotFound)\n\nresult := map[string]interface{}{}\ndb.Model(&User{}).First(&result)\n// SELECT * FROM `users` ORDER BY `users`.`id` LIMIT 1\n\n// First\uff0cLast\u4e0d\u53ef\u4ee5\u8fd9\u6837\u7528\nresult := map[string]interface{}{}\ndb.Table("users").First(&result)\n\n// Take\u53ef\u4ee5\u8fd9\u6837\u7528\nresult := map[string]interface{}{}\ndb.Table("users").Take(&result)\n\n// \u6839\u636e\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u6392\u5e8f\ntype Language struct {\n  Code string\n  Name string\n}\ndb.First(&Language{})\n// SELECT * FROM `languages` ORDER BY `languages`.`code` LIMIT 1\n')),(0,l.yg)("p",null,"\u67e5\u8be2\u5168\u90e8"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"// \u83b7\u53d6\u5168\u90e8\u8bb0\u5f55\nresult := db.Find(&users)\n// SELECT * FROM users;\n\nresult.RowsAffected // \u8fd4\u56de\u627e\u5230\u7684\u8bb0\u5f55\u6570\uff0c\u76f8\u5f53\u4e8e `len(users)`\nresult.Error        // returns error\n")),(0,l.yg)("p",null,"\u6839\u636e\u4e3b\u952e\u68c0\u7d22"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.First(&user, 10)\n// SELECT * FROM users WHERE id = 10;\n\ndb.First(&user, "10")\n// SELECT * FROM users WHERE id = 10;\n\ndb.Find(&users, []int{1,2,3})\n// SELECT * FROM users WHERE id IN (1,2,3);\n')),(0,l.yg)("p",null,"\u6761\u4ef6"),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"String\u6761\u4ef6")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u83b7\u53d6\u7b2c\u4e00\u6761\u5339\u914d\u7684\u8bb0\u5f55\ndb.Where("name = ?", "jinzhu").First(&user)\n// SELECT * FROM users WHERE name = \'jinzhu\' ORDER BY id LIMIT 1;\n\n// \u83b7\u53d6\u5168\u90e8\u5339\u914d\u7684\u8bb0\u5f55\ndb.Where("name <> ?", "jinzhu").Find(&users)\n// SELECT * FROM users WHERE name <> \'jinzhu\';\n\n// IN\ndb.Where("name IN ?", []string{"jinzhu", "jinzhu 2"}).Find(&users)\n// SELECT * FROM users WHERE name IN (\'jinzhu\',\'jinzhu 2\');\n\n// LIKE\ndb.Where("name LIKE ?", "%jin%").Find(&users)\n// SELECT * FROM users WHERE name LIKE \'%jin%\';\n\n// AND\ndb.Where("name = ? AND age >= ?", "jinzhu", "22").Find(&users)\n// SELECT * FROM users WHERE name = \'jinzhu\' AND age >= 22;\n\n// Time\ndb.Where("updated_at > ?", lastWeek).Find(&users)\n// SELECT * FROM users WHERE updated_at > \'2000-01-01 00:00:00\';\n\n// BETWEEN\ndb.Where("created_at BETWEEN ? AND ?", lastWeek, today).Find(&users)\n// SELECT * FROM users WHERE created_at BETWEEN \'2000-01-01 00:00:00\' AND \'2000-01-08 00:00:00\';\n')),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"Struct & Map \u6761\u4ef6")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// Struct\ndb.Where(&User{Name: "jinzhu", Age: 20}).First(&user)\n// SELECT * FROM users WHERE name = "jinzhu" AND age = 20 ORDER BY id LIMIT 1;\n\n// Map\ndb.Where(map[string]interface{}{"name": "jinzhu", "age": 20}).Find(&users)\n// SELECT * FROM users WHERE name = "jinzhu" AND age = 20;\n\n// \u4e3b\u952e\u5207\u7247\u6761\u4ef6\ndb.Where([]int64{20, 21, 22}).Find(&users)\n// SELECT * FROM users WHERE id IN (20, 21, 22);\n')),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u6ce8\u610f\uff1a\u5f53\u4f7f\u7528\u7ed3\u6784\u4f5c\u4e3a\u6761\u4ef6\u67e5\u8be2\u65f6\uff0cGORM \u53ea\u4f1a\u67e5\u8be2\u975e\u96f6\u503c\u5b57\u6bb5\u3002\u8fd9\u610f\u5473\u7740\u5982\u679c\u60a8\u7684\u5b57\u6bb5\u503c\u4e3a ",(0,l.yg)("code",null,"0"),"\u3001",(0,l.yg)("code",null,"''"),"\u3001",(0,l.yg)("code",null,"false")," \u6216\u5176\u4ed6 ",(0,l.yg)("a",{href:"https://tour.golang.org/basics/12"},"\u96f6\u503c"),"\uff0c\u8be5\u5b57\u6bb5\u4e0d\u4f1a\u88ab\u7528\u4e8e\u6784\u5efa\u67e5\u8be2\u6761\u4ef6\uff0c\u4f8b\u5982\uff1a")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Where(&User{Name: "jinzhu", Age: 0}).Find(&users)\n// SELECT * FROM users WHERE name = "jinzhu";\n\n//\u60a8\u53ef\u4ee5\u4f7f\u7528 map \u6765\u6784\u5efa\u67e5\u8be2\u6761\u4ef6\ndb.Where(map[string]interface{}{"Name": "jinzhu", "Age": 0}).Find(&users)\n// SELECT * FROM users WHERE name = "jinzhu" AND age = 0;\n')),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"\u5185\u8054\u6761\u4ef6")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// SELECT * FROM users WHERE id = 23;\n// \u6839\u636e\u4e3b\u952e\u83b7\u53d6\u8bb0\u5f55\uff0c\u5982\u679c\u662f\u975e\u6574\u578b\u4e3b\u952e\ndb.First(&user, "id = ?", "string_primary_key")\n// SELECT * FROM users WHERE id = \'string_primary_key\';\n\n// Plain SQL\ndb.Find(&user, "name = ?", "jinzhu")\n// SELECT * FROM users WHERE name = "jinzhu";\n\ndb.Find(&users, "name <> ? AND age > ?", "jinzhu", 20)\n// SELECT * FROM users WHERE name <> "jinzhu" AND age > 20;\n\n// Struct\ndb.Find(&users, User{Age: 20})\n// SELECT * FROM users WHERE age = 20;\n\n// Map\ndb.Find(&users, map[string]interface{}{"age": 20})\n// SELECT * FROM users WHERE age = 20;\n')),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"Not\u6761\u4ef6")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Not("name = ?", "jinzhu").First(&user)\n// SELECT * FROM users WHERE NOT name = "jinzhu" ORDER BY id LIMIT 1;\n\n// Not In\ndb.Not(map[string]interface{}{"name": []string{"jinzhu", "jinzhu 2"}}).Find(&users)\n// SELECT * FROM users WHERE name NOT IN ("jinzhu", "jinzhu 2");\n\n// Struct\ndb.Not(User{Name: "jinzhu", Age: 18}).First(&user)\n// SELECT * FROM users WHERE name <> "jinzhu" AND age <> 18 ORDER BY id LIMIT 1;\n\n// \u4e0d\u5728\u4e3b\u952e\u5207\u7247\u4e2d\u7684\u8bb0\u5f55\ndb.Not([]int64{1,2,3}).First(&user)\n// SELECT * FROM users WHERE id NOT IN (1,2,3) ORDER BY id LIMIT 1;\n')),(0,l.yg)("ul",null,(0,l.yg)("li",{parentName:"ul"},"Or\u6761\u4ef6")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Where("role = ?", "admin").Or("role = ?", "super_admin").Find(&users)\n// SELECT * FROM users WHERE role = \'admin\' OR role = \'super_admin\';\n\n// Struct\ndb.Where("name = \'jinzhu\'").Or(User{Name: "jinzhu 2", Age: 18}).Find(&users)\n// SELECT * FROM users WHERE name = \'jinzhu\' OR (name = \'jinzhu 2\' AND age = 18);\n\n// Map\ndb.Where("name = \'jinzhu\'").Or(map[string]interface{}{"name": "jinzhu 2", "age": 18}).Find(&users)\n// SELECT * FROM users WHERE name = \'jinzhu\' OR (name = \'jinzhu 2\' AND age = 18);\n')),(0,l.yg)("p",null,"\u9009\u62e9\u7279\u5b9a\u5b57\u6bb5"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u9009\u62e9\u5168\u90e8\u5b57\u6bb5\uff0c\u6307\u5b9a\u5b57\u6bb5\u540e\uff0c\u53ea\u4f1a\u8fd4\u56de\u7279\u5b9a\u5b57\u6bb5\uff0c\u53ef\u4f18\u5316\u6027\u80fd")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Select("name", "age").Find(&users)\n// SELECT name, age FROM users;\n\ndb.Select([]string{"name", "age"}).Find(&users)\n// SELECT name, age FROM users;\n\ndb.Table("users").Select("COALESCE(age,?)", 42).Rows()\n// SELECT COALESCE(age,\'42\') FROM users;\n')),(0,l.yg)("p",null,"Scan"),(0,l.yg)("p",null,"Scan \u7ed3\u679c\u81f3 struct (\u628a\u7ed3\u679c\u7ed1\u5b9a\u56de\u6765)\uff0c\u7528\u6cd5\u4e0e ",(0,l.yg)("inlineCode",{parentName:"p"},"Find")," \u7c7b\u4f3c"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type Result struct {\n  Name string\n  Age  int\n}\n\nvar result Result\ndb.Table("users").Select("name", "age").Where("name = ?", "Antonio").Scan(&result)\n\n// \u539f\u751f SQL\ndb.Raw("SELECT name, age FROM users WHERE name = ?", "Antonio").Scan(&result)\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-6"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null,"\u6392\u5e8f"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Order("age desc, name").Find(&users)\n// SELECT * FROM users ORDER BY age desc, name;\n\n// \u591a\u4e2a order\ndb.Order("age desc").Order("name").Find(&users)\n// SELECT * FROM users ORDER BY age desc, name;\n\ndb.Clauses(clause.OrderBy{\n  Expression: clause.Expr{SQL: "FIELD(id,?)", Vars: []interface{}{[]int{1, 2, 3}}, WithoutParentheses: true},\n}).Find(&User{})\n// SELECT * FROM users ORDER BY FIELD(id,1,2,3)\n')),(0,l.yg)("p",null,"Limit & Offset"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"db.Limit(3).Find(&users)\n// SELECT * FROM users LIMIT 3;\n\n// \u901a\u8fc7 -1 \u6d88\u9664 Limit \u6761\u4ef6\ndb.Limit(10).Find(&users1).Limit(-1).Find(&users2)\n// SELECT * FROM users LIMIT 10; (users1)\n// SELECT * FROM users; (users2)\n\ndb.Offset(3).Find(&users)\n// SELECT * FROM users OFFSET 3;\n\ndb.Limit(10).Offset(5).Find(&users)\n// SELECT * FROM users OFFSET 5 LIMIT 10;\n\n// \u901a\u8fc7 -1 \u6d88\u9664 Offset \u6761\u4ef6\ndb.Offset(10).Find(&users1).Offset(-1).Find(&users2)\n// SELECT * FROM users OFFSET 10; (users1)\n// SELECT * FROM users; (users2)\n")),(0,l.yg)("p",null,"Group & Having"),(0,l.yg)("p",null,"GROUP BY \u8bed\u53e5\u7528\u4e8e\u7ed3\u5408\u805a\u5408\u51fd\u6570\uff0c\u6839\u636e\u4e00\u4e2a\u6216\u591a\u4e2a\u5217\u5bf9\u7ed3\u679c\u96c6\u8fdb\u884c\u5206\u7ec4\u3002"),(0,l.yg)("p",null,"\u5728 SQL \u4e2d\u589e\u52a0 HAVING \u5b50\u53e5\u539f\u56e0\u662f\uff0cWHERE \u5173\u952e\u5b57\u65e0\u6cd5\u4e0e\u805a\u5408\u51fd\u6570\u4e00\u8d77\u4f7f\u7528\u3002HAVING \u5b50\u53e5\u53ef\u4ee5\u8ba9\u6211\u4eec\u7b5b\u9009\u5206\u7ec4\u540e\u7684\u5404\u7ec4\u6570\u636e\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type result struct {\n  Date  time.Time\n  Total int\n}\n\ndb.Model(&User{}).Select("name, sum(age) as total").Where("name LIKE ?", "group%").Group("name").First(&result)\n// SELECT name, sum(age) as total FROM `users` WHERE name LIKE "group%" GROUP BY `name`\n\ndb.Model(&User{}).Select("name, sum(age) as total").Group("name").Having("name = ?", "group").Find(&result)\n// SELECT name, sum(age) as total FROM `users` GROUP BY `name` HAVING name = "group"\n\nrows, err := db.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Rows()\nfor rows.Next() {\n  ...\n}\n\nrows, err := db.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Having("sum(amount) > ?", 100).Rows()\nfor rows.Next() {\n  ...\n}\n\ntype Result struct {\n  Date  time.Time\n  Total int64\n}\ndb.Table("orders").Select("date(created_at) as date, sum(amount) as total").Group("date(created_at)").Having("sum(amount) > ?", 100).Scan(&results)\n')),(0,l.yg)("p",null,"Distinct"),(0,l.yg)("p",null,"\u5728\u8868\u4e2d\uff0c\u4e00\u4e2a\u5217\u53ef\u80fd\u4f1a\u5305\u542b\u591a\u4e2a\u91cd\u590d\u503c\uff0c\u6709\u65f6\u60a8\u4e5f\u8bb8\u5e0c\u671b\u4ec5\u4ec5\u5217\u51fa\u4e0d\u540c\uff08distinct\uff09\u7684\u503c\u3002"),(0,l.yg)("p",null,"DISTINCT \u5173\u952e\u8bcd\u7528\u4e8e\u8fd4\u56de\u552f\u4e00\u4e0d\u540c\u7684\u503c\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Distinct("name", "age").Order("name, age desc").Find(&results)\n')),(0,l.yg)("p",null,"Joins"),(0,l.yg)("p",null,"SQL join \u7528\u4e8e\u628a\u6765\u81ea\u4e24\u4e2a\u6216\u591a\u4e2a\u8868\u7684\u884c\u7ed3\u5408\u8d77\u6765\u3002"),(0,l.yg)("p",null,"\u4e0b\u56fe\u5c55\u793a\u4e86 LEFT JOIN\u3001RIGHT JOIN\u3001INNER JOIN\u3001OUTER JOIN \u76f8\u5173\u7684 7 \u79cd\u7528\u6cd5\u3002"),(0,l.yg)("p",null,(0,l.yg)("img",{src:a(3484).A,width:"966",height:"760"})),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type result struct {\n  Name  string\n  Email string\n}\ndb.Model(&User{}).Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Scan(&result{})\n// SELECT users.name, emails.email FROM `users` left join emails on emails.user_id = users.id\n\nrows, err := db.Table("users").Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Rows()\nfor rows.Next() {\n  ...\n}\n\ndb.Table("users").Select("users.name, emails.email").Joins("left join emails on emails.user_id = users.id").Scan(&results)\n\n// \u5e26\u53c2\u6570\u7684\u591a\u8868\u8fde\u63a5\ndb.Joins("JOIN emails ON emails.user_id = users.id AND emails.email = ?", "jinzhu@example.org").Joins("JOIN credit_cards ON credit_cards.user_id = users.id").Where("credit_cards.number = ?", "411111111111").Find(&user)\n')),(0,l.yg)("h3",{id:"\u9ad8\u7ea7\u67e5\u8be2"},"\u9ad8\u7ea7\u67e5\u8be2"),(0,l.yg)("h3",{id:"\u66f4\u65b0"},"\u66f4\u65b0"),(0,l.yg)("p",null,"\u4fdd\u5b58\u6240\u6709\u5b57\u6bb5"),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"Save")," \u4f1a\u4fdd\u5b58\u6240\u6709\u7684\u5b57\u6bb5\uff0c\u5373\u4f7f\u5b57\u6bb5\u662f\u96f6\u503c"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"db.First(&user)\n\nuser.Name = \"jinzhu 2\"\nuser.Age = 100\ndb.Save(&user)\n// UPDATE users SET name='jinzhu 2', age=100, birthday='2016-01-01', updated_at = '2013-11-17 21:34:10' WHERE id=111;\n")),(0,l.yg)("p",null,"\u66f4\u65b0\u4e00\u5217"),(0,l.yg)("p",null,"\u5f53\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"p"},"Update")," \u66f4\u65b0\u5355\u4e2a\u5217\u65f6\uff0c\u4f60\u9700\u8981\u6307\u5b9a\u6761\u4ef6\uff0c\u5426\u5219\u4f1a\u8fd4\u56de ",(0,l.yg)("inlineCode",{parentName:"p"},"ErrMissingWhereClause")," \u9519\u8bef\uff0c\u5f53\u4f7f\u7528\u4e86 ",(0,l.yg)("inlineCode",{parentName:"p"},"Model")," \u65b9\u6cd5\uff0c\u4e14\u8be5\u5bf9\u8c61\u4e3b\u952e\u6709\u503c\uff0c\u8be5\u503c\u4f1a\u88ab\u7528\u4e8e\u6784\u5efa\u6761\u4ef6\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u6761\u4ef6\u66f4\u65b0\ndb.Model(&User{}).Where("active = ?", true).Update("name", "hello")\n// UPDATE users SET name=\'hello\', updated_at=\'2013-11-17 21:34:10\' WHERE active=true;\n\n// User \u7684 ID \u662f `111`\ndb.Model(&user).Update("name", "hello")\n// UPDATE users SET name=\'hello\', updated_at=\'2013-11-17 21:34:10\' WHERE id=111;\n\n// \u6839\u636e\u6761\u4ef6\u548c model \u7684\u503c\u8fdb\u884c\u66f4\u65b0\ndb.Model(&user).Where("active = ?", true).Update("name", "hello")\n// UPDATE users SET name=\'hello\', updated_at=\'2013-11-17 21:34:10\' WHERE id=111 AND active=true;\n')),(0,l.yg)("p",null,"\u66f4\u65b0\u591a\u5217"),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"Updates")," \u65b9\u6cd5\u652f\u6301 ",(0,l.yg)("inlineCode",{parentName:"p"},"struct")," \u548c ",(0,l.yg)("inlineCode",{parentName:"p"},"map[string]interface{}")," \u53c2\u6570\u3002\u5f53\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"p"},"struct")," \u66f4\u65b0\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGORM \u53ea\u4f1a\u66f4\u65b0\u975e\u96f6\u503c\u7684\u5b57\u6bb5"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u6839\u636e `struct` \u66f4\u65b0\u5c5e\u6027\uff0c\u53ea\u4f1a\u66f4\u65b0\u975e\u96f6\u503c\u7684\u5b57\u6bb5\ndb.Model(&user).Updates(User{Name: "hello", Age: 18, Active: false})\n// UPDATE users SET name=\'hello\', age=18, updated_at = \'2013-11-17 21:34:10\' WHERE id = 111;\n\n// \u6839\u636e `map` \u66f4\u65b0\u5c5e\u6027\ndb.Model(&user).Updates(map[string]interface{}{"name": "hello", "age": 18, "actived": false})\n// UPDATE users SET name=\'hello\', age=18, actived=false, updated_at=\'2013-11-17 21:34:10\' WHERE id=111;\n')),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,(0,l.yg)("b",null,"\u6ce8\u610f")," \u5f53\u901a\u8fc7 struct \u66f4\u65b0\u65f6\uff0cGORM \u53ea\u4f1a\u66f4\u65b0\u975e\u96f6\u5b57\u6bb5\u3002 \u5982\u679c\u60a8\u60f3\u786e\u4fdd\u6307\u5b9a\u5b57\u6bb5\u88ab\u66f4\u65b0\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528 ",(0,l.yg)("code",null,"Select")," \u66f4\u65b0\u9009\u5b9a\u5b57\u6bb5\uff0c\u6216\u4f7f\u7528 ",(0,l.yg)("code",null,"map")," \u6765\u5b8c\u6210\u66f4\u65b0\u64cd\u4f5c")),(0,l.yg)("p",null,"\u66f4\u65b0\u9009\u5b9a\u5b57\u6bb5"),(0,l.yg)("p",null,"\u5982\u679c\u60a8\u60f3\u8981\u5728\u66f4\u65b0\u65f6\u9009\u5b9a\u3001\u5ffd\u7565\u67d0\u4e9b\u5b57\u6bb5\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ",(0,l.yg)("inlineCode",{parentName:"p"},"Select"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"Omit")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// Select \u548c Map\n// User\'s ID is `111`:\ndb.Model(&user).Select("name").Updates(map[string]interface{}{"name": "hello", "age": 18, "actived": false})\n// UPDATE users SET name=\'hello\' WHERE id=111;\n\ndb.Model(&user).Omit("name").Updates(map[string]interface{}{"name": "hello", "age": 18, "actived": false})\n// UPDATE users SET age=18, actived=false, updated_at=\'2013-11-17 21:34:10\' WHERE id=111;\n\n// Select \u548c Struct \uff08\u53ef\u4ee5\u9009\u4e2d\u66f4\u65b0\u96f6\u503c\u5b57\u6bb5\uff09\ndb.Model(&result).Select("Name", "Age").Updates(User{Name: "new_name", Age: 0})\n// UPDATE users SET name=\'new_name\', age=0 WHERE id=111;\n')),(0,l.yg)("p",null,"\u6279\u91cf\u66f4\u65b0"),(0,l.yg)("p",null,"\u5982\u679c\u60a8\u5c1a\u672a\u901a\u8fc7 ",(0,l.yg)("inlineCode",{parentName:"p"},"Model")," \u6307\u5b9a\u8bb0\u5f55\u7684\u4e3b\u952e\uff0c\u5219 GORM \u4f1a\u6267\u884c\u6279\u91cf\u66f4\u65b0"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u6839\u636e struct \u66f4\u65b0\ndb.Model(User{}).Where("role = ?", "admin").Updates(User{Name: "hello", Age: 18})\n// UPDATE users SET name=\'hello\', age=18 WHERE role = \'admin;\n\n// \u6839\u636e map \u66f4\u65b0\ndb.Table("users").Where("id IN ?", []int{10, 11}).Updates(map[string]interface{}{"name": "hello", "age": 18})\n// UPDATE users SET name=\'hello\', age=18 WHERE id IN (10, 11);\n')),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u5982\u679c\u5728\u6ca1\u6709\u4efb\u4f55\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b\u6267\u884c\u6279\u91cf\u66f4\u65b0\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGORM \u4e0d\u4f1a\u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u5e76\u8fd4\u56de ErrMissingWhereClause \u9519\u8bef"),(0,l.yg)("p",null,"\u5bf9\u6b64\uff0c\u4f60\u5fc5\u987b\u52a0\u4e00\u4e9b\u6761\u4ef6\uff0c\u6216\u8005\u4f7f\u7528\u539f\u751f SQL\uff0c\u6216\u8005\u542f\u7528 AllowGlobalUpdate \u6a21\u5f0f")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Model(&User{}).Update("name", "jinzhu").Error // gorm.ErrMissingWhereClause\n\ndb.Model(&User{}).Where("1 = 1").Update("name", "jinzhu")\n// UPDATE users SET `name` = "jinzhu" WHERE 1=1\n\ndb.Exec("UPDATE users SET name = ?", "jinzhu")\n// UPDATE users SET name = "jinzhu"\n\ndb.Session(&gorm.Session{AllowGlobalUpdate: true}).Model(&User{}).Update("name", "jinzhu")\n// UPDATE users SET `name` = "jinzhu"\n')),(0,l.yg)("p",null,"\u66f4\u65b0\u7684\u8bb0\u5f55\u6570"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u901a\u8fc7 `RowsAffected` \u5f97\u5230\u66f4\u65b0\u7684\u8bb0\u5f55\u6570\nresult := db.Model(User{}).Where("role = ?", "admin").Updates(User{Name: "hello", Age: 18})\n// UPDATE users SET name=\'hello\', age=18 WHERE role = \'admin;\n\nresult.RowsAffected // \u66f4\u65b0\u7684\u8bb0\u5f55\u6570\nresult.Error        // \u66f4\u65b0\u7684\u9519\u8bef\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-7"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null,"\u66f4\u65b0 Hook"),(0,l.yg)("p",null,"\u5bf9\u4e8e\u66f4\u65b0\u64cd\u4f5c\uff0cGORM \u652f\u6301 ",(0,l.yg)("inlineCode",{parentName:"p"},"BeforeSave"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"BeforeUpdate"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"AfterSave"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"AfterUpdate")," \u94a9\u5b50\uff0c\u8fd9\u4e9b\u65b9\u6cd5\u5c06\u5728\u66f4\u65b0\u8bb0\u5f55\u65f6\u88ab\u8c03\u7528\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'func (u *User) BeforeUpdate(tx *gorm.DB) (err error) {\n    if u.Role == "admin" {\n        return errors.New("admin user not allowed to update")\n    }\n    return\n}\n')),(0,l.yg)("h3",{id:"\u5220\u9664"},"\u5220\u9664"),(0,l.yg)("p",null,"\u5220\u9664\u4e00\u6761"),(0,l.yg)("p",null,"\u5220\u9664\u4e00\u6761\u8bb0\u5f55\u65f6\uff0c\u5220\u9664\u5bf9\u8c61\u9700\u8981\u6307\u5b9a\u4e3b\u952e\uff0c\u5426\u5219\u4f1a\u89e6\u53d1 \u6279\u91cf\u5220\u9664"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// Email \u7684 ID \u662f `10`\ndb.Delete(&email)\n// DELETE from emails where id = 10;\n\n// \u5e26\u989d\u5916\u6761\u4ef6\u7684\u5220\u9664\ndb.Where("name = ?", "jinzhu").Delete(&email)\n// DELETE from emails where id = 10 AND name = "jinzhu";\n')),(0,l.yg)("p",null,"\u6279\u91cf\u5220\u9664"),(0,l.yg)("p",null,"\u5982\u679c\u6307\u5b9a\u7684\u503c\u4e0d\u5305\u62ec\u4e3b\u952e\uff0c\u90a3\u4e48 GORM \u4f1a\u6267\u884c\u6279\u91cf\u5220\u9664\uff0c\u5b83\u5c06\u5220\u9664\u6240\u6709\u5339\u914d\u7684\u8bb0\u5f55"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Where("email LIKE ?", "%jinzhu%").Delete(Email{})\n// DELETE from emails where email LIKE "%jinzhu%";\n\ndb.Delete(&Email{}, "email LIKE ?", "%jinzhu%")\n// DELETE from emails where email LIKE "%jinzhu%";\n')),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u548c\u66f4\u65b0\u64cd\u4f5c\u76f8\u540c\uff0c\u5982\u679c\u5728\u6ca1\u6709\u4efb\u4f55\u6761\u4ef6\u7684\u60c5\u51b5\u4e0b\u6267\u884c\u6279\u91cf\u5220\u9664\uff0cGORM \u4e0d\u4f1a\u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u5e76\u8fd4\u56de ErrMissingWhereClause \u9519\u8bef"),(0,l.yg)("p",null,"\u5bf9\u6b64\uff0c\u4f60\u5fc5\u987b\u52a0\u4e00\u4e9b\u6761\u4ef6\uff0c\u6216\u8005\u4f7f\u7528\u539f\u751f SQL\uff0c\u6216\u8005\u542f\u7528 AllowGlobalUpdate \u6a21\u5f0f")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Delete(&User{}).Error // gorm.ErrMissingWhereClause\n\ndb.Where("1 = 1").Delete(&User{})\n// DELETE FROM `users` WHERE 1=1\n\ndb.Exec("DELETE FROM users")\n// DELETE FROM users\n\ndb.Session(&gorm.Session{AllowGlobalUpdate: true}).Delete(&User{})\n// DELETE FROM users\n')),(0,l.yg)("p",null,"\u6839\u636e\u4e3b\u952e\u5220\u9664"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"GORM \u5141\u8bb8\u901a\u8fc7\u5185\u8054\u6761\u4ef6\u6307\u5b9a\u4e3b\u952e\u6765\u68c0\u7d22\u5bf9\u8c61\uff0c\u4f46\u53ea\u652f\u6301\u6574\u578b\u6570\u503c\uff0c\u56e0\u4e3a string \u53ef\u80fd\u5bfc\u81f4 SQL \u6ce8\u5165\u3002")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Delete(&User{}, 10)\n// DELETE FROM users WHERE id = 10;\n\ndb.Delete(&User{}, "10")\n// DELETE FROM users WHERE id = 10;\n\ndb.Delete(&users, []int{1,2,3})\n// DELETE FROM users WHERE id IN (1,2,3);\n')),(0,l.yg)("h5",{id:"\u6269\u5c55\u5185\u5bb9-8"},(0,l.yg)("inlineCode",{parentName:"h5"},"\u6269\u5c55\u5185\u5bb9\uff1a")),(0,l.yg)("p",null,"Delete Hook"),(0,l.yg)("p",null,"\u5bf9\u4e8e\u5220\u9664\u64cd\u4f5c\uff0cGORM \u652f\u6301 ",(0,l.yg)("inlineCode",{parentName:"p"},"BeforeDelete"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"AfterDelete")," Hook\uff0c\u5728\u5220\u9664\u8bb0\u5f55\u65f6\u4f1a\u8c03\u7528\u8fd9\u4e9b\u65b9\u6cd5"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'func (u *User) BeforeDelete(tx *gorm.DB) (err error) {\n    if u.Role == "admin" {\n        return errors.New("admin user not allowed to delete")\n    }\n    return\n}\n')),(0,l.yg)("p",null,"\u8f6f\u5220\u9664"),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u5982\u679c\u60a8\u7684\u6a21\u578b\u5305\u542b\u4e86\u4e00\u4e2a gorm.deletedat \u5b57\u6bb5\uff08gorm.Model \u5df2\u7ecf\u5305\u542b\u4e86\u8be5\u5b57\u6bb5)\uff0c\u5b83\u5c06\u81ea\u52a8\u83b7\u5f97\u8f6f\u5220\u9664\u7684\u80fd\u529b\uff01"),(0,l.yg)("p",null,"\u62e5\u6709\u8f6f\u5220\u9664\u80fd\u529b\u7684\u6a21\u578b\u8c03\u7528 Delete \u65f6\uff0c\u8bb0\u5f55\u4e0d\u4f1a\u88ab\u4ece\u6570\u636e\u5e93\u4e2d\u771f\u6b63\u5220\u9664\u3002\u4f46 GORM \u4f1a\u5c06 DeletedAt \u7f6e\u4e3a\u5f53\u524d\u65f6\u95f4\uff0c \u5e76\u4e14\u4f60\u4e0d\u80fd\u518d\u901a\u8fc7\u6b63\u5e38\u7684\u67e5\u8be2\u65b9\u6cd5\u627e\u5230\u8be5\u8bb0\u5f55\u3002")),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// user \u7684 ID \u662f `111`\ndb.Delete(&user)\n// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE id = 111;\n\n// \u6279\u91cf\u5220\u9664\ndb.Where("age = ?", 20).Delete(&User{})\n// UPDATE users SET deleted_at="2013-10-29 10:23" WHERE age = 20;\n\n// \u5728\u67e5\u8be2\u65f6\u4f1a\u5ffd\u7565\u88ab\u8f6f\u5220\u9664\u7684\u8bb0\u5f55\ndb.Where("age = 20").Find(&user)\n// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;\n')),(0,l.yg)("p",null,"\u67e5\u627e\u88ab\u8f6f\u5220\u9664\u7684\u8bb0\u5f55"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Unscoped().Where("age = 20").Find(&users)\n// SELECT * FROM users WHERE age = 20;\n')),(0,l.yg)("p",null,"\u6c38\u4e45\u5220\u9664"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"db.Unscoped().Delete(&order)\n// DELETE FROM orders WHERE id=10;\n")),(0,l.yg)("div",{class:"callout callout-bg-2 callout-border-2"},(0,l.yg)("div",{class:"callout-emoji"},"\ud83d\udca1"),(0,l.yg)("p",null,"\u4f60\u4e5f\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5220\u9664\u6807\u5fd7\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u5f53\u524d\u65f6\u95f4\u6233\uff0c\u5728\u6b64\u4e0d\u505a\u8ba8\u8bba")),(0,l.yg)("h3",{id:"sql\u6784\u5efa\u5668\u6269\u5c55\u5185\u5bb9"},"SQL\u6784\u5efa\u5668\uff08",(0,l.yg)("inlineCode",{parentName:"h3"},"\u6269\u5c55\u5185\u5bb9"),"\uff09"),(0,l.yg)("p",null,"\u539f\u751f SQL"),(0,l.yg)("p",null,"\u539f\u751f\u67e5\u8be2 SQL \u548c Scan"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'type Result struct {\n  ID   int\n  Name string\n  Age  int\n}\n\nvar result Result\ndb.Raw("SELECT id, name, age FROM users WHERE id = ?", 3).Scan(&result)\n\nvar age int\ndb.Raw("select sum(age) from users where role = ?", "admin").Scan(&age)\n')),(0,l.yg)("p",null,(0,l.yg)("inlineCode",{parentName:"p"},"Exec")," \u539f\u751f SQL"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Exec("DROP TABLE users")\ndb.Exec("UPDATE orders SET shipped_at=? WHERE id IN ?", time.Now(), []int64{1,2,3})\n\n// Exec SQL \u8868\u8fbe\u5f0f\ndb.Exec("update users set money=? where name = ?", gorm.Expr("money * ? + ?", 10000, 1), "jinzhu")\n')),(0,l.yg)("p",null,"\u547d\u540d\u53c2\u6570"),(0,l.yg)("p",null,"GORM \u652f\u6301 sql.NamedArg\u3001map","[string]","interface{}{} \u6216 struct \u5f62\u5f0f\u7684\u547d\u540d\u53c2\u6570\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Where("name1 = @name OR name2 = @name", sql.Named("name", "jinzhu")).Find(&user)\n// SELECT * FROM `users` WHERE name1 = "jinzhu" OR name2 = "jinzhu"\n\ndb.Where("name1 = @name OR name2 = @name", map[string]interface{}{"name": "jinzhu2"}).First(&result3)\n// SELECT * FROM `users` WHERE name1 = "jinzhu2" OR name2 = "jinzhu2" ORDER BY `users`.`id` LIMIT 1\n\n// \u539f\u751f SQL \u53ca\u547d\u540d\u53c2\u6570\ndb.Raw("SELECT * FROM users WHERE name1 = @name OR name2 = @name2 OR name3 = @name",\n   sql.Named("name", "jinzhu1"), sql.Named("name2", "jinzhu2")).Find(&user)\n// SELECT * FROM users WHERE name1 = "jinzhu1" OR name2 = "jinzhu2" OR name3 = "jinzhu1"\n\ndb.Exec("UPDATE users SET name1 = @name, name2 = @name2, name3 = @name",\n   sql.Named("name", "jinzhunew"), sql.Named("name2", "jinzhunew2"))\n// UPDATE users SET name1 = "jinzhunew", name2 = "jinzhunew2", name3 = "jinzhunew"\n\ndb.Raw("SELECT * FROM users WHERE (name1 = @name AND name3 = @name) AND name2 = @name2",\n   map[string]interface{}{"name": "jinzhu", "name2": "jinzhu2"}).Find(&user)\n// SELECT * FROM users WHERE (name1 = "jinzhu" AND name3 = "jinzhu") AND name2 = "jinzhu2"\n\ntype NamedArgument struct {\n    Name string\n    Name2 string\n}\n\ndb.Raw("SELECT * FROM users WHERE (name1 = @Name AND name3 = @Name) AND name2 = @Name2",\n     NamedArgument{Name: "jinzhu", Name2: "jinzhu2"}).Find(&user)\n// SELECT * FROM users WHERE (name1 = "jinzhu" AND name3 = "jinzhu") AND name2 = "jinzhu2"\n')),(0,l.yg)("h2",{id:"\u94fe\u5f0f\u8c03\u7528"},"\u94fe\u5f0f\u8c03\u7528"),(0,l.yg)("p",null,"GORM \u5141\u8bb8\u8fdb\u884c\u94fe\u5f0f\u64cd\u4f5c\uff0c\u6240\u4ee5\u60a8\u53ef\u4ee5\u50cf\u8fd9\u6837\u5199\u4ee3\u7801\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Where("name = ?", "jinzhu").Where("age = ?", 18).First(&user)\n')),(0,l.yg)("p",null,"Where, Select, Omit, Joins, Scopes, Preload, Raw\u90fd\u53ef\u4ee5\u8fdb\u884c\u94fe\u5f0f\u65b9\u6cd5\u8c03\u7528\uff08Raw\u4e0d\u53ef\u4ee5\u548c\u5176\u5b83\u65b9\u6cd5\u4e00\u8d77\u4f7f\u7528\uff09"),(0,l.yg)("h2",{id:"\u4e8b\u52a1"},"\u4e8b\u52a1"),(0,l.yg)("h3",{id:"\u7981\u7528\u9ed8\u8ba4\u4e8b\u52a1"},"\u7981\u7528\u9ed8\u8ba4\u4e8b\u52a1"),(0,l.yg)("p",null,"\u4e3a\u4e86\u786e\u4fdd\u6570\u636e\u4e00\u81f4\u6027\uff0cGORM \u4f1a\u5728\u4e8b\u52a1\u91cc\u6267\u884c\u5199\u5165\u64cd\u4f5c\uff08\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\uff09\u3002\u5982\u679c\u6ca1\u6709\u8fd9\u65b9\u9762\u7684\u8981\u6c42\uff0c\u60a8\u53ef\u4ee5\u5728\u521d\u59cb\u5316\u65f6\u7981\u7528\u5b83\uff0c\u8fd9\u5c06\u83b7\u5f97\u5927\u7ea6 30%+ \u6027\u80fd\u63d0\u5347\u3002"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'// \u5168\u5c40\u7981\u7528\ndb, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{\n  SkipDefaultTransaction: true,\n})\n\n// \u6301\u7eed\u4f1a\u8bdd\u6a21\u5f0f\ntx := db.Session(&Session{SkipDefaultTransaction: true})\ntx.First(&user, 1)\ntx.Find(&users)\ntx.Model(&user).Update("Age", 18)\n')),(0,l.yg)("h3",{id:"\u4e8b\u52a1-1"},"\u4e8b\u52a1"),(0,l.yg)("p",null,"\u8981\u5728\u4e8b\u52a1\u4e2d\u6267\u884c\u4e00\u7cfb\u5217\u64cd\u4f5c\uff0c\u4e00\u822c\u6d41\u7a0b\u5982\u4e0b\uff1a"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"db.Transaction(func(tx *gorm.DB) error {\n  // \u5728\u4e8b\u52a1\u4e2d\u6267\u884c\u4e00\u4e9b db \u64cd\u4f5c\uff08\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 'tx' \u800c\u4e0d\u662f 'db'\uff09\n  if err := tx.Create(&Animal{Name: \"Giraffe\"}).Error; err != nil {\n    // \u8fd4\u56de\u4efb\u4f55\u9519\u8bef\u90fd\u4f1a\u56de\u6eda\u4e8b\u52a1\n    return err\n  }\n\n  if err := tx.Create(&Animal{Name: \"Lion\"}).Error; err != nil {\n    return err\n  }\n\n  // \u8fd4\u56de nil \u63d0\u4ea4\u4e8b\u52a1\n  return nil\n})\n")),(0,l.yg)("h3",{id:"\u5d4c\u5957\u4e8b\u52a1"},"\u5d4c\u5957\u4e8b\u52a1"),(0,l.yg)("p",null,"GORM \u652f\u6301\u5d4c\u5957\u4e8b\u52a1\uff0c\u60a8\u53ef\u4ee5\u56de\u6eda\u8f83\u5927\u4e8b\u52a1\u5185\u6267\u884c\u7684\u4e00\u90e8\u5206\u64cd\u4f5c"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'db.Transaction(func(tx *gorm.DB) error {\n  tx.Create(&user1)\n\n  tx.Transaction(func(tx2 *gorm.DB) error {\n    tx2.Create(&user2)\n    return errors.New("rollback user2") // Rollback user2\n  })\n\n  tx.Transaction(func(tx2 *gorm.DB) error {\n    tx2.Create(&user3)\n    return nil\n  })\n\n  return nil\n})\n\n// Commit user1, user3\n')),(0,l.yg)("h3",{id:"\u624b\u52a8\u4e8b\u52a1"},"\u624b\u52a8\u4e8b\u52a1"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},"// \u5f00\u59cb\u4e8b\u52a1\ntx := db.Begin()\n\n// \u5728\u4e8b\u52a1\u4e2d\u6267\u884c\u4e00\u4e9b db \u64cd\u4f5c\uff08\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 'tx' \u800c\u4e0d\u662f 'db'\uff09\ntx.Create(...)\n\n// ...\n\n// \u9047\u5230\u9519\u8bef\u65f6\u56de\u6eda\u4e8b\u52a1\ntx.Rollback()\n\n// \u5426\u5219\uff0c\u63d0\u4ea4\u4e8b\u52a1\ntx.Commit()\n")),(0,l.yg)("p",null,"\u4e00\u4e2a\u7279\u6b8a\u7684\u793a\u4f8b"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'func CreateAnimals(db *gorm.DB) error {\n  // \u518d\u5520\u53e8\u4e00\u4e0b\uff0c\u4e8b\u52a1\u4e00\u65e6\u5f00\u59cb\uff0c\u4f60\u5c31\u5e94\u8be5\u4f7f\u7528 tx \u5904\u7406\u6570\u636e\n  tx := db.Begin()\n  defer func() {\n    if r := recover(); r != nil {\n      tx.Rollback()\n    }\n  }()\n\n  if err := tx.Error; err != nil {\n    return err\n  }\n\n  if err := tx.Create(&Animal{Name: "Giraffe"}).Error; err != nil {\n     tx.Rollback()\n     return err\n  }\n\n  if err := tx.Create(&Animal{Name: "Lion"}).Error; err != nil {\n     tx.Rollback()\n     return err\n  }\n\n  return tx.Commit().Error\n}\n')),(0,l.yg)("h3",{id:"savepointrollbackto"},"SavePoint\u3001RollbackTo"),(0,l.yg)("p",null,"GORM \u63d0\u4f9b\u4e86 ",(0,l.yg)("inlineCode",{parentName:"p"},"SavePoint"),"\u3001",(0,l.yg)("inlineCode",{parentName:"p"},"Rollbackto")," \u6765\u63d0\u4f9b\u4fdd\u5b58\u70b9\u4ee5\u53ca\u56de\u6eda\u81f3\u4fdd\u5b58\u70b9"),(0,l.yg)("pre",null,(0,l.yg)("code",{parentName:"pre",className:"language-go"},'tx := db.Begin()\ntx.Create(&user1)\n\ntx.SavePoint("sp1")\ntx.Create(&user2)\ntx.RollbackTo("sp1") // Rollback user2\n\ntx.Commit() // Commit user1\n')),(0,l.yg)("h1",{id:"\u53c2\u8003\u6587\u6863"},"\u53c2\u8003\u6587\u6863"))}m.isMDXComponent=!0},15680:(e,n,a)=>{a.d(n,{xA:()=>o,yg:()=>c});var r=a(96540);function l(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function t(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,r)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?t(Object(a),!0).forEach((function(n){l(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):t(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function g(e,n){if(null==e)return{};var a,r,l=function(e,n){if(null==e)return{};var a,r,l={},t=Object.keys(e);for(r=0;r<t.length;r++)a=t[r],n.indexOf(a)>=0||(l[a]=e[a]);return l}(e,n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);for(r=0;r<t.length;r++)a=t[r],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var u=r.createContext({}),i=function(e){var n=r.useContext(u),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},o=function(e){var n=i(e.components);return r.createElement(u.Provider,{value:n},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},p=r.forwardRef((function(e,n){var a=e.components,l=e.mdxType,t=e.originalType,u=e.parentName,o=g(e,["components","mdxType","originalType","parentName"]),d=i(a),p=l,c=d["".concat(u,".").concat(p)]||d[p]||m[p]||t;return a?r.createElement(c,s(s({ref:n},o),{},{components:a})):r.createElement(c,s({ref:n},o))}));function c(e,n){var a=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var t=a.length,s=new Array(t);s[0]=p;var g={};for(var u in n)hasOwnProperty.call(n,u)&&(g[u]=n[u]);g.originalType=e,g[d]="string"==typeof e?e:l,s[1]=g;for(var i=2;i<t;i++)s[i]=a[i];return r.createElement.apply(null,s)}return r.createElement.apply(null,a)}p.displayName="MDXCreateElement"}}]);