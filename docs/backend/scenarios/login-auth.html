<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-backend/scenarios/login-auth" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">登陆 &amp; 鉴权 | CS-Engineering</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-test-site.com/cs-engineering/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-test-site.com/cs-engineering/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-test-site.com/cs-engineering/docs/backend/scenarios/login-auth"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="登陆 &amp; 鉴权 | CS-Engineering"><meta data-rh="true" name="description" content="Cookie"><meta data-rh="true" property="og:description" content="Cookie"><link data-rh="true" rel="icon" href="/cs-engineering/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-test-site.com/cs-engineering/docs/backend/scenarios/login-auth"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/cs-engineering/docs/backend/scenarios/login-auth" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-test-site.com/cs-engineering/docs/backend/scenarios/login-auth" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/cs-engineering/blog/rss.xml" title="CS-Engineering RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cs-engineering/blog/atom.xml" title="CS-Engineering Atom Feed"><link rel="stylesheet" href="/cs-engineering/assets/css/styles.0fafe10b.css">
<link rel="preload" href="/cs-engineering/assets/js/runtime~main.d01edf41.js" as="script">
<link rel="preload" href="/cs-engineering/assets/js/main.d643dc48.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cs-engineering/"><div class="navbar__logo"><img src="/cs-engineering/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/cs-engineering/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CS-Engineering</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cs-engineering/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/cs-engineering/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zjuxlab/cs-engineering" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cs-engineering/docs/intro">摸鱼者说</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cs-engineering/docs/category/基础">基础</a><button aria-label="Toggle the collapsible sidebar category &#x27;基础&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cs-engineering/docs/category/前端">前端</a><button aria-label="Toggle the collapsible sidebar category &#x27;前端&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/cs-engineering/docs/category/后端">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cs-engineering/docs/backend/backend-intro">后端入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cs-engineering/docs/backend/backend-practice">后端入门实践</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/cs-engineering/docs/category/数据库操作">数据库操作</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据库操作&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/cs-engineering/docs/category/常见场景">常见场景</a><button aria-label="Toggle the collapsible sidebar category &#x27;常见场景&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cs-engineering/docs/backend/scenarios/api-formulation">API的制定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cs-engineering/docs/backend/scenarios/login-auth">登陆 &amp; 鉴权</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/cs-engineering/docs/category/服务端框架">服务端框架</a><button aria-label="Toggle the collapsible sidebar category &#x27;服务端框架&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cs-engineering/docs/category/工具">工具</a><button aria-label="Toggle the collapsible sidebar category &#x27;工具&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cs-engineering/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/cs-engineering/docs/category/后端"><span itemprop="name">后端</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/cs-engineering/docs/category/常见场景"><span itemprop="name">常见场景</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">登陆 &amp; 鉴权</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>登陆 &amp; 鉴权</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cookie">Cookie<a href="#cookie" class="hash-link" aria-label="Direct link to Cookie" title="Direct link to Cookie">​</a></h2><p><img loading="lazy" src="https://xn4zlkzg4p.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjg4MTI3NTU0YjNhYWU1YzM3MjQ0MTkxZjI5ODM4ZGZfVDEwUHZqVWxkaUJRM3JiR2V5enlsWHNGUTRhWXpUMFZfVG9rZW46Q2dubWJRYXRLb1B2OVd4OGFPbmNZNkg3blRlXzE2OTg0MTE2NDM6MTY5ODQxNTI0M19WNA" alt="img" class="img_ev3q"></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" target="_blank" rel="noopener noreferrer">Cookie</a> 是浏览器的一种本地储存的方式。</p><p>cookie 一般来说是较小的短文本信息，浏览器对同一 domain 下的 cookie 数量有限制，并且每条 cookie 的大小一般也被限制为 4kb。对于储存数据的需求来说，浏览器提供了 IndexDB 或者 localStorage 等等更可靠也更高效的方式，cookie 的意义更多在于共享功能，开发者只需合适地设置属性，浏览器就会自动在一定范围内共享 cookie。</p><p>关于 cookie 的各种用途，可以查看 <a href="https://xn4zlkzg4p.feishu.cn/wiki/VcK6wMLEQiOmrrkFw2ZcUeOAnFe" target="_blank" rel="noopener noreferrer">Cookie</a> 。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cookie-的属性">Cookie 的属性<a href="#cookie-的属性" class="hash-link" aria-label="Direct link to Cookie 的属性" title="Direct link to Cookie 的属性">​</a></h3><p>Cookie 在请求中以键值对的形式展现，形式为<code>&lt;name&gt;=&lt;value&gt;</code>。</p><p>但是实际上，cookie 并不只是简单的键值对，只是在请求中如此展现而已。一个很明显的特点是，cookie 是允许重名的，你可以在两个不同网站下发现 name 属性相同的 cookie。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生命周期">生命周期<a href="#生命周期" class="hash-link" aria-label="Direct link to 生命周期" title="Direct link to 生命周期">​</a></h4><p>浏览器为 cookie 提供了过期设置，浏览器会区分两类来管理 token 的生命周期：</p><p><strong>Permanent cookie：</strong></p><p>浏览器提供了 <strong>ExpiredAt</strong> 和 <strong>MaxAge</strong> 两个属性来控制 token 何时过期。前者是绝对时间的形式，后者是设置时间+offset的形式。如果两者同时被设置，浏览器以 MaxAge 为准。</p><p>MaxAge 可以设置非正数，如果这么设置，浏览器会立即删除该 cookie，请求方经常利用这点来删除 cookie。</p><p><strong>Session cookie：</strong></p><p>如果没有设置前面说的两个生命周期属性，浏览器会将其视作 session cookie，其会在整个 &quot;session&quot; 内保留，直到 &quot;session&quot; 结束后被删除。</p><p>不同浏览器对 &quot;session&quot; 的定义不一定相同，比如，如果一个浏览器定义关闭浏览器后 session 才结束，那不关闭浏览器的话，session cookie 就永远不会过期（当然这样不太安全，大多浏览器都是设置了一个最大时间）。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="访问限制">访问限制<a href="#访问限制" class="hash-link" aria-label="Direct link to 访问限制" title="Direct link to 访问限制">​</a></h4><p>Cookie 只是存在客户端本地的一段文本信息，本身十分不安全。为了提高 cookie 的安全性，浏览器限制了其访问途径。</p><p>一般来说，cookie 是通过 http 请求设置和传递的，在一个请求头中携带 Header <code>Set-Cookie</code>就能让浏览器自动设置好 cookie，已经设置过的 cookie 会被携带在<code>Cookie</code> 中发送/返回：</p><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/2.0 200 OK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: text/html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Set-Cookie: yummy_cookie=choco</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Set-Cookie: tasty_cookie=strawberry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GET /sample_page.html HTTP/2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: www.example.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cookie: yummy_cookie=choco; tasty_cookie=strawberry</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个过程中 cookie 的管理全部由浏览器完成，但是，前端也可以主动访问并设置 cookie，比如，js 可以通过 <code>document</code> 访问这个页面的 cookie:</p><div class="language-JavaScript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-JavaScript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">document.cookie=&quot;username=John Doe; expires=Thu, 18 Dec 2043 12:00:00 GMT&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>浏览器提供了 <strong>HttpOnly</strong> 属性来限制前端以这种方式访问 cookie，这样 cookie 就只能在 http 请求中携带。</p><p>虽然但是，浏览器只是限制了部分 js 访问接口，还是有很多方式能获取到 cookie 的（比如有些 php 网页就能访问到 HttpOnly 的 cookie），这个属性不代表绝对安全。</p><p><strong>Secure</strong> 属性可以限制只有使用 https 协议的请求可以携带/设置 cookie，这样可以尽可能防止 cookie 在传输过程中被泄露。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="作用范围">作用范围<a href="#作用范围" class="hash-link" aria-label="Direct link to 作用范围" title="Direct link to 作用范围">​</a></h4><p>几乎所有网页都使用了 cookie，浏览器需要区分不同网站设置的 cookie。</p><p><strong>Domain</strong> 和 <strong>Path</strong> 属性可以限制 cookie 所属的网站。浏览器只会将某条 cookie 携带在发给符合限制的网站的请求中。</p><p><strong>Domain</strong> 限制了 cookie 所属的域名。浏览器默认会匹配所有的子域名，例如设置了<code>domain=feishu.cn</code>，则所有其下的子域名，如<code>docs.feishu.cn</code>都算在内。</p><p>如果不设置 domain 属性，浏览器则会将该请求的 target 作为 domain 属性，<strong>并且不会匹配子域名</strong>，也就是说，不主动设置 domain，浏览器对 cookie 的限制反而更严格。</p><p><strong>Path</strong> 属性限制了 cookie 所属的子路径。如果不设置 path 则默认为<code>/</code>。path 无论是否主动设置，都匹配所有的子路径，比如，<code>/</code> 可以匹配如 <code>/docs</code>和<code>/</code>。</p><p>我们知道可以有 name 重复的 cookie。浏览器以 domain+path 来设置 cookie 的作用范围，在一个范围内（即 domain 和 path 字面量相同）的 name 是唯一的，但是不同的范围内可以有重名 cookie。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="csrf-和-samesite">CSRF 和 SameSite<a href="#csrf-和-samesite" class="hash-link" aria-label="Direct link to CSRF 和 SameSite" title="Direct link to CSRF 和 SameSite">​</a></h4><p>看似我们的 cookie 已经比较安全了。但实际上它存在一个致命缺陷。</p><p>当我们已经在一个网站 A.com 获取了用户的登录 cookie，此时如果网站 B.com 向 A 发送了一条请求，其符合我们之前的所有限制条件（范围限制），所以会带着该 cookie 进行请求。如果 B 利用这一点向 A 发送恶意请求，就能利用到 A 自己设置的鉴权 cookie，产生严重后果。这是 CSRF 的一种形式。</p><p>这里需要另外介绍以下 <strong>跨域</strong> 和 <strong>跨站</strong> 的区别。</p><p>站 <strong>Site</strong> 的概念一般由域名来区分。一般来说，域名服务商只售卖 xxx.xx 这样两层的 “二级域名”，再扩展的多级域名都属于二级域名的所有者。因此，我们将二级域名相同的网址称为 Same Site。</p><p>根据 <a href="https://developer.mozilla.org/en-US/docs/Glossary/Site" target="_blank" rel="noopener noreferrer">MDN </a>，有时 site 的限定除了二级域名，还要求了协议。但是在我们之后的讨论范围内，site 都只限制二级域名，不限制协议。</p><p>而域 <strong>Origin</strong> 的限制要严格的多，只有两个网址的 schema, host, port  全部相同，才能被称作同域。</p><p>一些栗子:</p><ul><li><a href="http://example.com/" target="_blank" rel="noopener noreferrer">http://example.com</a> &amp; <a href="http://qwq.example.com/" target="_blank" rel="noopener noreferrer">http://qwq.example.com</a> 同站，不同域</li><li><a href="http://qwq.example.com/" target="_blank" rel="noopener noreferrer">http://qwq.example.com</a> &amp; <a href="https://qwq.example.com/" target="_blank" rel="noopener noreferrer">https://qwq.example.com</a> 同站，不同域</li><li><a href="http://qwq.example.com/api/" target="_blank" rel="noopener noreferrer">http://qwq.example.com:80/api/</a> &amp; <a href="http://qwq.example.com" target="_blank" rel="noopener noreferrer">http://qwq.example.com</a> 同站，同域 (http默认在80)</li></ul><p>如果我们假设 “同站” 的网站一般属于同一所有者，那么基本上同站之内不会发生上述攻击，并且可能期望共享 cookie。因此，浏览器对 cookie 做了一个 site 级别的限制。</p><p><strong>SameSite</strong> 属性指定了限制的级别，有三个级别: <code>strict|lax|none</code>。</p><p>最严格的<code>strict</code>模式，任何跨站的 cookie 都不会被携带，意思是说，如果从 A.com 向 B.com 发送请求，不会携带任何 B.com 所属的 cookie。这样当然很安全，但是很不方便。例如，如果我们在文档里嵌入一个分享链接，那么用户点击这个链接跳转到相应网站时，不会携带任何 cookie。如果分享的是一个 github 链接，跳转过后用户会发现自己是未登录状态，必须重新刷新才能发送 cookie 然后刷新出登录信息。</p><p>因此，<code>lax</code>模式就是将一部分请求方式从限制中移除，其中就有<code>&lt;a&gt;</code>标签，这样跳转链接这种请求就不会因为跨站而被限制 cookie。具体开放的请求方式，可以参考<a href="https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html" target="_blank" rel="noopener noreferrer"> 这里</a>。</p><p><code>none</code>级别就是完全不进行 SameSite 限制。不过为了有最基本的安全保障，只有设置了 secure（只能通过 https 传输） 的 cookie 可以被设置为<code>SameSite=none</code>。（至于具体浏览器怎么处理没设置 secure 的请求就不一定了，比如 safari 会将这种 cookie 直接设置为<code>strict</code>）</p><p>SameSite 似乎正在从<code>none</code>改为<code>lax</code>，很可能不同浏览器的表现不一样。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cors">CORS<a href="#cors" class="hash-link" aria-label="Direct link to CORS" title="Direct link to CORS">​</a></h2><p> 浏览器内有很多内置资源，比如页面 dom, localStorage, cookie 等等等等。如果让任何网站都能访问这些资源是很危险的。</p><p>我们之前已经说明过跨站 cookie 共享可能产生的 CSRF 问题。相似的还有 XFS，这是一种因为共享 dom 产生的问题，攻击者可以用 inline frame (常见用途是页面内嵌其他网页，比如嵌一个地图) 伪造成一个其他的网页，并且访问目标网站的 dom，之后攻击者就可以监听到目标网站的几乎所有动作。如果目标网站是一个银行网站，就有可能被监听到密码之类的信息。</p><p>CORS 即是为了应对这种问题。CORS 可以限定一个请求的来源和可以访问的资源。上面说的 CSRF、XFS 等等问题，可以通过 CORS，从服务器端限制请求来源，直接拒绝来源不明的请求，从而免去大多数攻击风险。</p><blockquote><p><strong>严谨来说，是浏览器限制了跨域请求，**</strong>CORS** <strong>不是 “限制” 的规则，反而是在限制下进行 “共享” 的规则。</strong></p><p><strong>但是懒得改了，大家意会就好x</strong></p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现流程">实现流程<a href="#实现流程" class="hash-link" aria-label="Direct link to 实现流程" title="Direct link to 实现流程">​</a></h3><p>顾名思义，CORS 在 origin 级别进行限制请求，其本质上是基于请求 HEADER 的一种约定限制。</p><p>CORS 将请求分为两类，一种是 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#simple_requests" target="_blank" rel="noopener noreferrer">simple request</a>，其他都是 non-simple request。</p><p>其初衷是按照 <strong>是否有副作用 (side-effect)</strong> 来分类请求。对于有副作用的请求，我们不能将其直接发送给服务器，必须先验证这个请求是否合法，因此是 non-simple request。对于没有副作用的请求，我们将其发送给服务器也没有什么影响，所以不妨直接发送请求，返回时再验证，并将不合法的请求直接丢掉，于是叫 simple request。</p><p>我们以一个 non-simple request 来举例。在实际发送请求前，需要先发送一个 <strong>OPTION</strong> 请求作为 preflight：</p><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OPTIONS /doc HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Origin: http://example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Request-Method: POST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Request-Headers: X-PINGOTHER, Content-Type</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如上，在 OPTION 请求中会携带三个额外的 HEADER。<strong>Origin</strong> 声明了请求的发送者的域，后两者则分别指定了该请求的 Method 和 Headers。</p><p>由服务器接收到请求后，服务器在返回中设置以下字段，来告诉发送方自己接受的请求类型：</p><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Origin: *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Methods: POST, GET, OPTIONS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Credentials: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Max-Age: 86400  // 对options的缓存</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>Access-Control-Allow-Origin</code>是对域的限制，可以指定多个域，比如设置为<code>http://localhost:63342/``, http://localhost:1926</code>，表示接受两个域，也可以像上面那样设置为通配符<code>*</code>,表示接受所有域。</p><p>后两者同理是向请求方表明自己接受的 Method 和 Headers。</p><p><code>Access-Control-Allow-Credentials</code>表示服务器是否接受 cookie，如果设置为 false，之后的请求中服务器就不会携带 cookie（注意，OPTION 请求是不会带 cookie 的）。</p><p><code>Access-Control-Max-Age</code>请求表示请求方对这个 OPTION 请求的缓存时间，如果在缓存时间内，下次发送相同的 CORS 请求时，请求方可能就不会再发送一个  OPTION 请求，而是使用上一次 OPTION 请求的数据。</p><p>发送方接收到响应后，验证服务端是否能够接受实际要发送的 CORS 请求，如果不满足服务端的要求，就不再发送实际的请求。如果 preflight 请求通过了，则继续发送正式的请求，这回只用携带 Origin 就行了</p><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /cors HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Origin: http://example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Accept-Language: en-US</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection: keep-alive</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User-Agent: Mozilla/5.0...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>服务器接收到正式请求后，按照正常方式响应，但是多加了几个 Hedaer:</p><div class="language-HTTP codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-HTTP codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Origin: http://example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Allow-Credentials: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Access-Control-Expose-Headers: X-Header</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有一部分是之前 preflight 请求里出现过的，请求方会再次检查，如果有不符的地方仍然会丢弃请求。</p><p><code>Access-Control-Expose-Headers</code>的作用是告诉请求方能够接受的响应头，CORS 请求的请求方默认只能拿到响应头的一部分（详见reference），如果需要另外使用自定义的 Header，需要服务端在这个 Header 里指明，请求方才能拿到。</p><p>而对于 simple request，因为没有副作用，完全可以直接发请求，再由请求方校验，决定要不要丢弃请求即可。因此只需要进行上述流程的后两部分。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于通配符">关于通配符<a href="#关于通配符" class="hash-link" aria-label="Direct link to 关于通配符" title="Direct link to 关于通配符">​</a></h3><p>上面几乎所有的<code>Access-Control-Allow-XXX</code>字段，服务端都可以使用<code>*</code>来代表接收所有选项。</p><p>特别的，设置了<code>Access-Control-Allow-Origin: *</code>时，<code>Access-Control-Allow-Credentials</code>就不能设置为<code>true</code>，请求方会默认将此值当 false 处理。</p><p>一个实际开发中非常值得注意的点是，当因为 CORS 的配置问题导致 cookie 被吞时，请求方 (至少对 FetchAPI 来说) 不会收到任何报错，因为这是预期内行为，这可能对开发产生困扰。</p><p>另外，对于大多数限制了跨域请求的 api 来说，cookie 不仅要被服务端允许发送，还需要自己手动设置发送策略，比如，fetch API 需要使用参数<code>credentials: include</code>，XMLHttpRequest 需要设置<code>withCredentials</code>。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="具体使用">具体使用<a href="#具体使用" class="hash-link" aria-label="Direct link to 具体使用" title="Direct link to 具体使用">​</a></h3><p>在上面的流程中，不难意识到，<strong>所有的</strong> <strong>CORS</strong> <strong>限制都是由请求方来做的</strong>。服务器方只不过配置了对 OPTION 请求的响应和一些固定的 Header 字段，所有的验证都和服务端无关。如果请求方不按校验规则来，服务器是一点办法都没有。</p><p>实际上，<strong>浏览器的</strong> <strong>CORS</strong> <strong>限制是由其提供的</strong> <strong>API</strong> <strong>实现的。</strong>一般来说，我们在浏览器中使用<code>FetchAPI</code>或者<code>XMLHttpRequest</code>来发送请求，这些 API 都遵循 CORS 规则限制。</p><p>反过来说，我们其实可以通过不使用这些 API 来绕过 CORS。一个最典型的例子是微信小程序的开发，开发者往往不需要关心 CORS 设置，因为微信小程序提供的 request API 是没有实现 CORS 的，不会限制跨域请求。普通浏览器中也有许多没有 CORS 限制的请求方式，比如利用<code>&lt;script&gt;</code>块的<code>src</code>属性进行请求（据说真有利用这个特性做的 no-cors request 库，我只能说好家伙）。</p><p>另一方面，既然服务器要做的只是配置相应的 Header 字段供请求方验证，这些工作完全可以在路由部分完成。所以一般服务端的 CORS 实现就是在所有路由最外层挂一个中间件，用以设置 Header，顺便给 OPTION 请求响应 204。或者也可以用 nginx 在代理层就实现这一点。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="登录--鉴权">登录 &amp; 鉴权<a href="#登录--鉴权" class="hash-link" aria-label="Direct link to 登录 &amp; 鉴权" title="Direct link to 登录 &amp; 鉴权">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="密码学科普">密码学科普<a href="#密码学科普" class="hash-link" aria-label="Direct link to 密码学科普" title="Direct link to 密码学科普">​</a></h3><p>既然要讲登录，就不得不先提一些关于加密的常识。</p><ul><li><strong>Hash</strong>，常用算法有 SHA2，利用难以求得反函数的 Hash 函数来加密数据，不可逆</li><li><strong>对称加密</strong>，常用算法有 AES，使用一个保密的密钥，可以使用密钥对信息进行加解密</li><li><strong>非对称加密</strong>，常用算法有 RSA ed25519 等，有两个成对的密钥，分别为公钥和私钥，用其中一个密钥加密的信息，只有用另一个密钥才能解密。所以可以保存私钥，发布公钥，这样别人就能通过公钥加密信息然后发给私钥持有者，不用担心中途密钥泄露造成风险。</li><li><strong>加盐</strong>。当 Hash 的结果空间太小时，其实可以用暴力枚举的方式，生成一张 hash 函数的反函数表（被称作 rainbow table）来破解加密。所以，我们 Hash 时，一般都要在原信息中拼接一段随机信息来保证长度。这一串拼接的 byte 串就被称作 &quot;salt&quot;，这个过程也就叫做 “加盐”。</li><li><strong>签名</strong>，一种防止公开发布的消息是否被篡改的方式。常用的方法有 MAC，可以理解为一种带密码的 Hash，只有有正确密钥的人才能 Hash 出相同的值。上述的非对称加密也可以用作签名，只需反过来使用，用私钥加密，公钥解密，这样就能确认只有私钥拥有者才能发布信息。</li><li>对称+非对称混合加密。对称加密在交流时，必须要先传递密钥，但是传递密钥本身就可能不安全。非对称加密免除了密钥泄露的风险，但是根据加密信息长度增加，加密效率将指数级上升。所以我们经常使用非对称加密加密对称加密的密钥，然后用对称加密加密主要信息。这样既安全又高效。</li><li><strong>TLS</strong>。https 通过 TLS 协议保证安全性。其也是由上述的对称+非对称加密来传递信息，只不过加上了数字证书验证服务器身份的过程。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="strawman-example">Strawman Example<a href="#strawman-example" class="hash-link" aria-label="Direct link to Strawman Example" title="Direct link to Strawman Example">​</a></h3><p><img loading="lazy" src="https://xn4zlkzg4p.feishu.cn/space/api/box/stream/download/asynccode/?code=NTQzNTUwNWZhZGNjZWJmNjFkMzk1MzZhOGU2ZTE1ZWRfN3pFS1p0TE9uanF2RzVhbTNKQmxLVHlRZElOM2JHNVZfVG9rZW46VFJ0T2I3eWlzb202eFh4cUVFeGM1cWFWbjJlXzE2OTg0MTE2NDM6MTY5ODQxNTI0M19WNA" alt="img" class="img_ev3q"></p><p>如上是一个非常离谱的登录实现，我们可以以此为例想象一下登录过程可能会出现什么问题。</p><p>首先是安全问题，这样直接传递密码可能会被人中途抓包，于是会造成信息泄露，暴露用户密码。</p><p>一种最朴素的解决方法是用非对称加密来传递密码，这样就算被截获了请求，对方还是不知道密码是什么。但是问题并没有被完全解决，截获者可以不用破解密码，直接将原请求发给服务器，这种攻击方式被称为 “<strong>中间人攻击</strong>”，其根本原因是我们并没有办法验证消息发送者的身份。</p><p>使用 HTTPS 协议时，因为可以确认发送者的身份，我们就能够防止中间人攻击了。实际上，<strong>如果使用了 HTTPS，我们基本上就不用担心什么传输过程中的安全问题了。</strong></p><p>于是乎，我们从安全问题上移开视线，关注另一个问题，请求次数。上述流程中，每次需要验证权限的操作，都需要向服务端传递密码。如果每次让用户手动输入，那体验想必是极差的，但是要把用户密码在客户端缓存，又会产生额外的安全问题。另外，虽然我们保证了传输过程是比较安全的，但是要是每次请求都带有密码，请求次数一但增多，谁能保证攻击者不从中分析出有用的信息呢（参考某Enigma）。</p><p>解决此问题的方法是将权限验证分为两个过程，Login &amp; Authentication。登录被单独拿出来作为一个单独的操作，用户需要传递密码或以其他方式证明身份来登录，登录后，其他的请求则不需要用户再传递密码。为此，我们需要一些机制，能够验明其他请求的身份，如使用session、token等等。</p><p>这个 strawman example 还有一些服务端的安全漏洞。攻击者虽然无法破解 HTTPS 的安全性，但是服务端自己的数据库却不一定是绝对安全的，攻击者有可能通过注入等途径来获取到数据库内容。那么我们在数据库里直接储存用户密码就是很不安全的一件事情。</p><p>一般来说，我们存数据库时实际存的是加盐 hash 后的用户密码，每次验证时，将用户密码再按原来的方法 hash 一遍，对比验证。这样即使漏库了，也不太会泄露用户密码。</p><p>这样做还有一个好处，就是我们的数据库本身也不知道用户的实际密码。很多人有在不同应用使用同一个密码的习惯，所以他们可能不希望服务端知道他们的密码。有些密码管理器应用，甚至会在客户端传回密码前都要先进行一次加密，保证服务端从头到尾都不知道原密码是什么。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="一些常见的鉴权实现">一些常见的鉴权实现<a href="#一些常见的鉴权实现" class="hash-link" aria-label="Direct link to 一些常见的鉴权实现" title="Direct link to 一些常见的鉴权实现">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="token">Token<a href="#token" class="hash-link" aria-label="Direct link to Token" title="Direct link to Token">​</a></h4><p>Token 是最常见的一种鉴权方式，有很多鉴权规范其实都是在使用 token。</p><p>此处以 postman 中提供的预设方式为例，其实 API Key, Bearer Token, Basic Auth 都是一种 token，后面的 session 其实也是一种 token，只是具体如何生成，如何在请求中传递等等细节不同而已。</p><p><img loading="lazy" src="https://xn4zlkzg4p.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGQzNGFkMmNmOThmMWY4MDk5YmJmNjhjMjgyM2FiNzVfNElZeUkxQ0Y0SkNhMkFhUnR5dzVVSXpjYVlvOTUyRkFfVG9rZW46U2Y4WGJxcGJabzVUaHR4c1ZHdWNHb2hIbm5nXzE2OTg0MTE2NDM6MTY5ODQxNTI0M19WNA" alt="img" class="img_ev3q"></p><p>使用 token 鉴权的流程一般是这样的：用户在登录后，服务端生成一个代表其身份的令牌，这就是 token。然后服务端将这个 token 返回给客户端，之后的请求，客户端只需要携带这个 token 进行请求即可。服务端通过 token 验证用户的身份。</p><p>Token 的安全问题主要出在客户端（不会有人不用 https 吧），和之前讨论密码时一样，储存的客户端的数据不一定能保证安全。所以 token 主要是靠过期来提高安全性的，根据具体的安全性和用户体验之间的权衡，可以调整过期时间的长短。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="session">Session<a href="#session" class="hash-link" aria-label="Direct link to Session" title="Direct link to Session">​</a></h5><p>Session 是最简单的一种 token 实现。在用户登录后，服务端生成一个 sessionID 并储存起来（一般我们使用类似 uuid 的方式来生成 sessionID），然后将此 ID 返回给客户端。之后客户端就可以带着 sessionID 请求，服务端每次去 数据库/缓存 里查询这个 ID 对应的用户，就能实现鉴权了。</p><p>因为储存了每个用户登录的 session，服务端可以具体管理每个登录会话的状态。比如，当用户 A 更改了密码，服务端可以手动将所有 A 的 session 删除来实现强制注销。甚至还可以在 session 之上做登陆记录留痕等等。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="jwt">JWT<a href="#jwt" class="hash-link" aria-label="Direct link to JWT" title="Direct link to JWT">​</a></h5><p>JSON Web Token 是 token 的一种特殊实现。</p><p>Jwt 主要的特点在其 token 的生成方式上。jwt 可以在 token 中携带一些用户信息（但是不能是敏感信息，jwt 没对信息做加密），在生成时，jwt 会使用一个密钥，对整条 token 用 HMAC 做一次签名，从而防止有人篡改。</p><blockquote><p>具体的 jwt 生成方式：</p><p><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">https://jwt.io/</a></p></blockquote><p>JWT 可以将用户信息携带在 token 中，因此每次鉴权时不需要像一般的 token 一样再去查找对应的用户信息，因此鉴权的压力会小一些。而且对于某些分布式的服务，使用 session 鉴权需要另外考虑 session 数据的同步问题，而 jwt 就不需要考虑这一点。</p><p>在实践中，我们常常将权限分成不同的 scope，然后直接将用户拥有的 scope 写在 jwt 里。如此依赖，我们只需要解析 jwt 就能知道用户是否有某个 api 的权限，完全不用做查找用户数据库等操作。</p><p>因此我们常说 jwt 是 <strong>无状态 (context-less)</strong> 的。</p><p>（无状态的缺点是我们无法做到像 session 那样的强制注销操作）</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauth">Oauth<a href="#oauth" class="hash-link" aria-label="Direct link to Oauth" title="Direct link to Oauth">​</a></h4><p>Oauth2 规范是一种用于第三方授权的鉴权方式。</p><p>你可以想象为， Oauth 将鉴权逻辑完全分离，有一个专门的 “权限管理中心” 来管理权限。其将客户端和用户的角色完全分开来，由用户通过这个 “权限管理中心” 给客户端赋予权限（基本也是用 token 的方式授权的），然后客户端再去请求拥有相关资源的 API。</p><p>Oauth 的核心内容是 “如何让用户经由一个权限管理中心来赋予客户端权限”。其标准定义了<a href="https://auth0.com/docs/authenticate/protocols/oauth#grant-types" target="_blank" rel="noopener noreferrer">四种方式</a>，以适应不同的运用场景。我们这里就以 web 应用最常见的工作方式来说明。</p><p><img loading="lazy" src="https://xn4zlkzg4p.feishu.cn/space/api/box/stream/download/asynccode/?code=MzllOGI4ODM3YTI3NGQ2OWQxNDQxYzJkODc0NTAxODFfbFJnVm1MS2UyR0JHNTdSeHkxQTgzZ3cxQTJUQjNHZ1ZfVG9rZW46TEFXVGJqd3VQb2NaRjZ4V1hTbGNSN084bnhiXzE2OTg0MTE2NDM6MTY5ODQxNTI0M19WNA" alt="img" class="img_ev3q"></p><p>如上图，在这张图中有四个角色。其中，Regular Web App 就是我们的应用，而 Auth Tenant 是所谓的权限管理中心，API 则是其负责管理的资源 API。而我们的应用需要请求这些 API 获取用户能够取得的资源。</p><p>用户登录时，应用会向权限管理中心发送一个授权请求。而后，授权中心将这个请求 redirect 到其提供的授权页面用户在这个页面上登录即可（参考浙大统一认证登录，或者第三方应用的 google 登录）。</p><p>用户登录成功后，这个权限管理中心会携带着必要的授权信息，redirect 到一个我们的应用预先定好的地址上。这样授权就基本完成了。</p><p>后面的操作因具体场景而异，有的应用需要进一步去权限管理中心获取进一步的 access token，以请求资源 API （比如某些第三方应用需要获取用户的 google calendar 权限），有的应用只是利用第三方认证登录而已，只需要拿到用户 ID 等必要的用户授权信息就行了（比如某些第三方应用完全不需要获取用户 google 账号的资源，只是允许你用 google 账号登录而已），这些实现的细枝末节就不仔细讨论了。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="一些栗子">一些栗子<a href="#一些栗子" class="hash-link" aria-label="Direct link to 一些栗子" title="Direct link to 一些栗子">​</a></h5><ul><li>飞书：<a href="https://open.feishu.cn/document/client-docs/h5/development-guide/step-3" target="_blank" rel="noopener noreferrer">步骤三：免登流程（可选） - 开发指南 - 开发文档 - 飞书开放平台</a></li><li>Google：<a href="https://developers.google.com/identity/protocols/oauth2/javascript-implicit-flow?hl=zh-cn#obtainingaccesstokens" target="_blank" rel="noopener noreferrer">developers.google.com</a></li></ul><blockquote><p><strong>Refs:</strong></p><ul><li><strong><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" target="_blank" rel="noopener noreferrer">Using HTTP cookies - HTTP | MDN (mozilla.org)</a></strong></li><li><strong><a href="https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html" target="_blank" rel="noopener noreferrer">Cookie 的 SameSite 属性 - 阮一峰的网络日志 (ruanyifeng.com)</a></strong></li><li><strong><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener noreferrer">Cross-Origin Resource Sharing (CORS) - HTTP | MDN (mozilla.org)</a></strong></li><li><strong><a href="https://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener noreferrer">跨域资源共享 CORS 详解 - 阮一峰的网络日志 (ruanyifeng.com)</a></strong></li><li><strong><a href="https://auth0.com/docs/get-started/authentication-and-authorization-flow" target="_blank" rel="noopener noreferrer">Oauth Authorization Flows</a></strong></li></ul></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="扩展阅读">扩展阅读<a href="#扩展阅读" class="hash-link" aria-label="Direct link to 扩展阅读" title="Direct link to 扩展阅读">​</a></h4><p>Linux上的高级用户鉴权技术</p><p><a href="https://zhuanlan.zhihu.com/p/266491528" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/266491528</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="思考题">思考题<a href="#思考题" class="hash-link" aria-label="Direct link to 思考题" title="Direct link to 思考题">​</a></h2><p>用自己的话介绍一些典型权限攻击模式</p><ul><li>重放攻击</li><li>劫持攻击</li><li>旁路攻击</li></ul><p>通过什么样的API设计，可以应对这些攻击？</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/backend/scenarios/login-auth.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cs-engineering/docs/backend/scenarios/api-formulation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">API的制定</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cs-engineering/docs/category/服务端框架"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">服务端框架</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cookie" class="table-of-contents__link toc-highlight">Cookie</a><ul><li><a href="#cookie-的属性" class="table-of-contents__link toc-highlight">Cookie 的属性</a></li></ul></li><li><a href="#cors" class="table-of-contents__link toc-highlight">CORS</a><ul><li><a href="#实现流程" class="table-of-contents__link toc-highlight">实现流程</a></li><li><a href="#关于通配符" class="table-of-contents__link toc-highlight">关于通配符</a></li><li><a href="#具体使用" class="table-of-contents__link toc-highlight">具体使用</a></li></ul></li><li><a href="#登录--鉴权" class="table-of-contents__link toc-highlight">登录 &amp; 鉴权</a><ul><li><a href="#密码学科普" class="table-of-contents__link toc-highlight">密码学科普</a></li><li><a href="#strawman-example" class="table-of-contents__link toc-highlight">Strawman Example</a></li><li><a href="#一些常见的鉴权实现" class="table-of-contents__link toc-highlight">一些常见的鉴权实现</a></li></ul></li><li><a href="#思考题" class="table-of-contents__link toc-highlight">思考题</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cs-engineering/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cs-engineering/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zjuxlab/cs-engineering" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 浙江大学启真交叉学科创新创业实验室, Inc.</div></div></div></footer></div>
<script src="/cs-engineering/assets/js/runtime~main.d01edf41.js"></script>
<script src="/cs-engineering/assets/js/main.d643dc48.js"></script>
</body>
</html>