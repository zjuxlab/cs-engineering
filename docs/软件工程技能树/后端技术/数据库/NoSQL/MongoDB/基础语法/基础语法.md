---
title: åŸºç¡€è¯­æ³•
slug: åŸºç¡€è¯­æ³•
sidebar_position: 0
---


# åŸºç¡€è¯­æ³•

Author: Vista

## Intro

å®˜æ–¹æ–‡æ¡£ï¼š[MongoDB Documentation](https://www.mongodb.com/docs/)

MongoDB æ˜¯ç›®å‰ä½¿ç”¨æœ€å¤šçš„ NoSQL ä¹‹ä¸€ã€‚ â€œNoSQLâ€ å³ â€œNot Only SQLâ€ æˆ–è€…éå…³ç³»å‹æ•°æ®åº“ã€‚ç›¸è¾ƒäºåŒæ ·æ˜¯éå…³ç³»å‹æ•°æ®åº“çš„ Redis ç­‰ç­‰ï¼ŒMongoDB åº”è¯¥è¢«ç»†åˆ†ä¸º â€œæ–‡æ¡£æ•°æ®åº“â€ã€‚

MongoDB çš„å‚¨å­˜æ–¹å¼æ˜¯ç±»ä¼¼ json çš„é”®å€¼å¯¹æ–‡æ¡£ï¼Œä¸€ä¸ªæ–‡æ¡£å°±æ˜¯ä¸€æ¡è®°å½•ï¼Œç±»ä¼¼äºSQLä¸­çš„â€œè¡Œâ€ã€‚è€Œä¸€ä¸ªé›†åˆå°±è¯¦ç»†äºSQLä¸­çš„â€œè¡¨â€ã€‚ä¸è¿‡ï¼ŒMongoDBçš„é›†åˆå¯æ²¡æœ‰å±æ€§é™åˆ¶ï¼Œä½ å¯ä»¥å‘é›†åˆä¸­çš„æ–‡æ¡£éšä¾¿åŠ å­—æ®µï¼ŒåŒä¸€ä¸ªå­—æ®µç±»å‹ä¸ä¸€æ ·éƒ½è¡Œã€‚

ç›¸å¯¹äºä»å‚¨å­˜ä¸­å¯»æ‰¾æ•°æ®çš„ SQL ï¼ŒMongoDB ä»æ–‡æ¡£ä¸­è¯»å–æ•°æ®å½“ç„¶è¦å¿«ä¸Šä¸å°‘ã€‚åŒæ—¶ MongoDB å¯¹ACIDçš„è¦æ±‚ä¹Ÿæ²¡é‚£ä¹ˆé«˜ï¼Œæ‰€ä»¥æŸ¥è¯¢é€Ÿåº¦ååˆ†é«˜æ•ˆã€‚å…¶ç‹¬ç‰¹çš„ bson æ–‡æ¡£å½¢å¼ä¸ä½†æ–¹ä¾¿å»ºç´¢å¼•ï¼Œè¿˜èƒ½å¾ˆå¥½åœ°ç›´æ¥æ¥è½¨å„ç±»è¯­è¨€ï¼Œå…å»ä½¿ç”¨ ORMã€‚åŒæ—¶ï¼Œå…¶è‡ªå¸¦çš„å„ç§åˆ†ç‰‡ï¼Œåˆ†å¸ƒå¼éƒ¨ç½²åŠŸèƒ½ä¹Ÿä½¿å…¶æˆä¸ºå¤©ç”Ÿçš„åˆ†å¸ƒå¼ã€é«˜å¯ç”¨æ€§æ•°æ®åº“ã€‚

### Prepare

- åŒ…ç®¡ç†å™¨æˆ–è€…å®˜ç½‘ä¸‹ä¸‹æ¥å®‰è£…éƒ½è¡Œ
    - [MongoDB Community Download | MongoDB](https://www.mongodb.com/try/download/community?tck=docs_server)

- MongoDB çš„å›¾å½¢åŒ–ç•Œé¢ç¡®å®é¦™å¾—ä¸è¡Œã€‚ï¼ˆmongo compassï¼‰
- å¯¼å…¥å¯¼å‡ºæ•°æ®å¯èƒ½ä¼šç”¨åˆ°ä¸€äº›æ²¡æœ‰åŒ…å«ä¸æ˜¯è‡ªå¸¦çš„toolsã€‚(database toolsï¼‰
    - [è¿™äº›åœ¨è¿™é‡Œä¸‹è½½ï¼šMongoDB Compass Download | MongoDB](https://www.mongodb.com/try/download/tools)

- åœ¨goä¸­ä½¿ç”¨mongoéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ… mongo-driverï¼Œä»¥åŠä½¿ç”¨ go çš„ context åŒ…æ¥ç®¡ç†å…¶è¿æ¥ä¸Šä¸‹æ–‡ã€‚
- ä¹‹åçš„ä»‹ç»è™½ç„¶ä¸»è¦ä»¥ go ä¸¾ä¾‹ï¼Œä½†æ˜¯æœ‰äº›åœ°æ–¹è¿˜æ˜¯ä»‹ç»çš„åŸç”Ÿmongoæ¥å£ã€‚ä¸è¿‡ mongo-driver å’ŒåŸç”Ÿæ¥å£ç”¨èµ·æ¥å‡ ä¹æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œæ‰€ä»¥å…·ä½“ä½¿ç”¨æ—¶æœ‰ç–‘æƒ‘çœ‹çœ‹æ–‡æ¡£å°±èƒ½è§£å†³ï¼šï¼ˆä»¥åŠmongoå®˜ç½‘å…¶å®è¿˜æœ‰å…¶ä»–å„ç§è¯­è¨€çš„æ–‡æ¡£ï¼‰
    - [MongoDB Go Driver â€” Go](https://www.mongodb.com/docs/drivers/go/current/)ï¼ˆå†…å®¹éƒ½åœ¨Fundamentalsè¿™ä¸€ç« ï¼‰

## Basic

å¯¹åŸºæœ¬ä½¿ç”¨åšä¸€ä¸ªç®€å•ä»‹ç»

### ç”¨æˆ·å’Œè¿æ¥

#### æƒé™ç®¡ç†

åœ¨mongoä¸­å»ºå®Œæ•°æ®åº“årootç”¨æˆ·åœ¨æœ¬åœ°é»˜è®¤æ˜¯trustçš„ï¼Œä¸ç”¨ç™»å½•ã€‚ä½†æ˜¯è¿œç¨‹è¿æ¥å¿…é¡»è¿›è¡ŒéªŒè¯ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä¸éªŒï¼ŒæŠŠè¿œç¨‹IPæ”¹æˆtrustå°±è¡Œäº†ï¼‰ï¼ˆä»¥åŠå¿˜äº†å¯†ç å¯ä»¥æ”¹é…ç½®æ–‡ä»¶ç”¨rootç”¨æˆ·é‡æ–°è®¾xï¼‰

ç™»å½•å¿…é¡»æœ‰ç”¨æˆ·ï¼Œmongoçš„ç”¨æˆ·ç»‘å®šåœ¨æ•°æ®åº“ä¸‹ï¼Œå¹¶ä¸”åˆ†é…æœ‰ä¸€å®š`roles`ã€‚

åˆ›å»ºç”¨æˆ·ï¼Œä¿®æ”¹æƒé™ç­‰ç­‰å‘½ä»¤å¯ä»¥æŸ¥çœ‹ï¼š[Manage Users and Roles â€” MongoDB Manual](https://www.mongodb.com/docs/manual/tutorial/manage-users-and-roles/)ã€‚

å¸¸ç”¨çš„æƒé™æœ‰ï¼š

- `userAdmin`ï¼šå¯ä»¥ç®¡ç†ç›¸åº”æ•°æ®åº“çš„ç”¨æˆ·
- `clusterAdmin`ï¼šå¯ä»¥ç®¡ç†é›†ç¾¤
- `readWrite`/`read`ï¼šè¯»å†™/åªè¯»å½“å‰æ•°æ®åº“
- å‰é¢çš„roleåŠ ä¸ª`AnyDatabase`ï¼ˆé™¤äº†æ²¡æœ‰`clusterAdminAnyDatabase`ï¼‰ï¼Œå¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®åº“ï¼Œä½†æ˜¯ä»…åœ¨`admin`æ•°æ®åº“çš„ç”¨æˆ·å¯ç”¨

æˆ‘ä»¬ç”¨æ¥æµ‹è¯•çš„ç”¨æˆ·è‡³å°‘è¦æœ‰`readWrite`æƒé™

#### è¿æ¥

MongoDB çš„è¿æ¥ url æ ¼å¼æ˜¯è¿™æ ·çš„ï¼š

```
mongodb://{user}:{pwd}@{host1:port1,host2:port2...}/{table}?authSource={authSourceTable}
```

hostå¯ä»¥æœ‰å¤šä¸ªï¼Œè¿™æ˜¯ä¸ºäº†åˆ†å¸ƒå¼éƒ¨ç½²å‡†å¤‡çš„ã€‚`authSource`æ˜¯é€‰æ‹©è®¤è¯æ•°æ®åº“ï¼Œé»˜è®¤æ˜¯adminï¼Œå¦‚æœä½ çš„ç”¨æˆ·æ˜¯å…¶ä»–åº“çš„ï¼Œè¯·ä¿®æ”¹æˆç›¸åº”æ•°æ®åº“ã€‚

### ç±»å‹å’Œç»‘å®š

ä¹‹å‰ä»¥åŠæåˆ°è¿‡ï¼ŒMongoDB å¯ä»¥é€šè¿‡ bson éå¸¸æ–¹ä¾¿åœ°æ¥è½¨å„ç±»è¯­è¨€ã€‚åœ¨ go ä¸­ï¼Œè¿™ä¸»è¦å°±æ˜¯ä½¿ç”¨ mongo-driver çš„`bson`å’Œ`options`ä¸¤ä¸ªæ¨¡å—ã€‚

#### bson

mongo çš„ bson ç±»ä¼¼äº jsonï¼Œæ˜¯ä¸€ç§é”®å€¼å¯¹æ ¼å¼ï¼š

```json
{
  "_id": {
    "$oid": "62e2db2cac21442171666923"
  },
  "name": "even",
  "tp": [
      {"qwq":1},
      {"qwq":2}
  ]
}
```

è€Œåœ¨goä¸­ï¼Œbsonæ¨¡å—æä¾›äº†å››ç§ç±»å‹ï¼š

```go
import . "go.mongodb.org/mongo-driver/bson"

func main() {
    a := D{{"Key1", "Value1"}, {"Key2", "Value2"}}
        b := E{"Key3", "Value3"}
        a = append(a, b)
        c := M{"Key1": "Value1", "Key2": "Value2"}
        d := A{"A", "B"}
}
```

å…¶ä¸­ï¼Œ`bson.D`æ˜¯æœ‰åºè¡¨ç¤ºçš„é”®å€¼å¯¹ï¼Œ`bson.E`å°±æ˜¯å…¶ä¸­çš„ä¸€å¯¹é”®å€¼å¯¹ï¼Œ<b>bson.D</b><b>æ˜¯æ”¯æŒ append æ–¹æ³•çš„</b>ã€‚`bson.M`æ˜¯æ— åºçš„é”®å€¼å¯¹ï¼Œ`bson.A`å°±æ˜¯listã€‚

é™¤äº†ç”¨è¿™äº›ç±»å‹è¡¨ç¤ºbsonæ–‡æ¡£ï¼Œè¿˜å¯ä»¥ç”¨ bson tag å°†ç»“æ„ä½“ç»‘å®šæˆbsonæ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨`omitemptyï¼Œ-`ç­‰å‚æ•°ï¼Œå’Œjson tagå·®ä¸å¤ªå¤šã€‚ä¸ç»‘å®šçš„è¯é»˜è®¤æ˜¯ä»¥lowercaseå½“ä½œå­—æ®µåï¼Œå¹¶ä¸”å‚æ•°çš„<b>é¦–å­—æ¯å¿…é¡»å¤§å†™</b>æ‰èƒ½è¢«ç»‘å®šã€‚

å› ä¸ºmongoæ˜¯nosqlï¼Œéšä¾¿ä»€ä¹ˆç±»å‹éƒ½å¯ä»¥å¾€é‡Œé¢å¡ï¼Œä½†æ˜¯å¦‚æœç±»å‹ä¸å›ºå®šå°±åªèƒ½ç”¨interfaceæ¥ã€‚

```go
type myStruct struct {
    Name         string                 `bson:"name,omitempty"`
    TestName     interface{}            `bson:"test_name"`
}
```

#### ä¸€äº›ç‰¹æ®Šç±»å‹åœ¨goä¸­ä½¿ç”¨

##### ObjectID

mongoçš„ä¸»é”® `_id` é»˜è®¤æ˜¯å…¶è‡ªå¸¦çš„ObjectIDç±»å‹ï¼Œæœ¬è´¨ä¸Šè¿™æ˜¯ç”±æ—¥æœŸï¼Œæœºå™¨ç ï¼Œè¿›ç¨‹idå’Œä¸€ä¸ªéšæœºæ•°ç”Ÿæˆçš„uuidï¼Œè¿™ç§idæå¤§åœ°æ–¹ä¾¿äº†åˆ†å¸ƒå¼çš„æ•°æ®åº“ç³»ç»Ÿã€‚ï¼ˆè™½ç„¶å®é™…ç”¨æ—¶ç”¨å­—ç¬¦ä¸²æˆ–è€…å…¶ä»–ç±»å‹ç›–æ‰ä¹Ÿå®Œå…¨æ²¡å…³ç³»xï¼‰

bsonåŒ…æä¾›äº†ä¸€ä¸ªç±»å‹ä¸å…¶å¯¹åº”ï¼Œè¿˜å¯ä»¥ä»ä¸­æå–æ—¶é—´ä¿¡æ¯ï¼Œæˆ–ä¸16è¿›åˆ¶ä¸²äº’ç›¸è½¬æ¢ã€‚

```go
import (
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
)

func main {
    a := primitive.NewObjectID() //primitive.ObjectID
        b := primitive.NewObjectIDFromTimestamp(time.Now())
        fmt.Println(a.Hex(), b.Timestamp())
}
```

##### Date&Timestamp

å¯¹åº”ç±»å‹ä¸º`time.Time`ï¼Œå­˜è¿›æ•°æ®åº“çš„æ‰€æœ‰æ—¥æœŸéƒ½ä¼šè¢«è½¬æˆUTCã€‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨`int64`æˆ–è€…`string`æ¥å‚¨å­˜æ—¶é—´ã€‚

##### Undefined,Null

goä¸æ”¯æŒè¿™ä¸ªï¼Œå…¨æ˜¯0å€¼[æ³£ä¸æˆå£°]

### CRUD

å®˜æ–¹æ–‡æ¡£ï¼š[Collection Methods â€” MongoDB Manual](https://www.mongodb.com/docs/manual/reference/method/js-collection/)

MongoDBä¸»è¦ç”¨åˆ°çš„CRUDæ¥å£æœ‰8ä¸ªï¼Œå¯¹åº”æ¯ç§æ“ä½œçš„å•æ–‡æ¡£/å¤šæ–‡æ¡£æ¨¡å¼ã€‚åœ¨goçš„mongo-driverä¸­ï¼Œè¿™äº›æ–¹æ³•éƒ½ç»‘å®šäºcollectionæ¥å£ã€‚

è¿™äº›æ¥å£çš„ä¼ å…¥å‚æ•°åŸºæœ¬éƒ½æ˜¯bsonæ ¼å¼ã€‚ä¹Ÿå› æ­¤åœ¨mongoshellä¸­ä½¿ç”¨åŸç”Ÿæ¥å£å’Œåœ¨goä¸­ä½¿ç”¨mongo-driverå·®åˆ«ä¸å¤§ã€‚ä»…ä»…åŒºåˆ«äºmongo-driveréœ€è¦goçš„contextåŒ…æ¥ç®¡ç†è¿æ¥ä¸Šä¸‹æ–‡ï¼Œä»¥åŠoptionsé€‰é¡¹ç”±optionsåŒ…æä¾›ã€‚

```go
ctx := context.TODO()
filter := D{{}}
opts := options.Find().SetSkip(2)
cur,err := collection.Find(ctx,filter,opts)
```

å› ä¸ºæ¯”è¾ƒæ–¹ä¾¿ä»‹ç»å‚æ•°æ‰€ä»¥åé¢éƒ½ç›´æ¥ä»‹ç»çš„åŸç”Ÿæ¥å£x

#### Insert

##### insertOne

å°±æ˜¯æ’å…¥ä¸€ä¸ªbsonæ–‡æ¡£

```go
db.collection.insertOne(
   <document>,
   {
      writeConcern: <document>
   }
)
```

##### insertMany

æ®è¯´3.2æ‰åŠ è¿›å»ï¼Œä¹‹å‰mongoç”šè‡³æ²¡æœ‰æ‰¹é‡å†™å…¥x

```go
db.collection.insert(
   <document or array of documents>,
   {
     writeConcern: <document>,
     ordered: <boolean>                // é¡ºåºæ’å…¥ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ’å…¥å¤±è´¥ï¼Œä¹‹åçš„æ’å…¥éƒ½ä¸ä¼šè¿›è¡Œ
   }
)
```

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>ğŸ’¡</div>
<p>ä¸Šé¢è¿™ä¸ªæ¥å£åº”è¯¥èƒ½çœ‹å‡ºæ¥ï¼Œmongoçš„å¤šæ–‡æ¡£æ“ä½œæ˜¯ä¸ä¿è¯åŸå­æ€§çš„</p>
<p>å¿…é¡»ä½¿ç”¨transactionæ‰èƒ½å®ç°åŸå­æ€§</p>
</div>

#### Find

##### findOne

è¿”å›ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶æ»¡è¶³æ¡ä»¶ï¼Œæ˜¯æŒ‰ç…§æ–‡ä»¶åœ¨ç£ç›˜ä¸­çš„å‚¨å­˜é¡ºåºï¼ˆï¼Ÿæ’å…¥é¡ºåºï¼‰è¿”å›ç¬¬ä¸€ä¸ªã€‚

```go
db.coll.findOne(query, projection)
```

åœ¨goçš„mongo-driverä¸­å¹¶ä¸èƒ½ä¼ å…¥projectionçš„å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ç•™åˆ°ä»‹ç»operatoræ—¶å†è¯´ã€‚

è€Œ`query`å‚æ•°æ˜¯ä¸€ä¸ªbsonæ–‡æ¡£ï¼Œæœ‰å¦‚ä¸‹è§„åˆ™ï¼š

1. æ™®é€šå­—æ®µåçš„æƒ…å†µ

`{name:"qwq"}`è¡¨ç¤ºåŒ¹é…nameå­—æ®µä¸ºâ€œqwqâ€çš„æ–‡æ¡£ã€‚

1. Objectçš„æƒ…å†µ

å½“ä¸€ä¸ªå­—æ®µç±»å‹æ˜¯Objectæ—¶ï¼Œå¯ä»¥ç”¨`{anobject.name:"qwq"}`æ¥åŒ¹é…objectå­—æ®µçš„nameå­—æ®µä¸ºâ€œqwqâ€çš„æ–‡æ¡£ã€‚

> Objectç±»å‹çš„å­—æ®µæœ‰æ—¶ä¹Ÿè¢«ç§°ä½œåµŒå…¥æ–‡æ¡£

1. arrayçš„æƒ…å†µ

å½“ä¸€ä¸ªå­—æ®µç±»å‹ä¸ºarrayï¼Œåˆ™arrayå†…ä»»æ„ä¸€ä¸ªå…ƒç´ ä¸æ¡ä»¶åŒ¹é…éƒ½ç®—ä½œåŒ¹é…

exampleï¼š

```go
{_id:1,tags:["a","b","c"]}
{_id:2,tags:["a","c"]}
{_id:3,tags:["c","e"]}
```

`{tags:"a"}`å°†åŒ¹é…åˆ°ä¸Šé¢çš„æ‰€æœ‰æ–‡æ¡£ã€‚

1. å¤šæ¡ä»¶

å½“queryæœ‰å¤šä¸ªæ¡ä»¶æ—¶ï¼ŒåŒ¹é…æ»¡è¶³æ‰€æœ‰æ¡ä»¶çš„æ–‡æ¡£ã€‚

##### find

è¿”å›æ‰€æœ‰åŒ¹é…queryçš„æ–‡æ¡£ã€‚

```go
db.collection.find(query, projection)
```

åœ¨goä¸­è¿”å›çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ curï¼Œå¯ä»¥ä½¿ç”¨Nextæ–¹æ³•éå†ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å…¨decodeå‡ºæ¥ã€‚

```go
cur,err := coll.find(...)
// handling error

// A //
defer cur.Close()
for cur.Next() {
    cur.Decode(&a)
}
//////

// B //
// b is a list
cur.All(context.TODO(),&b)
//////
```

- find()å¯ä»¥ç”¨hint()æ–¹æ³•å¼ºè¡Œé™åˆ¶ä½¿ç”¨çš„ç´¢å¼•ï¼Œæœ‰æ—¶å¯ä»¥ç”¨å®ƒä»£æ›¿æ’åº
    - åœ¨goä¸­ä½¿ç”¨ï¼š
    ```text
ctx := context.TODO()
filter := D{{}}
// sethint å‚æ•°ä¸ºç´¢å¼•å
// mongo ä¼šå¯¹æ¯ä¸ªç´¢å¼•ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ç´¢å¼•å
// ä½†æ˜¯ä¹Ÿå¯ä»¥ç”¨ bson è¡¨ç¤ºç´¢å¼•
// å¦‚{"name":1}å°±æ˜¯nameå­—æ®µçš„é€’å¢ç´¢å¼•
opts := options.Find().SetHint(D{{"qwq",-1}})
cur,err := collection.Find(ctx,filter,opts)
```

#### Update

##### updateOne

æ›´æ–°ä¸€ä¸ªæ–‡æ¡£ï¼Œå¦‚æœæœ‰å¤šä¸ªæ–‡æ¡£ç¬¦åˆæ›´æ–°æ¡ä»¶ï¼Œæ›´æ–°ç¬¬ä¸€ä¸ªï¼ˆä¸findOneä¸åŒï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡hintå‚æ•°è®¾ç½®æ’åºï¼‰ã€‚

å½“upsertä¸ºtrueæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°filterç›¸åº”çš„æ–‡æ¡£ï¼Œç›´æ¥è¿›è¡Œinsertã€‚

`filter`å’Œfindæ¥å£çš„queryå‚æ•°ä½¿ç”¨æ–¹æ³•ç›¸åŒã€‚

```go
db.collection.updateOne(
   <filter>,
   <update>,
   {
     upsert: <boolean>,
     collation: <document>,
     writeConcern: <document>,
     arrayFilters: [ <filterdocument1>, ... ],
     hint:  <document|string>        // Available starting in MongoDB 4.2.1
   }
)
```

`update`å‚æ•°ä½¿ç”¨åˆ°äº†operatorï¼Œæœ€åŸºæœ¬çš„operatoræ˜¯`$set`ï¼Œå¯ä»¥å°†æ›´æ–°æŒ‡å®šå­—æ®µï¼Œä¹Ÿå¯ä»¥å¢åŠ æ–°çš„å­—æ®µã€‚

```go
{
    "$set":{
        "name":"qwq",
        "comment":"www"
    }
}
```

è¿™ä¸ªbsonæ–‡æ¡£ä½œä¸ºupdateå‚æ•°ï¼Œå¯ä»¥å°†åŒ¹é…çš„æ–‡æ¡£çš„nameå’Œcommentå­—æ®µæ›´æ–°ã€‚

æ›´è¯¦ç»†çš„ç”¨æ³•è¯·å‚è€ƒ<b>update operator</b>ã€‚

##### updateMany

å’ŒupdateOneåŸºæœ¬ç›¸åŒï¼Œä½†æ˜¯æ›´æ–°æ‰€æœ‰ç¬¦åˆfilterçš„æ–‡æ¡£

```go
db.collection.updateOne(
   <filter>,
   <update>,
   {
     upsert: <boolean>,
     collation: <document>,
     writeConcern: <document>,
     arrayFilters: [ <filterdocument1>, ... ],
     hint:  <document|string>        // Available starting in MongoDB 4.2.1
   }
)
```

#### Delete

æ²¡æœ‰ä»€ä¹ˆæ–°çš„å‚æ•°ï¼Œå°±ä¸å¤šä»‹ç»ã€‚

##### deleteOne

```go
db.collection.deleteOne(
   <filter>,
   {
      writeConcern: <document>,
      collation: <document>,
      hint: <document|string>        // Available starting in MongoDB 4.4
   }
)
```

##### deleteMany

```go
db.collection.deleteMany(
   <filter>,
   {
      writeConcern: <document>,
      collation: <document>
   }
)
```

### Index

##### crateIndex

```go
db.collection.createIndex(
  {
      key1: 1,        // ä½¿ç”¨ key: 1or-1 æ¥è¡¨ç¤º key ä¸Šçš„é€’å¢/é€’å‡ç´¢å¼•
      key2: 1        // å¦‚æœåƒè¿™æ ·æœ‰ä¸¤ä¸ªä»¥ä¸Šå­—æ®µï¼Œåˆ™å»ºç«‹å¤åˆç´¢å¼•
  },
  {
      unique: true,                // å”¯ä¸€ç´¢å¼•
      sparse: true,                // ç¨€ç–ç´¢å¼•ï¼Œä»…å¯¹æœ‰æŒ‡å®šå­—æ®µçš„æ–‡æ¡£å»ºç«‹ç´¢å¼•
  }
)
```

##### dropIndex

åˆ é™¤ç´¢å¼•

```go
db.collection.dropIndex(indexname)
```

##### getIndexes

è·å–é›†åˆçš„æ‰€æœ‰ç´¢å¼•ä¿¡æ¯

```go
db.collection.getIndexes()
```

### å…³äºåŸå­æ€§å’Œéš”ç¦»ç­‰çº§

ä¹‹å‰æˆ‘ä»¬æè¿‡ï¼Œmongoçš„å¤šæ–‡ä»¶æ“ä½œå¹¶ä¸æ»¡è¶³åŸå­æ€§ï¼Œæˆ‘ä»¬å¯ä»¥äº²æ‰‹å°è¯•ä¸€ä¸‹ï¼š

æˆ‘ä»¬å‘è¡¨ä¸­æ’å…¥1e7ä¸ªæ–‡æ¡£ï¼Œtpå­—æ®µæ˜¯0~1e7-1ã€‚ç„¶åæˆ‘ä»¬ç”¨update1å°†æ‰€æœ‰çš„å¶æ•°æ–‡æ¡£nameæ”¹æˆevenï¼Œupdate2å°†æ‰€æœ‰æ–‡æ¡£æ”¹æˆnumberã€‚

```go
func insertMany() {
        var list []interface{}
        for i := 0; i < 10000000; i++ {
                list = append(list, D{
                        {"name", "qwq"},
                        {"tp", i},
                })
        }
        _, err := testColl.InsertMany(context.TODO(), list)
        if err != nil {
                logrus.Error(err)
        }
}

func update1() {
        ctx := context.TODO()
        filter := D{{"tp", D{{"$mod", A{2, 0}}}}}
        update := D{{"$set", D{{"name", "even"}}}}
        _, err := testColl.UpdateMany(ctx, filter, update)
        if err != nil {
                logrus.Error(err)
        }
}

func update2() {
        ctx := context.TODO()
        filter := D{{}}
        update := D{{"$set", D{{"name", "number"}}}}
        _, err := testColl.UpdateMany(ctx, filter, update)
        if err != nil {
                logrus.Error(err)
        }
}

func main() {
    insertMany()
    
        go update2()
        go update1()
    time.Sleep(time.Minute)
}

//db.test.find({"name":"even"}).count()
//1209
//db.test.find({"name":"number"}).count()
//9998791
```

æˆ‘ä»¬å¯ä»¥çŒœæµ‹ï¼Œè™½ç„¶update1è¯·æ±‚å‘èµ·æ¯”è¾ƒæ™šï¼Œä½†æ˜¯æ”¹åŠ¨é¡¹å°‘ï¼Œå¾ˆå¿«è¿½ä¸Šäº†update2ï¼Œç„¶åupdate2æŠŠupdate1æ”¹å®Œçš„nameåˆç›–äº†ä¸€éï¼Œæ‰é€ æˆäº†è¿™ä¸ªç»“æœã€‚

è¿™å¯ä»¥ä½“ç°ä¸¤ä¸ªé—®é¢˜ï¼š1.mongoçš„é»˜è®¤éš”ç¦»ç­‰çº§æ˜¯read-committed 2.mongoçš„å¤šæ–‡ä»¶æ“ä½œæ²¡æœ‰åŸå­æ€§

å¯¹äºéš”ç¦»ç­‰çº§çš„é—®é¢˜ï¼Œä¹‹å‰çš„crudæ¥å£é‡Œæœ‰ä¸€ä¸ª`writeConcern`å‚æ•°å¯ä»¥è®¾ç½®ï¼Œè¿™éƒ¨åˆ†ç”¨åˆ°çš„ä¸å¤šæ‰€ä»¥ä¸å¤šèµ˜è¿°ã€‚

è€Œå¤šæ–‡æ¡£æ“ä½œçš„åŸå­æ€§å¯ä»¥ç”¨äº‹åŠ¡æ¥è§£å†³ï¼Œè¿™ä¸ªå°†åœ¨ä¹‹åæåˆ°ã€‚

## Operator&Aggregate

MongoDB æä¾›äº†ä¸€å †æ“ä½œç¬¦ã€‚æ“ä½œç¬¦æœ‰ç‚¹ç±»ä¼¼äºå†™åœ¨bsonä¸­çš„å‡½æ•°ï¼Œæ€»ä½“å¯ä»¥åˆ†ä¸ºå››ç±»ï¼Œè¿™é‡Œä»‹ç»ä¸€äº›å¸¸ç”¨çš„æˆ–è¾ƒç‰¹æ®Šçš„ï¼Œæ›´å¤šå¯ä»¥å‚è€ƒï¼š[Operators â€” MongoDB Manual](https://www.mongodb.com/docs/manual/reference/operator/)

### Query Operator

#### $gt

queryï¼ˆæˆ–è€…filterï¼‰çš„é»˜è®¤è§„åˆ™ä»¥åŠåœ¨å…ˆå‰ä»‹ç»è¿‡ï¼Œè¿™ç§è§„åˆ™å…¶å®æ˜¯æ“ä½œç¬¦`$eq`çš„ç®€å†™ã€‚é™¤äº†`$eq`å¤–ï¼Œmongoè¿˜æœ‰å¾ˆå¤šæ¯”è¾ƒæ“ä½œç¬¦ï¼Œæ¯”å¦‚`$gt`ï¼š

```go
{ field: { $gt: 20 } }
```

æ¯”è¾ƒæ“ä½œç¬¦ä¸ä»…æ”¯æŒnumericçš„æ•°æ®ç±»å‹ï¼Œstringï¼Œdateç­‰ç­‰éƒ½å¯ä»¥è¿›è¡Œæ¯”è¾ƒã€‚

#### $in

å’Œsqlçš„inååˆ†ç›¸ä¼¼ï¼ŒåŒ¹é…å­—æ®µå€¼ä¸ºåˆ—è¡¨ä¸­ä»»æ„ä¸€ä¸ªå€¼çš„æ–‡æ¡£

```go
{ field: { $in: [<value1>, <value2>, ... <valueN> ] } }
```

#### $expr

å¯ä»¥ç”¨operatorè¡¨è¾¾å¼æ¥åŒ¹é…æ–‡æ¡£ï¼ˆåªèƒ½ä½¿ç”¨ `$eq`, `$lt`, `$lte`, `$gt`ï¼Œ`$gte`è¡¨è¾¾å¼ï¼‰ï¼š

```go
{ $expr: { $gt: [ "$spent" , "$budget" ] } }
```

è¡¨ç¤ºåŒ¹é…spentå­—æ®µå¤§äºbudgetå­—æ®µçš„æ–‡æ¡£ã€‚

#### $elemMatch

å¯¹arrayå†…å…ƒç´ è¿›è¡Œæ¡ä»¶åŒ¹é…ï¼š

```go
{ arrayfield: { $elemMatch: { $gte: 80, $lt: 85 } } }
```

å•æ¡ä»¶çš„$elemMatchå¯ä»¥çœç•¥ï¼Œå½¢å¼å’Œæ•°ç»„çš„é»˜è®¤åŒ¹é…è§„åˆ™ä¸€æ ·ã€‚

### Projection Operator

å’Œsqlçš„projectionæ„æ€å·®ä¸å¤šï¼Œprojection operatorå¯ä»¥å¯¹æŸ¥è¯¢æ‰€å¾—çš„æ–‡æ¡£è¿›è¡Œä¸€äº›å­—æ®µè°ƒæ•´ã€‚

åœ¨mongoåŸç”Ÿæ¥å£ä¸­ï¼Œfindæ“ä½œæœ¬æ¥å°±æœ‰projectå‚æ•°ï¼Œä½†æ˜¯goåªèƒ½é€šè¿‡optionsåŒ…æ¥è®¾ç½®findæ¥å£çš„projectï¼Œæˆ–è€…åœ¨aggregateä¸­ä½¿ç”¨å®ƒã€‚

#### $

projectioné€šè¿‡ç‰¹æ®Šçš„bsonæ ¼å¼ç¡®å®šè¿”å›å“ªäº›å­—æ®µ

`{name:1}` è¡¨ç¤ºè¿”å›nameå­—æ®µï¼Œ`{name:0}` è¡¨ç¤ºä¸è¿”å›nameå­—æ®µã€‚ä¸€èˆ¬æ¥è¯´ä¸¤è€…ä¸æ··ç”¨ï¼Œå½“ä½¿ç”¨ 0 æ—¶ï¼Œé»˜è®¤å…¶ä»–å­—æ®µéƒ½è¿”å›ï¼Œä½¿ç”¨ 1 æ—¶ï¼Œé»˜è®¤å…¶ä»–å­—æ®µéƒ½ä¸åæ‚”ã€‚

ä½†æ˜¯é»˜è®¤æƒ…å†µ`_id`æ˜¯ä¸€å®šè¿”å›çš„ï¼Œå¦‚æœæƒ³è¦åªè¿”å›nameå­—æ®µï¼Œè¯·ä½¿ç”¨`{_id:0,name:1}`ï¼ˆåº”è¯¥æ˜¯å”¯ä¸€çš„æ··ç”¨æƒ…å†µï¼‰ã€‚

å½“åœ¨findæ¥å£ä¸­ä½¿ç”¨projectionæ—¶ï¼Œå¦‚æœå¯¹ä¸€ä¸ªarrayç±»å‹çš„å­—æ®µè¿›è¡Œäº†åŒ¹é…ï¼Œå¯ä»¥ç”¨`"{arrayfield.$":true}`ä½¿å…¶è¿”å›ç¬¦åˆarrayåŒ¹é…çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚

å¦‚ï¼š

```go
coll.insert({_id:1,name:"qwq",subs:[1,2,3,4]})

coll.find({subs:{$gt:2}},{"subs.$":1})
// {_id:1,name:"qwq",subs:[3]}
```

#### $elemMatch

å’Œ`$`å·®ä¸å¤šï¼Œåªä¸è¿‡å°†åŒ¹é…æ“ä½œä»filteré‡Œç§»åˆ°äº†projecté‡Œ

```go
coll.insert({_id:1,name:"qwq",subs:[1,2,3,4]})

coll.find({},{subs:{$elemMatch{$gt:2}})
// {_id:1,name:"qwq",subs:[3]}
```

### Update Operator

#### $set

åœ¨ä¹‹å‰å·²ç»æè¿‡ç®€å•çš„ç”¨æ³•ã€‚å¯¹äºtoplevelçš„å­—æ®µï¼Œåªéœ€ç›´æ¥è®¾ç½®ã€‚

å¯¹äºåµŒå…¥çš„æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨`{$set:{"subdoc.name":"qwq"}}` è¿›è¡Œupdateã€‚

å¯¹äºæ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨`{$set:{"subs.1":"qwq"}}`æ¥æ›´æ–°æŒ‡å®šä½ç½®çš„å…ƒç´ ã€‚ä½¿ç”¨`{$set:{"subs.$[]":"qwq"}}`æ›´æ–°æ‰€æœ‰å…ƒç´ ã€‚

æˆ–è€…åƒprojectä¸€æ ·ï¼Œå¦‚æœfilteré‡Œæœ‰é’ˆå¯¹æ•°ç»„çš„æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨`{$set:{"subs.$":"qwq"}}`æ¥updateç¬¦åˆåŒ¹é…çš„å…ƒç´ ã€‚

#### $[&lt;identifier&gt;]

updateæ¥å£é‡Œæœ‰ä¸€ä¸ªå‚æ•°`arrayFilters`ï¼Œå¯ä»¥åœ¨è¿™ä¸ªå‚æ•°å†…å®šä¹‰ä¸€ä¸ªfilterï¼Œç„¶åé€šè¿‡`$[<filter>]`è°ƒç”¨ï¼Œä»è€Œæ›´æ–°æŒ‡å®šçš„æ•°ç»„å…ƒç´ ã€‚

æ¯”å¦‚ï¼š

```go
db.coll.insertMany( [
   {
      "_id" : 1,
      "grades" : [
         { "grade" : 80, "mean" : 75, "std" : 6 },
         { "grade" : 85, "mean" : 100, "std" : 4 },
         { "grade" : 85, "mean" : 100, "std" : 6 }
      ]
   },
   {
      "_id" : 2,
      "grades" : [
         { "grade" : 90, "mean" : 100, "std" : 6 },
         { "grade" : 87, "mean" : 100, "std" : 3 },
         { "grade" : 85, "mean" : 100, "std" : 4 }
      ]
   }
] )

db.coll.updateMany(
   { },
   { $inc: { "grades.$[elem].std" : -1 } },
   { arrayFilters: [ { "elem.grade": { $gte: 80 }, "elem.std": { $gt: 5 } } ] }
)

/* result:
{  "_id" : 1,
   "grades" : [
      { "grade" : 80, "mean" : 75, "std" : 5 },
      { "grade" : 85, "mean" : 100, "std" : 4 },
      { "grade" : 85, "mean" : 100, "std" : 5 }
   ]
}
{
   "_id" : 2,
   "grades" : [
      { "grade" : 90, "mean" : 100, "std" : 5 },
      { "grade" : 87, "mean" : 100, "std" : 3 },
      { "grade" : 85, "mean" : 100, "std" : 4 }
   ]
}
*/
```

#### $addToSet

ä½¿ç”¨`$addToSet`å¯ä»¥å‘arrayå­—æ®µä¸­æ·»åŠ å…ƒç´ ï¼Œä½†å½“æ·»åŠ çš„å…ƒç´ å·²ç»åœ¨arrayå†…å­˜åœ¨ï¼Œå°†ä¸åšä»»ä½•æ“ä½œã€‚

è¦æ·»åŠ å¤šä¸ªå…ƒç´ ï¼Œå¯ä»¥é€šè¿‡`$each`æ¥éå†æ•°ç»„ï¼š

```
{ $addToSet: { arrayfield: { $each: [1,2,3,4,5] } } }
```

å’Œ`$addToSet`ç›¸ä¼¼çš„è¿˜æœ‰`$pop`,`$pull`,`$push`ç­‰operatorã€‚

### Aggregation

èšåˆæ˜¯mongoæœ€å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ã€‚èšåˆçš„æ¥å£å¦‚ä¸‹ï¼š

```go
db.coll.aggregate(pipeline, options)
```

å…¶ä¸­ï¼Œpipelineæ˜¯ä¸€ç³»åˆ—æ“ä½œï¼Œèšåˆå°†æ–‡æ¡£ä¾æ¬¡è¿›è¡Œä¸€å®šæ“ä½œç„¶åè¿”å›ï¼ˆè¿”å›çš„æ˜¯æ–‡æ¡£æŒ‡é’ˆï¼‰ã€‚

ä¹‹å‰çš„filterå’Œprojectéƒ½å¯ä»¥æ”¾åœ¨èšåˆä¸­ï¼Œåªéœ€åœ¨åŸæ¥çš„bsonå‰åŠ ä¸Š`$filter`å’Œ`$project`æ³¨æ˜è¯¥èšåˆæ“ä½œçš„stageã€‚åœ¨updateä¸­è®²åˆ°çš„`$set`ä¹Ÿå¯ä»¥ä½œä¸ºèšåˆçš„stageï¼Œä¸è¿‡æ­¤æ—¶å°±ä¸æ˜¯æ›´æ”¹æ•°æ®åº“ä¸­çš„æ–‡æ¡£ï¼Œè€Œæ˜¯ä¿®æ”¹é€šè¿‡pipelineä¼ å…¥çš„æ–‡æ¡£ã€‚

ä¸€ä¸ªç®€å•çš„èšåˆçš„ä¾‹å­ï¼š

```go
db.coll.insertMany([
    {_id:1,name:"qwq",num:1},
    {_id:2,name:"qwq",num:3},
    {_id:3,name:"qaq",num:2},
    {_id:4,name:"www",num:5},
])

db.coll.aggregate([
    {$match:{name:"qwq"}},
    {$set:{num:0}},
    {$project:{_id:0}}
])


/* result
{name:"qwq",num:0}
{name:"qwq",num:0}
*/
```

#### $project

å¤§ä½“å’Œä¹‹å‰çš„projectä¸€æ ·ï¼Œä½†æ˜¯èšåˆä¸­çš„projectå¯ä»¥åƒsetä¸€æ ·æ·»åŠ å­—æ®µå’Œè¦†ç›–å­—æ®µã€‚

#### $unwind

unwindå¯ä»¥å°†å¸¦æœ‰arrayå­—æ®µçš„æ–‡æ¡£åˆ†ç¦»ï¼š

```go
db.coll.insertOne(
    { "_id" : 1, "item" : "ABC1", sizes: [ "S", "M", "L"] }
)

db.coll.aggregate( [ { $unwind : "$sizes" } ] )

/* result
{ "_id" : 1, "item" : "ABC1", "sizes" : "S" }
{ "_id" : 1, "item" : "ABC1", "sizes" : "M" }
{ "_id" : 1, "item" : "ABC1", "sizes" : "L" }
*/
```

å› ä¸ºå…¶å°†åŸæ¥çš„arrayå­—æ®µå±•æˆäº†éarrayå­—æ®µï¼Œæ‰€ä»¥åœ¨goä¹‹ç±»çš„é™æ€ç±»å‹è¯­è¨€ä¸­ä¼šéå¸¸ä¸æ–¹ä¾¿ã€‚æ‰€ä»¥ä¸€èˆ¬unwindè¦é…åˆå…¶ä»–operatorã€‚

#### $group

å’Œsqlçš„groupä¹Ÿå¾ˆåƒï¼Œgroupæ ¼å¼å¦‚ä¸‹ï¼š

```go
{$group: {
    _id: <identifier>,
    <field>: <accumulator:value>
    ...
}}
```

å…¶ä¸­ï¼Œ`_id`æ˜¯åˆ†ç»„æ¡ä»¶ï¼Œå…¶å¯ä»¥æ˜¯åŸæ¥æ–‡æ¡£çš„å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯åŒ…å«åŸæ–‡æ¡£å±æ€§çš„operatorè¡¨è¾¾å¼ã€‚

ä¹‹åçš„å­—æ®µå¯ä»¥è‡ªè¡Œè®¾ç½®ï¼Œaccumulatoræ˜¯ç»Ÿè®¡æ“ä½œç¬¦ï¼Œå¯ç”¨çš„æ“ä½œç¬¦åœ¨æ–‡æ¡£é‡Œæœ‰åˆ—å‡ºï¼š[$group (aggregation) â€” MongoDB Manual](https://www.mongodb.com/docs/manual/reference/operator/aggregation/group/)

#### $replaceRoot

`$replaceRoot`æ˜¯ä¸€ç§æ›´åŠ å½»åº•çš„æ”¹å˜æ–‡æ¡£ç»“æ„çš„æ–¹æ³•ã€‚

å…¶å¯ä»¥å°†ç°æœ‰æ–‡æ¡£å®Œå…¨æ›¿æ¢ä¸ºä¸€ä¸ªæ–°æ–‡æ¡£ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨æ³•å°±æ˜¯åœ¨unwindä¹‹åï¼Œç”¨unwindçš„arrayçš„ç»“æ„ä»£æ›¿åŸæ–‡æ¡£ï¼š

```go
db.coll.insertOne(
    { _id : 1, sizes: [ {name:"qwq"}, {name:"qaq"}]}
)

db.coll.aggregate( [ 
    { $unwind : "$sizes" },
    { $replaceRoot: {newRoot:"$sizes"}}
] )

/* result
{ name: 'qwq' }
{ name: 'qaq' }
*/
```

ä½†æ˜¯ï¼Œå½“newRootå†…ä¸æ˜¯ä¸€ä¸ªæ–‡æ¡£æ—¶ï¼Œreplaceä¼šæŠ¥é”™ã€‚è¿™æ ·å½“æœ‰ä¸€ä¸ªæ–‡æ¡£æ²¡æœ‰è¯¥å­—æ®µï¼Œå°±æ— æ³•replaceæˆåŠŸã€‚

æˆ‘ä»¬å¯ä»¥ç”¨`$mergeObject`æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒmergeObjectå°†æ–‡æ¡£ä»å‰å‘åmergeï¼Œå¦‚æœæœ‰ç›¸åŒçš„å­—æ®µï¼Œåˆ™ä¿ç•™æœ€åä¸€ä¸ªå€¼ã€‚

```go
{ $replaceRoot: {newRoot: {$mergeObject: [ {name:''}, "$sizes" ] } }}
```

è¿™ä¸ªæ–¹æ³•åŒæ ·å¯ä»¥ç”¨æ¥æ ¼å¼åŒ–æ–‡æ¡£ï¼š

```go
db.coll.insertMany([
    { _id : 1, name: "qwq"},
    { _id : 2, time: "2002-12-31"},
    { _id : 3, comment: "www"}
])

// $$ROOT ä»£è¡¨åŸæ¥çš„æ–‡æ¡£
db.coll.aggregate( [ 
    { $replaceRoot: {newRoot: { $mergeObjects : [ {_id:"$_id",name:"",time:"1926-08-17",comment:"null"} ,"$$ROOT"] } }}
] )

/* result
{ _id: 1, name: 'qwq', time: '1926-08-17', comment: 'null' }
{ _id: 2, name: '', time: '2002-12-31', comment: 'null' }
{ _id: 3, name: '', time: '1926-08-17', comment: 'www' }
*/
```

#### $lookup

lookupçš„ä½œç”¨å°±æ˜¯è”è¡¨æŸ¥è¯¢ï¼Œå½¢å¼å¦‚ä¸‹ï¼š

```go
{
   $lookup:
     {
       from: <collection to join>,
       localField: <field from the input documents>,
       foreignField: <field from the documents of the "from" collection>,
       as: <output array field>
     }
}
```

fromå‚æ•°æ˜¯è”æŸ¥çš„è¡¨ï¼ŒlocalFieldæ˜¯æœ¬è¡¨ä¸­çš„â€å¤–é”®â€œï¼Œè€ŒforeignFieldæ˜¯å¯¹äºçš„å…¶ä»–è¡¨çš„é”®ã€‚

è¿™ä¸ªæ“ä½œä¼šå°†æ‰€æœ‰è”æŸ¥å‡ºçš„æ–‡æ¡£åŠ åˆ° as æŒ‡å®šçš„å­—æ®µä¸­ã€‚

```go
db.orders.insertMany( [
   { "_id" : 1, "item" : "almonds", "price" : 12, "quantity" : 2 },
   { "_id" : 2, "item" : "pecans", "price" : 20, "quantity" : 1 },
   { "_id" : 3  }
] )

db.inventory.insertMany( [
   { "_id" : 1, "sku" : "almonds", "description": "product 1", "instock" : 120 },
   { "_id" : 2, "sku" : "bread", "description": "product 2", "instock" : 80 },
   { "_id" : 3, "sku" : "cashews", "description": "product 3", "instock" : 60 },
   { "_id" : 4, "sku" : "pecans", "description": "product 4", "instock" : 70 },
   { "_id" : 5, "sku": null, "description": "Incomplete" },
   { "_id" : 6 }
] )


db.orders.aggregate( [
   {
     $lookup:
       {
         from: "inventory",
         localField: "item",
         foreignField: "sku",
         as: "inventory_docs"
       }
  }
] )

/* result
{
   "_id" : 1,
   "item" : "almonds",
   "price" : 12,
   "quantity" : 2,
   "inventory_docs" : [
      { "_id" : 1, "sku" : "almonds", "description" : "product 1", "instock" : 120 }
   ]
}
{
   "_id" : 2,
   "item" : "pecans",
   "price" : 20,
   "quantity" : 1,
   "inventory_docs" : [
      { "_id" : 4, "sku" : "pecans", "description" : "product 4", "instock" : 70 }
   ]
}
{
   "_id" : 3,
   "inventory_docs" : [
      { "_id" : 5, "sku" : null, "description" : "Incomplete" },
      { "_id" : 6 }
   ]
}
*/
```

## å…¶ä»–

å…³äºmongoçš„åˆ†å¸ƒå¼éƒ¨ç½²å’Œäº‹åŠ¡ï¼Œå› ä¸ºä¹‹å‰å·²ç»å†™è¿‡äº†å°±ç›´æ¥è´´é“¾æ¥

[MongoDB çš„ä¸€äº›ç¥å¥‡æ“ä½œ Â· è¯­é›€ (yuque.com)](https://www.yuque.com/thorn-bm1ef/cfethq/dcgolx)

ä½†æ˜¯ç›®å‰mongoçš„å‡ ä¸ªæ¥å£éƒ½éœ€è¦ç”±clientæ¥startsessionï¼Œè€Œä¸”sessionæ”¾ç€ä¸ç®¡è¿˜ä¼šè¿‡æœŸï¼Œè¿™å°±æ„å‘³ç€è¦æŠŠclientä»dbé‡Œæš´éœ²å‡ºæ¥â€¦â€¦

æ€»ä¹‹æˆ‘ç›®å‰æ²¡æ‰¾åˆ°ä¼˜é›…çš„åšæ³•x

## è€ƒæ ¸ä»»åŠ¡

MongoDBä¸ç®¡æ€ä¹ˆè¯´éƒ½æ˜¯NoSQLï¼Œè¿™å°±ä½¿å¾—Mongoçš„è”è¡¨æŸ¥è¯¢æ²¡æœ‰é‚£ä¹ˆæ„‰å¿«ã€‚

æ¯”å¦‚è¯´æˆ‘ä»¬æ‰‹ä¸Šæœ‰ä¸¤å¼ è¡¨ï¼š

```go
db.students.insertMany([
    {name:"Vista",stu_id:"3210100000",classes:["nginx","mongo"]},
    {name:"BlueCat",stu_id:"3210100001",classes:["math","nginx","ts"]}
])

db.classes.insertMany([
    {class:"math",credit:5},
    {class:"mongo",credit:3},
    {class:"nginx",credit:6},
    {class:"ts",credit:4}
])
```

ç°åœ¨æˆ‘ä»¬å¸Œæœ›ä½ å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡å­¦å·æŸ¥è¯¢ä¸€ä¸ªå­¦ç”Ÿé€‰çš„æ‰€æœ‰è¯¾ã€‚æˆ‘ä»¬å¸Œæœ›ä½ çš„å‡½æ•°ä»¥`[]Info`æ ¼å¼è¿”å›æ”¹å­¦ç”Ÿæ‰€æœ‰é€‰è¯¾ä¿¡æ¯ã€‚

```go
type Info struct {
    Name        string         `bson:"name"`
    Class       string         `bson:"class"`
    Credit      int            `bson:"credit"`        
}
```

è¦æ±‚ï¼š

1. è¯·ä»…å‘æ•°æ®åº“å‘é€ä¸€æ¬¡è¯·æ±‚ï¼ˆå°±æ˜¯è®©ä½ ç”¨aggregateï¼‰
2. æœ€å¥½ä»…ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ç»“æ„ä½“ç»“æŸæˆ˜æ–—
3. å»ºè®®ç”¨go

mongoè”è¡¨æŸ¥è¯¢ç®€ç›´å¤ªéº»çƒ¦äº†ï¼Œè¿™é‡Œæœ‰äº›å¤„ç†å»ºè®®ï¼ˆå½“ç„¶è¿™ä¸ªè€ƒæ ¸å°±æ˜¯åœ¨éº»çƒ¦ä½ ä»¬ï¼ˆåˆ«æ‰“æˆ‘xï¼‰ï¼‰ï¼š[NoSQL - Wikipedia](https://en.wikipedia.org/wiki/NoSQL#Handling_relational_data)

# æ€è€ƒé¢˜

- å“ªäº›æ“ä½œæ˜¯åŸå­æ€§çš„ï¼Ÿ
- Mongoæ”¯æŒäº‹åŠ¡å’Œéš”ç¦»å—ï¼Ÿå¦‚ä½•ä½¿ç”¨ï¼Ÿåº•å±‚åŸç†å’ŒSQLä¸€æ ·å—
- å¦‚ä½•å®ç°è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½ï¼Ÿ

