---
title: å­—ç¬¦è®¾å¤‡
slug: å­—ç¬¦è®¾å¤‡
sidebar_position: 0
---


# å­—ç¬¦è®¾å¤‡

Authorï¼šé©¬å¯¿ç¥¥

# ä»€ä¹ˆæ˜¯å­—ç¬¦è®¾å¤‡

> å­—ç¬¦è®¾å¤‡æ˜¯æŒ‡åœ¨I/Oä¼ è¾“è¿‡ç¨‹ä¸­`ä»¥å­—ç¬¦ä¸ºå•ä½`è¿›è¡Œä¼ è¾“çš„è®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ï¼Œæ‰“å°æœºç­‰ã€‚åœ¨UNIXç³»ç»Ÿä¸­ï¼Œå­—ç¬¦è®¾å¤‡ä»¥ç‰¹åˆ«æ–‡ä»¶æ–¹å¼åœ¨æ–‡ä»¶ç›®å½•æ ‘ä¸­å æ®ä½ç½®å¹¶æ‹¥æœ‰ç›¸åº”çš„ç»“ç‚¹ã€‚
> å­—ç¬¦è®¾å¤‡å¯ä»¥ä½¿ç”¨ä¸æ™®é€šæ–‡ä»¶ç›¸åŒçš„æ–‡ä»¶æ“ä½œå‘½ä»¤å¯¹å­—ç¬¦è®¾å¤‡æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œä¾‹å¦‚æ‰“å¼€ã€å…³é—­ã€è¯»ã€å†™ç­‰ã€‚

# å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼ˆä»¥Linuxä¸ºä¾‹ï¼‰

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>ğŸ’¡</div>
<p>é©±åŠ¨ç¨‹åºçš„å¼€å‘å¯å‚è€ƒ<a href="wikcnaWHaGcfJuXKq29b7VoozGf">å­—ç¬¦è®¾å¤‡é©±åŠ¨</a> ï¼Œå¼€å§‹å†™æ‰å‘ç°ç¡¬ä»¶çš„æˆå‘˜å·²ç»æ•´ç†çš„æ¯”è¾ƒè¯¦ç»†ï¼Œå¯ä»¥ç›´æ¥çœ‹è¿™ä¸ªã€‚</p>
</div>

## ä»€ä¹ˆæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åº

åº”ç”¨ç¨‹åºä¸å®é™…è®¾å¤‡çš„è½¯ä»¶å±‚ï¼Œæ˜¯Linuxå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯æŸä¸ªç‰¹å®šç¡¬ä»¶å“åº”ä¸€ä¸ªå®šä¹‰è‰¯å¥½çš„å†…éƒ¨ç¼–ç¨‹æ¥å£ï¼Œè¯¥æ¥å£å®Œå…¨éšè—è®¾å¤‡çš„å·¥ä½œç»†èŠ‚ã€‚

è®¾å¤‡é©±åŠ¨ç¨‹åºå¤„ç†å¦‚ä½•ä½¿ç¡¬ä»¶å¯ç”¨çš„é—®é¢˜ï¼Œè€Œå°†å¦‚ä½•ä½¿ç”¨ç¡¬ä»¶ç•™ç»™ä¸Šå±‚åº”ç”¨ç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¯´è®¾å¤‡é©±åŠ¨ç¨‹åºæä¾›æœºåˆ¶ï¼Œä¸æä¾›ç­–ç•¥ã€‚

è®¾å¤‡é©±åŠ¨ç¨‹åºæ˜¯Linuxä¸­çš„ä¸€ä¸ªå¯è£…è½½æ¨¡å—ã€‚
æ‰©å±•ï¼šå¯è£…è½½æ¨¡å—ï¼š
Linuxç³»ç»Ÿæä¾›ä¸€ä¸ªç‰¹æ€§ï¼šå†…æ ¸æä¾›çš„ç‰¹æ€§å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œæ‰©å±•ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ç³»ç»Ÿå¯åŠ¨å¹¶è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬ä»å¯ä»¥å‘å†…æ ¸æ·»åŠ åŠŸèƒ½(æˆ–ç§»é™¤åŠŸèƒ½)ã€‚
å¯åœ¨è¿è¡Œæ—¶æ·»åŠ åˆ°å†…æ ¸ä¸­çš„ä»£ç è¢«ç§°ä¸ºâ€œæ¨¡å—â€ã€‚Linuxå†…æ ¸æ”¯æŒå¤šç§æ¨¡å—ç±»å‹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºè®¾å¤‡é©±åŠ¨ç¨‹åºã€‚æ¯ä¸ªæ¨¡å—ç”±ç›®æ ‡ä»£ç ç»„æˆ(æ²¡æœ‰è¿æ¥æˆä¸€ä¸ªå®Œæ•´çš„å¯æ‰§è¡Œç¨‹åº)ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ï¼š
- insmod  æ¨¡å—å
å°†æ¨¡å—è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„å†…æ ¸
- rmmod  æ¨¡å—å
å°†æ¨¡å—ç§»é™¤

å¯è£…è½½æ¨¡å—æºä»£ç çš„åŸºæœ¬ç»„æˆå¦‚ä¸‹ï¼š

## è®¾å¤‡é©±åŠ¨è°ƒç”¨è¿‡ç¨‹

é’ˆå¯¹ä¸åŒçš„è®¾å¤‡ç±»åˆ«ï¼Œç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºé€šè¿‡ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨æ¥å£è°ƒç”¨åˆ°ä¸åŒçš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä»è€Œæ§åˆ¶ç¡¬ä»¶è®¾å¤‡ã€‚

Linuxæ“ä½œç³»ç»Ÿä¸‹ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨å„è®¾å¤‡è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![](/assets/NXWNbxT1Aob2ehx0CabcPapenEh.png)

## å­—ç¬¦è®¾å¤‡ã€å­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸ç”¨æˆ·ç©ºé—´è®¿é—®è¯¥è®¾å¤‡çš„ç¨‹åºä¸‰è€…ä¹‹é—´çš„å…³ç³»

![](/assets/RA4vbt0gNoYZ6yxAqATcjdoznCb.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨cdevç»“æ„ä½“æ¥æè¿°å­—ç¬¦è®¾å¤‡ï¼Œé€šè¿‡å…¶æˆå‘˜dev_tæ¥å®šä¹‰è®¾å¤‡å·(åˆ†ä¸ºä¸»ã€æ¬¡è®¾å¤‡å·)ä»¥ç¡®å®šå­—ç¬¦è®¾å¤‡çš„å”¯ä¸€æ€§ã€‚é€šè¿‡å…¶æˆå‘˜file_operationsæ¥å®šä¹‰å­—ç¬¦è®¾å¤‡é©±åŠ¨æä¾›ç»™VFSçš„æ¥å£å‡½æ•°ï¼Œå¦‚å¸¸è§çš„open()ã€read()ã€write()ç­‰ã€‚

åœ¨Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸­ï¼Œæ¨¡å—åŠ è½½å‡½æ•°é€šè¿‡register_chrdev_region() æˆ–alloc_chrdev_region()æ¥é™æ€æˆ–è€…åŠ¨æ€è·å–è®¾å¤‡å·ï¼Œé€šè¿‡cdev_init()å»ºç«‹cdevä¸file_operationsä¹‹é—´çš„è¿æ¥ï¼Œé€šè¿‡cdev_add()å‘ç³»ç»Ÿæ·»åŠ ä¸€ä¸ªcdevä»¥å®Œæˆæ³¨å†Œã€‚æ¨¡å—å¸è½½å‡½æ•°é€šè¿‡cdev_del()æ¥æ³¨é”€cdevï¼Œé€šè¿‡unregister_chrdev_region()æ¥é‡Šæ”¾è®¾å¤‡å·ã€‚

ç”¨æˆ·ç©ºé—´è®¿é—®è¯¥è®¾å¤‡çš„ç¨‹åºé€šè¿‡Linuxç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚open()ã€read()ã€write()ï¼Œæ¥â€œè°ƒç”¨â€file_operationsæ¥å®šä¹‰å­—ç¬¦è®¾å¤‡é©±åŠ¨æä¾›ç»™VFSçš„æ¥å£å‡½æ•°ã€‚

## Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¼–å†™

Linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¼–å†™ä¸»è¦éœ€å®Œæˆå¦‚ä¸‹å·¥ä½œï¼š

![](/assets/SQyabPWbboVNXexhG4rcJWC8n1W.png)

1. åˆ†é…cdev
    åœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨cdevç»“æ„ä½“æ¥æè¿°å­—ç¬¦è®¾å¤‡ï¼Œåœ¨é©±åŠ¨ä¸­åˆ†é…cdev,ä¸»è¦æ˜¯åˆ†é…ä¸€ä¸ªcdevç»“æ„ä½“ä¸ç”³è¯·è®¾å¤‡å·
    - åˆ†é…ç»“æ„ä½“
    ```c
struct cdev cdev_name;
```
    - ç”³è¯·è®¾å¤‡å·
    è®¾å¤‡å·æœ‰ä¸»æ¬¡ä¹‹åˆ†ï¼Œåœ¨Linuxä¸­ä»¥ä¸»è®¾å¤‡å¥½è¡¨ç¤ºä¸è®¾å¤‡æ–‡ä»¶ç›¸è¿æ¥çš„é©±åŠ¨ã€‚æ¬¡è®¾å¤‡å·ç”¨æ¥é©±åŠ¨æ“ä½œçš„æ˜¯å“ªä¸€ä¸ªè®¾å¤‡ã€‚ç”³è¯·è®¾å¤‡å·å­˜åœ¨ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é™æ€ç”³è¯·ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰‹åŠ¨æ‰¾åˆ°ä¸€ä¸ªè¿˜æœªä½¿ç”¨çš„ä¸»è®¾å¤‡å·ï¼Œç„¶åç”Ÿæˆè®¾å¤‡å·ï¼Œå¹¶æ³¨å†Œã€‚å¦ä¸€ç§æ˜¯åŠ¨æ€ç”³è¯·è®¾å¤‡å·ï¼Œç„¶åä»è®¾å¤‡å·ä¸­è·å–ä¸»è®¾å¤‡å·ï¼Œæ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨ç¨‹åºã€‚ä¸¤ç§æ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š
    - é™æ€ç”³è¯·è®¾å¤‡å·ï¼š
        ```c
dev_id  = MKDEV(major,0);
register_chrdev_region(dev_id,1,â€device_nameâ€);
```
    - åŠ¨æ€ç”³è¯·è®¾å¤‡å·ï¼š
        ```c
alloc_chardev_region(&dev_id,0,1,â€device_nameâ€);
major = MAJOR(dev_id);
```

2. åˆå§‹åŒ–cdev

void cdev_init(struct cdev* ,struct file_operations *);

cdev_init()å‡½æ•°ç”¨äºåˆå§‹åŒ–cdevçš„æˆå‘˜ï¼Œå¹¶å»ºç«‹cdevå’Œfile_oprationsä¹‹é—´çš„è”ç³»ã€‚

1. æ³¨å†Œcdev

int cdev_add(struct cdev *ï¼Œdev_tï¼Œunsigned);

cdev_add()å‡½æ•°å‘ç³»ç»Ÿæ·»åŠ ä¸€ä¸ªcdevï¼Œå®Œæˆå­—ç¬¦è®¾å¤‡çš„æ³¨å†Œã€‚

1. å®ç°è®¾å¤‡æ“ä½œ

ç”¨æˆ·ç©ºé—´çš„ç¨‹åºä»¥è®¿é—®æ–‡ä»¶çš„å½¢å¼è®¿é—®å­—ç¬¦è®¾å¤‡ï¼Œé€šå¸¸è¿›è¡Œopenï¼Œreadï¼Œwriteï¼Œcloseç­‰ç³»ç»Ÿè°ƒç”¨ã€‚è€Œè¿™äº›ç³»ç»Ÿè°ƒç”¨æœ€ç»ˆè°ƒç”¨çš„æ˜¯file_operationsç»“æ„ä½“ä¸­çš„æˆå‘˜å‡½æ•°ã€‚å®ƒä»¬æ˜¯å­—ç¬¦è®¾å¤‡é©±åŠ¨ä¸å†…æ ¸çš„æ¥å£ã€‚å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨ä¼šè°ƒç”¨åˆ°ç»“æ„ä½“é‡å¯¹åº”åç§°çš„æˆå‘˜å‡½æ•°ã€‚

```c
static struct file_operaions fops_name = {
    .owner = THIS_MODULE,
    .open  = open_name,
    .close = close_name,
     â€¦
}
```

1. æ³¨é”€é©±åŠ¨

å½“ä½¿ç”¨rmmodå‘½ä»¤æ—¶ï¼Œä¼šè°ƒç”¨é©±åŠ¨çš„é€€å‡ºå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­éœ€è¦å®Œæˆåœ¨æ¸…ç†æ³¨å†Œè¿‡ç¨‹ä¸­ä½¿ç”¨çš„èµ„æºï¼Œåˆ é™¤å­—ç¬¦è®¾å¤‡ï¼Œé‡Šæ”¾è®¾å¤‡å·ç­‰ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆå§‹åŒ–å‡½æ•°ä¸é€€å‡ºå‡½æ•°æ˜¯ä¸€ä¸ªåå‘æ“ä½œã€‚åœ¨åˆå§‹åŒ–ä½¿ç”¨çš„èµ„æºå¿…é¡»åœ¨é€€å‡ºå‡½æ•°ä¸­é‡Šæ”¾ã€‚

- åˆ é™¤å­—ç¬¦è®¾å¤‡
    ```c
void cdev_del(struct cdev *);
```

- é‡Šæ”¾è®¾å¤‡å·
    ```c
void unregister_chrdev_region(dev_t from, unsigned count);
```

## å­—ç¬¦é©±åŠ¨ç¨‹åºç¤ºä¾‹

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>ğŸ’¡</div>
<p>ä¸‹é¢æ˜¯æˆ‘ä¸€é—¨è¯¾ç¨‹çš„ä½œä¸šï¼Œä¾›å¤§å®¶å‚è€ƒ</p>
</div>

![](/assets/JtMnblw2AoSIbcxDb8Fc6hN3nfb.png)

è¦æ±‚ï¼šä½¿ç”¨æ ‘è“æ´¾å’Œè¶…å£°æ³¢æµ‹è·æ¨¡å—ï¼Œå®ç°è¶…å£°æ³¢æµ‹è·ã€‚

![](/assets/FfuEbJsAYoXBE9xy157cmRqFnwe.png)

### ä»£ç ï¼š

#### å†…æ ¸ï¼š

```c
#include <linux/init.h>
#include <linux/module.h>
#include <linux/device.h>
#include <linux/gpio.h>
#include <linux/interrupt.h>
#include <linux/cdev.h>
#include <linux/ioctl.h>
#include <linux/fs.h>
#include <asm/uaccess.h>
#include <linux/uaccess.h>
#include <linux/delay.h>
#include <linux/time.h>
#define DRIVER_NAME "Demo"
#define DEVICE_NAME "Demo"

static dev_t demo_devno; //è®¾å¤‡å·
static struct class *demo_class;
static struct cdev demo_dev;

static struct gpio_config{
    int trig_num;
    int echo_num;
}config;

struct times {
    struct timeval begin_time;
    struct timeval end_time;
}t;

static int flag = 0;

//open å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨openç³»ç»Ÿè°ƒç”¨æ—¶ä¼šè°ƒç”¨æœ¬å‡½æ•°
static int demo_open(struct inode *inode,struct file *filp)
{
    printk(KERN_INFO"Demo open\n");
    return 0;

}

//release å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨closeç³»ç»Ÿè°ƒç”¨æ—¶ä¼šè°ƒç”¨æœ¬å‡½æ•°
static int demo_release(struct inode *inode, struct file *filp)
{   
    if(flag){
        free_irq(gpio_to_irq(config.trig_num),NULL);
        gpio_free(config.trig_num);
        gpio_free(config.echo_num);
        flag = 0;
    }

    printk(KERN_INFO"Demo release\n");
    return 0;
}
static long demo_read(struct file *filp, char __user *buf, size_t count, loff_t *offset)
{
    int ret = 0;

    printk("enter demo_read!\n");
    
    gpio_set_value(config.trig_num,1);
    udelay(22);
    gpio_set_value(config.trig_num,0);

    //Wait until echo is high
    while(gpio_get_value(config.echo_num)==0){
        continue;
    }
    //get start time
    do_gettimeofday(&t.begin_time);
    printk("echo start!, time is : %ld s %ld us \n",t.begin_time.tv_sec, t.begin_time.tv_usec);
    //Wait until echo is 
    while(gpio_get_value(config.echo_num)==1){
        continue;
    }
    
    //get end time
    do_gettimeofday(&t.end_time);
    printk("echo end! time is : %ld s %ld us \n",t.end_time.tv_sec, t.end_time.tv_usec);
    
    ret = copy_to_user((void *)buf, &t, count);

    return ret;
}

//ioctl æ§åˆ¶å‡½æ•°ï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨ioctlç³»ç»Ÿè°ƒç”¨æ—¶ä¼šè°ƒç”¨æœ¬å‡½æ•°
static long demo_ioctl(struct file *filp,unsigned int cmd,unsigned long arg)
{
    int err = 0;
    switch(cmd){
        case 0://0 è¡¨ç¤ºå‘½ä»¤å·ï¼Œä¸€èˆ¬éƒ½ç”¨å®å®šä¹‰æ¥æ§åˆ¶
            {
                if(copy_from_user(&config,(void *)arg,sizeof(struct gpio_config))){ //ä»ç”¨æˆ·ç¨‹åºä¸­è·å–é…ç½®æ•°æ®
                    printk(KERN_ERR"[%s %d] : copy_from user failed !\n",__func__,__LINE__);
                    return -EFAULT;
                }
                printk(KERN_INFO"[%s %d]: Get trig gpio num: %d and echo gpio num: %d\n ",__func__,__LINE__,config.trig_num,config.echo_num);
                err = gpio_request_one(config.echo_num,GPIOF_IN,"Light Button");
                if(err){
                    printk(KERN_ERR"[%s %d]:Request echo gpio failed\n",__func__,__LINE__);
                    return -EFAULT;
                }
                err = gpio_request_one(config.trig_num,GPIOF_OUT_INIT_LOW,"LED light");
                if(err){
                    printk(KERN_ERR"[%s %d]:Request trig gpio failed\n",__func__,__LINE__);
                    gpio_free(config.trig_num);
                }

                break;
            }
        default:
            printk(KERN_INFO"[%s %d]:Invalid cmd", __func__,__LINE__);
            break;
    }
    return 0;
}

static struct file_operations demo_fops = {
    .owner = THIS_MODULE,
    .open  = demo_open,
    .release  = demo_release,
    .unlocked_ioctl = demo_ioctl,
    .read = demo_read,
};

static int __init demo_init(void)
{
    int err;

    printk(KERN_INFO"Demo Init \n");

    err = alloc_chrdev_region(&demo_devno,0,1,DRIVER_NAME);   
    if(err < 0){
        goto err;
    }
    cdev_init(&demo_dev,&demo_fops);

    err = cdev_add(&demo_dev,demo_devno,1);

    if(err < 0)
    {
        printk(KERN_ERR"[%s,%d]add cdev failed\n",__func__,__LINE__);
        goto FREE_DEVNO;
    }
    //è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡æ–‡ä»¶ åœ¨/devç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ºDEVICE_NAME
    demo_class = class_create(THIS_MODULE,DEVICE_NAME);
    if(IS_ERR(demo_class))
    {
        printk(KERN_ERR"[%s,%d]class create failed\n",__func__,__LINE__);
        goto DEV_FREE;
    }
    device_create(demo_class,NULL,demo_devno,NULL,DEVICE_NAME);

    return 0;
DEV_FREE:
    cdev_del(&demo_dev);
FREE_DEVNO:
    unregister_chrdev_region(demo_devno, 1);
err:
    return err;
}

static void demo_exit(void)
{
    if(flag){
        free_irq(gpio_to_irq(config.trig_num),NULL);
        gpio_free(config.trig_num);
        gpio_free(config.echo_num);
    }
    device_destroy(demo_class,demo_devno);
    class_destroy(demo_class);
    cdev_del(&demo_dev);
    unregister_chrdev_region(demo_devno, 1);
    printk(KERN_INFO"Demo exit\n");
}

module_init(demo_init);
module_exit(demo_exit);
MODULE_AUTHOR("hyg");
MODULE_DESCRIPTION("BUTTON LED Driver");
MODULE_LICENSE("GPL");
```

##### Makefileæ–‡ä»¶ï¼š

```makefile
ARCH=arm64

CROSS_COMPILE=/home/yixin/Pi/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin/aarch64-linux-gnu-

ifneq ($(KERNELRELEASE),)
    obj-m := demo.o
else
    KERNELDIR:=/home/yixin/Pi/linux
    #KERNELDIR:=/src/ras/linux/
    PWD := $(shell pwd)
default:
    $(MAKE) CROSS_COMPILE=$(CROSS_COMPILE) ARCH=$(ARCH) -C $(KERNELDIR) M=$(PWD) modules
clean:
    rm -rf *.o *.ko *.mod.c *.order *.symvers   
endif
```

#### ç”¨æˆ·æ€ï¼š

```makefile
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/time.h>
#include <sys/ioctl.h>
#include <errno.h>
#include <fcntl.h>

struct gpio_config
{
    int trig_num;
    int echo_num;
};

struct times {
    struct timeval begin_time;
    struct timeval end_time;
};

int main(int argc, char **argv)
{
    int fd;
    struct gpio_config config;
    struct times t;
    config.trig_num = 2;
    config.echo_num = 3;

    fd = open("/dev/Demo", O_RDWR);
    if (fd < 0) {
        perror("/dev/Demo");
        exit(0);
    }

    //init gpio pin
    ioctl(fd, 0, &config);

    while(1){
        long read_ok=read(fd, &t, sizeof(t));
        //printf("read state :%ld\n",read_ok);
        double distance = ((t.end_time.tv_sec-t.begin_time.tv_sec)+(t.end_time.tv_usec-t.begin_time.tv_usec)/1000000.0)*340.0/2.0;
        printf("the start time is : %ld s %ld us \n",t.begin_time.tv_sec,t.begin_time.tv_usec);
        printf("the end time is : %ld s %ld us \n",t.end_time.tv_sec,t.end_time.tv_usec);
        printf("the distance is : %f m \n",distance);
        sleep(1);
    }

    close(fd);
    return 0;
}
```

##### Makefile æ–‡ä»¶ï¼š

```makefile
CC = /home/yixin/Pi/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin/aarch64-linux-gnu-gcc


all: demo

demo: demo.o
    $(CC) -o $@ $^ -static

clean:
    -rm *.o $(all)
```

##### è¿è¡Œç»“æœï¼š

![](/assets/Az6lbXgX0oL6VVxTj99c8bvHnWb.png)

# ç»“è¯­

æˆ–è®¸è¿™ä¸ªå†…å®¹ç”±ç¡¬ä»¶çš„æˆå‘˜æ¥å†™æ›´å¥½ï¼‰

è¿™æ¬¡ä¸»è¦æ˜¯æ¬è¿äº†ã€ŠåµŒå…¥å¼ç³»ç»Ÿã€‹çš„ä½œä¸šï¼Œæœ‰ç–æ¼ä¹‹å¤„æ¬¢è¿è¡¥å……ä¿®æ”¹ã€‚

