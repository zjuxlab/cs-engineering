---
title: åº”ç”¨å®è·µ
slug: åº”ç”¨å®è·µ
sidebar_position: 2
---


# åº”ç”¨å®è·µ

Authorï¼šå†œç‰ä¿Š

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†åœ¨ Kubernetes(Minikube) ä¸­éƒ¨ç½²ä¸€ä¸ªåŸºäº React çš„å‰ç«¯åº”ç”¨ç¨‹åºå’ŒåŸºäº Flask çš„åç«¯ apiã€‚

# å‰ç½®çŸ¥è¯†

å¦‚æœä½ ä¸çŸ¥é“ä»€ä¹ˆæ˜¯Kubernetesï¼Œä»€ä¹ˆæ˜¯Minikubeï¼Œä½ ä¸å¦¨å…ˆçœ‹çœ‹å‰ä¸¤ä¸ªå­æ–‡æ¡£

# æ¦‚æ‹¬

æˆ‘ä»¬å°†æ„å»ºä¸¤ä¸ª docker é•œåƒã€‚ä¸€ä¸ªç”¨äºæˆ‘ä»¬çš„ React åº”ç”¨ç¨‹åºï¼Œå¦ä¸€ä¸ªç”¨äºåŸºäº Flask çš„ RestAPI åº”ç”¨ç¨‹åºã€‚ç„¶åæˆ‘ä»¬å°†å®ƒä»¬ä¸Šä¼ åˆ°docker hubã€‚æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªéƒ¨ç½²å’ŒæœåŠ¡æ–‡ä»¶æ¥åœ¨ minikube ä¸Šéƒ¨ç½²æˆ‘ä»¬çš„é¡¹ç›®ã€‚

è¯¥é¡¹ç›®çš„ä»£ç å¯åœ¨æ­¤å¤„è·å–ï¼šhttps://github.com/FahadAminShovon/kubeTest

è¯¥ React åº”ç”¨ç¨‹åºå°†æ¥å—ä¸€ä¸ªæ•°å­—ä½œä¸ºè¾“å…¥ï¼Œå¹¶å°†å…¶å‘é€åˆ°å…¶ä½™ api ç«¯ç‚¹ã€‚è¯¥ç«¯ç‚¹å°†åè½¬æ•°å­—å¹¶åšå‡º json å“åº”ã€‚

![](/assets/FkCob0w8SoAjt0xuxO6cEVZ4nDb.png)

é€šè¿‡å•å‡» React åº”ç”¨ç¨‹åºä¸­çš„æäº¤æŒ‰é’®å°†å‘é€ä¸€ä¸ª POST è¯·æ±‚ã€‚

```js
state = { 
        num:"",
        reverseNum: ""
     }

    handleChange = (e) =>{
        this.setState({num:e.target.value})
    }

    handleSubmit=()=>{
        axios.post(`/reverser`, this.state)
        .then(res => {
          this.setState({reverseNum:res.data.num})
        })
    }
```

apiç«¯ç‚¹å°†æ¥æ”¶è¯¥å·ç ï¼Œå°†å…¶åè½¬å¹¶å°†å…¶å‘é€å›å‰ç«¯ï¼š

```py
@app.route('/')
def hello_world():
    return 'Hello world'


@app.route('/reverser',methods = ['POST'])
def reverser():
    num = request.get_json().get("num")
    num = int(num[len(num)::-1])
    return jsonify({"num":num})
```

è¾“å‡ºå°†å¦‚ä¸‹æ‰€ç¤º

![](/assets/EAFbbRjFooBtY1xYfoccndwSnyd.png)

## æ­¥éª¤1

### React app

ä¸º React åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ª Dockerfileã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ nginx ä½œä¸º Web æœåŠ¡å™¨å’Œåå‘ä»£ç†ã€‚

```docker
# ä½¿ç”¨Node 11.10.0-alpineé•œåƒä½œä¸ºæ„å»ºé˜¶æ®µçš„åŸºç¡€é•œåƒ
FROM node:11.10.0-alpine AS build-stage

# å®‰è£…æ„å»ºä¾èµ–ï¼ŒåŒ…æ‹¬Pythonã€Makeå’Œg++
RUN apk add --update --no-cache \
    python \
    make \
    g++

# å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­çš„/srcç›®å½•
COPY . /src

# è®¾ç½®å·¥ä½œç›®å½•ä¸º/src
WORKDIR /src

# å¤åˆ¶package.* åˆ°é•œåƒä¸­
COPY ./package* ./

# è¿è¡Œnpm installå®‰è£…Node.jsä¾èµ–
RUN npm install

# è¿è¡Œyarn buildå‘½ä»¤è¿›è¡Œé¡¹ç›®æ„å»º
RUN yarn build

# ä½¿ç”¨æœ€æ–°ç‰ˆçš„Nginxä½œä¸ºç”Ÿäº§ç¯å¢ƒé•œåƒ
FROM nginx:latest

# ç§»é™¤é»˜è®¤çš„Nginxç½‘ç«™æ–‡ä»¶å¤¹
RUN rm -rf /usr/share/nginx/html

RUN mkdir /usr/share/nginx/html

# ä»æ„å»ºé˜¶æ®µçš„é•œåƒä¸­å¤åˆ¶æ„å»ºå¥½çš„å‰ç«¯åº”ç”¨åˆ°Nginxç½‘ç«™æ–‡ä»¶å¤¹ä¸­
COPY --from=build-stage /src/build/ /usr/share/nginx/html/

# å°†è‡ªå®šä¹‰çš„Nginxé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°é•œåƒä¸­
COPY default.conf /etc/nginx/conf.d/

# æš´éœ²å®¹å™¨çš„80ç«¯å£ï¼Œç”¨äºè®¿é—®NginxæœåŠ¡
EXPOSE 80
```

### Build and upload image

è¿è¡Œä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªimageï¼Œå¹¶ç”¨æ‚¨çš„ Docker hub ç”¨æˆ·åå’Œæ‚¨çš„imageåç§°ï¼ˆä»¥è¿™ç§æ ¼å¼ï¼‰ç»™å®ƒä¸€ä¸ªæ ‡ç­¾

```text
æ ¼å¼ï¼š yourUserName/projectName:vX
```

```bash
docker build -t yourUserName/reverser-front:v1 .
```

æ­¤æ—¶å¯ä»¥åœ¨æœ¬åœ°çœ‹åˆ°Docker image

![](/assets/S2kyb0Zb8o6lnSxlZv5cBMafnSg.png)

å°†æ‚¨çš„imageä¸Šä¼ åˆ° Dockerhub registry

```bash
docker login -u username -p password
docker push yourUserName/reverser-front:v1
```

![](/assets/LmmqbCxaeoNj9Bxovhgc7alMnSd.png)

ç°åœ¨imageå·²ä¸Šä¼ åˆ°æ‚¨çš„ Docker hub å­˜å‚¨åº“

## æ­¥éª¤2

### <b>Dockerize flask app </b>

ä¸º Flask åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ª Dockerfile

```docker
FROM python:3.7.1

RUN mkdir /app
# è®¾ç½®å·¥ä½œç›®å½•ä¸º /app
WORKDIR /app

# We copy just the requirements.txt first to leverage Docker cache
COPY ./requirements.txt /app/requirements.txt

# ä½¿ç”¨ pip å®‰è£… flask
RUN pip install flask

ADD . /app

# å°†å½“å‰ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ·»åŠ åˆ°å®¹å™¨çš„ /app ç›®å½•ä¸­
EXPOSE 5000

# åœ¨å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤ï¼šå¯åŠ¨ Flask åº”ç”¨ï¼Œç›‘å¬æ‰€æœ‰å¯ç”¨çš„ IP åœ°å€
CMD flask run --host=0.0.0.0
```

### <b>Build and upload image</b>

åŒä¸Šï¼Œä¸å†èµ˜è¿°ã€‚

## æ­¥éª¤3

<b>ä¸ºReact appåˆ›å»ºéƒ¨ç½²æ–‡ä»¶</b>

æˆ‘ä»¬å°†ä¸ºå‰ç«¯éƒ¨ç½²åˆ›å»ºä¸€ä¸ª YAML æ–‡ä»¶

```yaml
# apiVersionï¼šæˆ‘ä»¬ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ kubernetes api
apiVersion: apps/v1
# kindï¼šæˆ‘ä»¬æƒ³è¦åˆ›å»ºä»€ä¹ˆæ ·çš„å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬æ­£åœ¨åˆ¶ä½œä¸€ä¸ªéƒ¨ç½²å¯¹è±¡ã€‚
# è¿˜æœ‰å…¶ä»–å¯¹è±¡ï¼Œä¾‹å¦‚ Serviceã€Podã€Namespace ã€‚
kind: Deployment 
metadata:
  name: back-end-deployment
spec:
  # replicas æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œ
  # ç”¨äºæŒ‡å®šåœ¨ Deploymentã€ReplicaSet æˆ– StatefulSet ä¸­éœ€è¦åˆ›å»ºçš„å‰¯æœ¬æ•°é‡ã€‚
  # æ¯ä¸ªå‰¯æœ¬ä»£è¡¨ä¸€ä¸ªç›¸åŒçš„å®¹å™¨å®ä¾‹ï¼Œä»¥ç¡®ä¿åº”ç”¨ç¨‹åºå…·æœ‰å¯æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§å’Œè´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚
  replicas: 1
  selector:
    matchLabels:
      component: front
  template:
    metadata:
      labels:
        component: front
    spec:
      containers:
        - name: flask-back-end
          image: userName/reverser-front:vX
          ports:
            - containerPort: 80
```

ï¼ˆæ³¨é‡Šå†…å®¹æ¯”è¾ƒé‡è¦ï¼Œå€¼å¾—ä¸€çœ‹ï¼‰

åˆ›å»ºä¸€ä¸ªæœåŠ¡å¯¹è±¡ä»¥ä»æµè§ˆå™¨æˆ–å…¶ä»– pod è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>â›µ</div>
<p>Kubernetes ä¸­ Service æ˜¯ å°†è¿è¡Œåœ¨ä¸€ä¸ªæˆ–ä¸€ç»„ <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">Pod</a> ä¸Šçš„ç½‘ç»œåº”ç”¨ç¨‹åºå…¬å¼€ä¸ºç½‘ç»œæœåŠ¡çš„æ–¹æ³•</p>
</div>

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: front-node-port

spec:
  type: NodePort
  ports:
      # portï¼šå“ªä¸ªç«¯å£å°†ç”¨äº Pod ä¹‹é—´çš„é€šä¿¡
    - port: 80
      # targetPortï¼štargetPort å¸®åŠ© Service ç¡®å®šè¦å°†æµé‡ä¼ é€’ç»™ Pod å†…çš„å“ªä¸ªå®¹å™¨ç«¯å£
      targetPort: 80
      # nodePortï¼šå…¬å¼€ä»¥ä¾›é›†ç¾¤èŠ‚ç‚¹å¤–éƒ¨è®¿é—®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨nodeportä»æµè§ˆå™¨è®¿é—®å®¹å™¨ã€‚
      nodePort: 31515
      
  selector:
    component: front
```

![](/assets/R6dkbVOX1oMln2xR52gc24Abngc.png)

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>â›µ</div>
<p>Kubernetes çš„ Selector æ ¹æ®æ ‡ç­¾æ¥é€‰æ‹©è¦æ“ä½œçš„ Podã€‚è¿™æ ·ï¼Œä½ å¯ä»¥é’ˆå¯¹ç‰¹å®šæ ‡ç­¾çš„ Pod è¿›è¡Œæ“ä½œï¼Œè€Œä¸å¿…ä¸€ä¸ªä¸€ä¸ªåœ°å¤„ç†æ¯ä¸ª Podã€‚</p>
</div>

## <b>æ­¥éª¤4</b>

Apply deployment and service for react front-end.

æˆ‘ä»¬ä½¿ç”¨ minikube åœ¨æœ¬åœ°ç¯å¢ƒä¸­éƒ¨ç½²æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

```bash
kubectl apply -f front-deploy.yaml
```

æ£€æŸ¥Deploymentå’ŒPodï¼š

```bash
â¯ kubectl get deployment

NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
front-end-deployment   1/1     1            1           115s
â¯ kubectl get pods

NAME                                    READY   STATUS    RESTARTS   AGE
front-end-deployment-569d6b7484-wvxqq   1/1     Running   0          2m4s
```

æˆ‘ä»¬ä»ç„¶æ— æ³•ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ­¤å‰ç«¯åº”ç”¨ç¨‹åºï¼Œå› ä¸ºæˆ‘ä»¬å°šæœªä¸ºæ­¤éƒ¨ç½²åº”ç”¨Serviceã€‚è¦ä»å¤–éƒ¨èŠ‚ç‚¹è®¿é—®æ­¤ Podï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºæ­¤åº”ç”¨ç¨‹åºåº”ç”¨æˆ‘ä»¬çš„ NodePort Serviceï¼Œå¹¶æ£€æŸ¥

```bash
â¯ kubectl apply -f front-node-port.yaml
service/front-node-port created
â¯ kubectl get services

NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
front-node-port   NodePort    10.109.76.143   <none>        80:31515/TCP   7s
kubernetes        ClusterIP   10.96.0.1       <none>        443/TCP        59d
```

æˆ‘ä»¬åœ¨ minikube é›†ç¾¤è€Œä¸æ˜¯æœ¬åœ°ä¸»æœºä¸­è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨æˆ‘ä»¬çš„ minikube IP è®¿é—®è¯¥åº”ç”¨ç¨‹åºã€‚

```bash
minikube ip
```

ç„¶åIP + ç«¯å£å·å°±å¯ä»¥è®¿é—®äº†ã€‚

> æˆ‘ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å¤±è´¥äº†ğŸ˜­
äºæ˜¯ä¸‹è½½äº†ä¸€ä¸ªK8s IDE - OpenLens
ä½¿ç”¨ForwardåŠŸèƒ½æŠŠServiceçš„ç«¯å£forwardåˆ°æˆ‘çš„localhostï¼Œæ‰èƒ½è®¿é—®
> ![](/assets/PhVEbDCPnoCVaaxn5YXc7GI3njb.png)
> ![](/assets/Tnwibx6jtopSjUxS2d3c8W7snZb.png)

## æ­¥éª¤5

ç°åœ¨ä¸ºåç«¯æœåŠ¡ç¼–å†™deploymentå’Œserviceæ–‡ä»¶

```yaml
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: back-end-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      component: back
  template:
    metadata:
      labels:
        component: back
    spec:
      containers:
        - name: flask-back-end
          image: userName/reverser-back:v2
          ports:
            - containerPort: 5000
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: back-node-port
spec:
  type: NodePort
  ports:
    - port: 5000
      targetPort: 5000
      nodePort: 31516
  selector:
    component: back
```

applyè¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶

![](/assets/B1iybiHXco1yGixyWrLcGgqKnSg.png)

## æ­¥éª¤6

ç°åœ¨æˆ‘ä»¬çš„ React å‰ç«¯å’Œ Flask åç«¯åº”ç”¨ç¨‹åºéƒ½å·²å¯åŠ¨å¹¶è¿è¡Œï¼Œæˆ‘ä»¬å°†åœ¨å®ƒä»¬ä¹‹é—´å»ºç«‹è¿æ¥ã€‚å½“æˆ‘ä»¬åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šè¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ http-proxy ä¸­é—´ä»¶æ¥bypassä»å‰ç«¯åº”ç”¨ç¨‹åºåˆ°åç«¯åº”ç”¨ç¨‹åºçš„ http è¯·æ±‚ã€‚

# å‚è€ƒ

