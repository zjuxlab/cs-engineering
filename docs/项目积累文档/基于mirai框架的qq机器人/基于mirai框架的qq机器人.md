---
title: 基于 mirai 框架的 qq 机器人
slug: o2f7wxzunibpmakeyrqcl42ln5f-bk8nwiyeuihibmkbwllcopbynoz-bk8nwi
sidebar_position: 3
---


# 基于 mirai 框架的 qq 机器人

Author: 王芷瑜

<div class="callout callout-bg-2 callout-border-2">
<div class='callout-emoji'>❗</div>
<p>注意！本分享可能含有：</p>
<p>有可能小时候抱过我的技术栈（但勉强还算活着）</p>
<p>Xlab 并不推荐的纯用爱发电工程和它的受害者（就是我）的不动人自述</p>
<p>tx 官方理论上禁用的外挂插件框架</p>
<p>像 ave mujica 一样精彩的 编程语言（气笑了）</p>
<p>像上一个比喻一样不负责任的搞笑比喻</p>
<p>后半段写着写着写不下去了变成人文社科大考察</p>
</div>

# 引入：QQ 机器人和跑团游戏

## 0.0 从跑团（TRPG）游戏讲起

> Q：什么是TRPG？
> A. Tabletop Role-playing game，桌上角色扮演游戏
> B. Tabletop Rocket-Propelled Grenade，桌上火箭推进榴弹
> C. “踢人屁股” 的拼音首字母缩写

### 跑团的规则：

- 最经典的跑团：coc，dnd
- 更多跑团规则：无限流跑团，无限流跑团圣杯战争，赛博朋克，战锤40k：死亡守望，战锤40k：巢都涅克罗蒙达，etc.

### 跑团的形式分类：

- 线下面团
- 线上网团 &lt;-- 今天我们讨论这个

### 跑团需要的工具：

- 规则、模组（也称剧本）
- 场地、帷幕、地图、纸质人物卡和指示器、棋子（非必须）
- 朋友和游戏的热情（这个最重要）
- 骰子 &lt;-- 今天我们讨论这个

### 跑团的平台：

- QQ（最主要） &lt;-- 今天我们讨论这个
- 贴吧（一部分无限流跑团的前身是贴游）
- 更多平台

一个平台成为跑团平台的<b>必要</b>条件：
- 文字、语音即时通信能力
- 图片、文件传输能力
一个平台成为跑团平台的<b>进阶</b>条件： &lt;-- 今天我们讨论这个
- 便捷的随机数生成
- 便捷的规则查询功能
- 根据需要记录用户数据并在合适时机进行提示
- 自动调用规则、随机数和用户数据完成复合功能（eg：从玩家属性中获取玩家技能成功率，生成随机数判断技能是否成功，按照规则返回技能成功后的可能结果，可能还需要相应地更新玩家属性）

### 总结：

为了使 qq 上的跑团游戏变得更加便捷，一些会写码的跑团爱好者开始使用 qq 外挂插件来实现上面提到的进阶功能。今天上述功能特别是 coc 跑团的相关功能已经相当完善，你可以在 qq 抓到一大把具有完备 coc 跑团协助能力的 qq bot，由于随机数生成是它们最核心也最普遍的能力，这些机器人一般被称为<b>骰娘</b>。

> 前段时间我有位朋友创作了自己的跑团规则，但不幸的是朋友创作的跑团规则又臭又长，创造了一款战斗中要通过调试机魂获取属性加值然后选择攻击动作获取武器属性并通过战斗双方属性实时计算攻击次数和造伤成功率和穿甲成功率再先判定是否命中再判定是否造伤最后判定是否破甲同时在造伤过程中需要判断武器是否卡住且在盔甲保护判定过程中需要加上基于双方位置和地形计算的掩体保护加成并判断盔甲是否在攻击中途损坏最后还有格挡弹反和中断攻击规则的桌上角色扮演游戏
> <del>下次遇到这种朋友建议直接按着对方把规则改了</del>

年轻的小蛋糕想着不就写个 rand 吗多大点事啊，于是开始帮朋友写进阶版 qq bot。

就这样，小蛋糕的一生完全被 qq bot 毁灭了。<del>大模拟：亻尔 女子</del>

# QQ 的协议

### 网络协议

#### <b>TCP（传输控制协议）</b>

<b>特点</b>：可靠传输 连接导向 高开销

<b>应用场景</b>：登录状态保持、大文件传输、支付功能

#### <b>UDP（用户数据包协议）</b>

<b>特点</b>：无连接 低延迟 不可靠

<b>应用场景</b>：QQ默认消息传输（通过UDP发送，失败后切TCP重试）。

#### <b>TCP/UDP 混合使用</b>

- <b>消息传输</b>：优先UDP发送，若超时未收到服务器应答，自动切换为TCP重发。
- <b>文件传输</b>：始终使用TCP（端口443），确保大文件完整性。
- <b>心跳包</b>：通过TCP发送，维持长连接状态。

#### 一些 Fun Facts

> 参考：https://www.cnblogs.com/hnrainll/archive/2011/09/19/2181527.html 这篇文章写得挺好玩的。

- 登陆成功之后，QQ会有一个TCP连接来保持在线状态。这个TCP连接的远程端口一般是80；采用UDP方式登陆的时候，端口是8000。
- 聊天消息通信采用UDP协议，通过服务器中转方式进行。
- 文件传输、发送自定义表情是通过TCP方式进行的，同时会发送IP地址；QQ电话也会用到IP地址。
- <b>QQ官方表情是命令字</b>，客户端收到命令字后，会自动解释为对应的表情。
    > （通过这个原理，你的 QQ 机器人可以发送指定点数的 QQ 官方超级表情骰子 <del>可惜现在大家小组作业摇骰子都是在微信摇的 </del>）

于是：如果一个局域网只开放80端口，QQ可以登陆成功，也可以进行聊天。但传送文件是不可以的，除非你们都在同一个内网。如果局域网还同时开放443端口，那么，恭喜你，QQ的功能你都可以正常使用。

又及，当你有对你的qq好友进行一些友好的远程物理攻击的需求时（最好不要有，有也不要做，总之仅用作教育目的请不要用于任何不当用途后面忘了），你可能会搜索到一些这样的开源代码：https://github.com/shinyxiaoxia/sjzpt

这也是基于 QQ 的 TCP 实现的，结合上述内容，或许自定义表情也会有类似的作用？

### <b>QQ Android协议</b>

QQ Android协议是腾讯为移动端设计的私有协议，核心特点如下：

#### <b>协议结构</b>

- <b>分层设计</b>：
    - <b>传输层</b>：基于TCP长连接（部分场景用UDP），使用自定义二进制格式封装数据。
    - <b>加密层</b>：采用多阶段加密：
        - <b>登录阶段</b>：使用RSA加密密码，ECDH交换会话密钥。
        - <b>通信阶段</b>：对数据包进行TEA加密（密钥动态生成）。
    - <b>业务层</b>：定义消息类型（如`0x0A`为文本消息，`0x03`为图片消息）。

- <b>数据包格式</b>：
每个数据包由<b>头部</b>（固定字段）和<b>载荷</b>（业务数据）组成：

```go
| 包头长度（4B） | 协议版本（2B） | 命令字（2B） | 序列号（2B） | 加密标志（1B） | 保留字段 | 载荷（加密后） |
```

#### <b>关键流程</b>

1. <b>登录流程</b>：
    - 发送设备信息 → 获取登录令牌 → 提交加密密码 → 完成滑块验证（如需） → 建立会话密钥。
    - 依赖`wtlogin.trans_emp`等特定命令字（Command ID）。

2. <b>消息收发</b>：
    - 文本消息：构造`MessageSvc.PbSendMsg`请求，包含发送者、接收者、消息内容。
    - 图片消息：先上传图片至腾讯服务器，获取`imageId`后再发送。

#### <b>风控对抗</b>

- <b>设备指纹</b>：协议中强制携带设备信息（如IMEI、MAC地址、系统版本），腾讯通过指纹一致性检测外挂。
    > 最近是不是畅课钉钉签到也更新了什么设备指纹的内容然后一部手机只能签一个人了

- <b>行为校验</b>：高频操作（如秒回消息、频繁加群）会触发服务器限流或封禁。

### 更多参考

QQ 通讯协议：https://www.cnblogs.com/zuiai12/articles/2105224.html

# Mirai 框架

> 项目仓库：https://github.com/mamoe/mirai
> 官方开发文档：https://docs.mirai.mamoe.net/
> 官方论坛：https://mirai.mamoe.net/
> 参考：https://cloud.tencent.com/developer/article/1819302

早期 qq bot 最多的是基于酷Q，但经过某几次大更新 <del>为 qq 自己的机器人铺路</del>，酷Q基本算是完全去世了，几经波折后现在的机器人框架变得比较杂乱且不稳定。我使用的是基于 mirai 框架的 qq bot。

![](/assets/UoiLbFHS9oD5vNx8S63cDmZwnle.png)

> 图片来源：mirai官网https://docs.mirai.mamoe.net/

#### 负责协议的 <b>mirai-core</b>

- <b>协议逆向工程</b>：通过逆向分析QQ Android客户端的网络通信，解析其私有协议（如登录流程、消息格式、加密方式），并模拟官方客户端的通信行为。
- <b>多协议支持</b>：默认基于QQ Android协议（较稳定且易于逆向），也支持部分历史协议版本（如iPad协议）。

#### 负责功能的 `mirai-core-api`

### 更多语言支持：mirai-api-http

支持语言如图所示，图片来源同上

![](/assets/R081bSWopotQt3xFZ0Ucbfplnec.png)

# 在框架上再造框架

<del>又名这玩意不是看起来挺好的吗是怎么一步步变成屎山的</del>

> 一些历史中出现过的大一统骰子框架：https://v2docs.kokona.tech/zh/latest/CookBook.html#id65
> 仍在更新的论坛：https://forum.kokona.tech/
> 几个月前更新过的答疑文档：见论坛

这段没什么营养因为我没办法短时间把历史框架全讲一遍，只好展示一下 qq 骰娘这个历时长久的业余程序员屎山长跑是怎么一步步跑到了现在的样子

<b>shiki & 溯洄系 Dice!</b>：守序善良。有官方开发文档和论坛的老牌框架，支持 lua，js 和 python 插件。很遗憾的是小蛋糕刚开始写骰子的时候没找到这个框架，正在考虑后续再基于这个框架做个新骰子

<b>ZhaoDice</b>：混乱邪恶。目前和shiki & 溯洄系应该算是分走半壁江山但是世界上怎么会出现这样的东西。支持 回雪、lua 和 js 插件，而且 lua 和 js 插件必须和回雪语言结合使用。至于什么是回雪语言，请看vcr：

```
[[define]]
name="分割随取符"
content="*"

[[define]]
name="主人专属回复"
content="""
回复1*回复2*回复3
"""
[[define]]
name="陌生"
content="""
回复1*回复2*回复3
"""
[[auto]]
keywordFull="<关键词>"
program="""【判断 【发送者QQ】,<qq号>,【返回 【分割随取 【常量 分割随取符】,【常量 陌生】】】,【分割随取 【常量 分割随取符】,【常量 主人专属回复】】】
"""
```

> 是的，这是个在 qq bot 界甚至得到了一定程度上的广泛使用的语言。

<b>AstralDice</b>：丰川祥子级的。在ZhaoDice的基础上改进而来，仍然是支持 回雪、lua 和 js 插件，且 lua 和 js 插件必须和回雪语言结合使用。改进在于闭源到了手机上，不再需要服务器。

<b>谷雨框架</b>：
<b>框架本身</b>唯一的改进是支持不用掺回雪的屎的 lua 插件，但由于 lua 语言本身的缺陷，创作体验同样相当令人愤怒。<del>也不排除是因为我有码怒症，一写代码就骂人，写回雪骂回雪，写lua骂lua，写verilog骂我自己</del>
<b>脚本方面</b>，谷雨作者提供了很多有趣的脚本，譬如 qq bot 的 GPT/ds API 接口、在线debug插件等。

<b>我的实践</b>：

- 本来想自己手写框架的，手动把骰子的几个比较核心的功能重新搓了一遍，结果写本文档的时候又发现了溯洄系骰子的新框架，打算有空去试试。

# 参考文献

QQ TCP/UDP：https://www.cnblogs.com/hnrainll/archive/2011/09/19/2181527.html

QQ 通讯协议：https://www.cnblogs.com/zuiai12/articles/2105224.html

Mirai项目仓库：https://github.com/mamoe/mirai

Mirai官方开发文档：https://docs.mirai.mamoe.net/

Mirai官方论坛：https://mirai.mamoe.net/

Mirai使用经验参考：https://cloud.tencent.com/developer/article/1819302

Dice! 官网：https://v2docs.kokona.tech/zh/latest/CookBook.html#id65

Dice! 论坛：https://forum.kokona.tech/

